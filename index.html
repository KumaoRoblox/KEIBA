<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã¿ã‚“ãªã§ç«¶é¦¬ - ãƒ­ãƒ“ãƒ¼&ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆ3å‘¨åˆ¶ï¼‰</title>
  <style>
    :root{
      --bg:#0f1221; --panel:#171a2e; --text:#e6e7ff; --muted:#9aa0c7; --accent:#6cf; --accent2:#9f6cff; --ok:#6cff80; --warn:#ffd166; --bad:#ff6c9f;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1500px 800px at 20% -10%, rgba(159,108,255,.12), transparent 60%),
      radial-gradient(1200px 900px at 110% 20%, rgba(108,204,255,.10), transparent 60%), var(--bg);
      color:var(--text); font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      display:grid; grid-template-rows:auto 1fr; gap:14px;
    }
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); backdrop-filter: blur(6px);}    
    header h1{margin:0; font-size:18px; letter-spacing:.4px}
    header .tag{font-size:12px; color:var(--muted)}
    main{display:grid; grid-template-columns:minmax(320px,700px) 1fr; gap:14px; padding:0 14px 14px}
    
    /* ãƒ¬ãƒ¼ã‚¹ä¸­ã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º */
    main.racing {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
      height: 100vh;
      padding: 0;
      gap: 0;
      max-width: 100vw;
    }
    main.racing #left {
      display: none;
    }
    main.racing #right {
      height: 100vh;
      width: 100vw;
      border-radius: 0;
      margin: 0;
      padding: 0;
      max-width: none;
    }
    main.racing #canvasWrap {
      height: 100vh;
      width: 100vw;
      border-radius: 0;
      position: relative;
    }
    
    /* ãƒ¬ãƒ¼ã‚¹ä¸­ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« - å³ä¸‹ã«é…ç½® */
    #raceControls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 100;
      backdrop-filter: blur(10px);
      max-width: 150px;
    }
    #raceControls.show {
      display: flex;
    }
    #raceControls button {
      padding: 6px 10px;
      font-size: 11px;
      min-width: 120px;
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      #raceControls {
        bottom: 5px;
        right: 5px;
        padding: 6px;
        gap: 4px;
        max-width: 130px;
      }
      #raceControls button {
        padding: 5px 8px;
        font-size: 10px;
        min-width: 110px;
      }
    }
    @media (max-width:1024px){ 
      main{grid-template-columns:1fr; padding:0 8px 8px} 
    }
    @media (max-width:768px){
      header{padding:6px 8px; font-size:12px}
      header h1{font-size:14px}
      header .tag{font-size:10px}
      main{padding:0 2px 2px; gap:4px; max-height:100vh; overflow-y:auto}
      .pad{padding:6px}
      .grid2{grid-template-columns:1fr; gap:3px}
      .grid3{grid-template-columns:1fr; gap:3px}
      .slider{
        display:flex; 
        flex-direction:column;
        gap:4px; 
        text-align:center;
        min-height:auto;
        padding:8px;
        border:1px solid var(--border);
        border-radius:8px;
        margin-bottom:6px;
        background:rgba(255,255,255,.02);
      }
      .slider > div:first-child{
        font-size:13px; 
        font-weight:500;
        margin-bottom:4px;
        color:var(--text);
      }
      .slider > div:last-child{
        font-size:12px;
        margin-top:4px;
        color:var(--accent);
        font-weight:bold;
      }
      .slider input[type=range]{
        margin:6px 0;
        height:12px;
        cursor:pointer;
      }
      .slider input[type=color]{
        width:60px;
        height:40px;
        border-radius:8px;
        border:2px solid var(--border);
        cursor:pointer;
        margin:4px auto;
      }
      .row{flex-wrap:wrap; gap:3px; font-size:11px}
      .pill{padding:2px 4px; font-size:9px}
      .badge{font-size:9px; padding:1px 3px}
      .help{font-size:9px; line-height:1.3}
      input[type="text"], input[type="number"], button{
        padding:8px 10px; 
        font-size:12px;
        border-radius:6px;
        min-height:44px;
      }
      .card h2{font-size:12px; margin:0 0 6px 0}
      .card h3{font-size:13px; margin:8px 0 6px 0; color:var(--accent)}
      .muted{font-size:10px}
      button{padding:8px 10px; font-size:12px; min-height:44px}
      .footerNote{font-size:9px; padding:0 4px 4px}
      .col{gap:6px}
      
      /* ã‚¹ãƒãƒ›ã§ã®é«˜ã•èª¿æ•´ */
      .card{margin-bottom:4px}
      #left{max-height:none; overflow-y:visible}
      
      /* èª¿æ•´ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¹ãƒãƒ›ã§ç¸¦ç©ã¿ */
      .adjustments-container{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
    }
    @media (min-width:1600px){ main{ grid-template-columns:minmax(700px,800px) 1fr } }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:15px; margin:0 0 10px 0; letter-spacing:.3px; color:#dfe2ff}
    .pad{padding:16px}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    input, select, button{font:inherit; color:inherit}
    input[type="text"], input[type="number"], .readonly{
      width:100%; background:#0e1121; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
      outline:none; transition:.2s border-color, .2s box-shadow;
    }
    input[type="text"]:focus, input[type="number"]:focus{border-color:#6cf; box-shadow:0 0 0 3px rgba(108,204,255,.15)}
    .readonly{opacity:.8}
    button{
      background:linear-gradient(180deg, rgba(108,204,255,.25), rgba(108,204,255,.12));
      border:1px solid rgba(108,204,255,.45); color:#e8f6ff; padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s transform ease, .2s filter;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent; border:1px solid var(--border)}
    button.danger{background:linear-gradient(180deg, rgba(255,108,159,.25), rgba(255,108,159,.12)); border:1px solid rgba(255,108,159,.45)}
    .success{background:linear-gradient(180deg, rgba(108,255,128,.2), rgba(108,255,128,.12)); border:1px solid rgba(108,255,128,.45)}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed var(--border); border-radius:999px; color:var(--muted)}
    .copy{cursor:pointer}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#0c1020; border:1px solid var(--border)}

    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å›ºå®šã§ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    #canvasWrap{
      height:520px; 
      position:relative;
      overflow:hidden;
    }
    @media (max-width:768px){
      #canvasWrap{
        height:300px;
        aspect-ratio: 4/3;
        max-width:100%;
        width:100%;
      }
    }
    @media (max-width:480px){
      #canvasWrap{
        height:250px;
        aspect-ratio: 4/3;
      }
    }
    canvas{
      width:100%; 
      height:100%; 
      background:repeating-linear-gradient(90deg, #111430, #111430 14px, #121535 14px, #121535 28px);
      object-fit:contain;
      max-width:100%;
      max-height:100%;
    }    
    #overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    #overlay .big{font-size:72px; font-weight:700; text-shadow:0 10px 30px rgba(0,0,0,.4)}
    @media (max-width:768px){
      #overlay .big{font-size:48px}
    }
    #results{position:absolute; right:16px; top:16px; background:rgba(0,0,0,.4); border:1px solid var(--border); border-radius:12px; padding:10px; max-width:300px}

    .slider{display:grid; grid-template-columns:140px minmax(200px,1fr) 100px; gap:12px; align-items:center; min-height:44px}
    
    /* PCç‰ˆã§ã®èª¿æ•´ã‚³ãƒ³ãƒ†ãƒŠ */
    .adjustments-container{
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:12px;
    }
    @media (min-width:1200px){
      .adjustments-container{
        grid-template-columns:1fr 1fr;
      }
    }
    @media (max-width:768px){
      .adjustments-container{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
    }
    input[type=range]{
      width:100%; 
      -webkit-appearance:none; 
      appearance:none; 
      height:12px; 
      background:transparent; 
      cursor:pointer;
      touch-action: none; /* ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
    }
    input[type=range]::-webkit-slider-runnable-track{
      height:12px; 
      background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)); 
      border:1px solid var(--border); 
      border-radius:999px;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none; 
      width:28px; 
      height:28px; 
      border-radius:50%; 
      background:#e6e7ff; 
      border:2px solid rgba(108,204,255,.8); 
      margin-top:-8px; 
      box-shadow:0 2px 8px rgba(0,0,0,.35);
      cursor:pointer;
    }
    input[type=range]:disabled::-webkit-slider-thumb{
      background:#9aa0c7; 
      border-color:#9aa0c7;
    }
    input[type=range]::-moz-range-track{
      height:12px; 
      background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)); 
      border:1px solid var(--border); 
      border-radius:999px;
    }
    input[type=range]::-moz-range-thumb{
      width:28px; 
      height:28px; 
      border-radius:50%; 
      background:#e6e7ff; 
      border:2px solid rgba(108,204,255,.8); 
      box-shadow:0 2px 8px rgba(0,0,0,.35);
      cursor:pointer;
    }

    .help{font-size:12px; color:var(--muted)}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .error{color:var(--bad)}
    .footerNote{font-size:12px; color:var(--muted); padding:0 18px 18px}
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes messageSlide {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes messageSlideOut {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @keyframes titleGlow {
      from { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(255,215,0,0.3); }
      to { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255,215,0,0.6); }
    }
    @keyframes slideIn {
      from { transform: translateX(-50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‡ ã¿ã‚“ãªã§ç«¶é¦¬ <span class="tag">ãƒ­ãƒ“ãƒ¼ & ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦ï¼ˆ3å‘¨åˆ¶ï¼‰</span></h1>
    <div id="onlineBadge" class="badge">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ¢ï¼‰</div>
  </header>

  <main>
    <!-- å·¦ï¼šãƒ­ãƒ“ãƒ¼/è¨­å®š -->
    <section class="card pad" id="left">
      <h2>ãƒ­ãƒ“ãƒ¼</h2>
      <div class="col" id="lobbySection">
        <!-- æœ€åˆã¯åå‰å…¥åŠ›ã®ã¿è¡¨ç¤º -->
        <div class="col" id="initialSetup">
          <div class="grid2">
            <div>
              <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
              <input type="text" id="playerName" placeholder="ä¾‹ï¼šãƒ”ã‚«ã‚½" />
            </div>
            <div>
              <label>é¦¬ã®åå‰</label>
              <input type="text" id="horseName" placeholder="ä¾‹ï¼šã‚µãƒ³ãƒ€ãƒ¼" />
            </div>
          </div>
          <div class="row">
            <button id="createLobbyBtn">ï¼‹ ãƒ­ãƒ“ãƒ¼ä½œæˆ</button>
            <div class="row">
              <input type="text" id="joinCode" placeholder="4æ¡ã‚³ãƒ¼ãƒ‰" style="max-width:120px" />
              <button id="joinLobbyBtn" class="secondary">å‚åŠ </button>
            </div>
          </div>
        </div>

        <!-- ãƒ­ãƒ“ãƒ¼å‚åŠ å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹è©³ç´°è¨­å®š -->
        <div class="col" id="detailedSetup" style="display:none">
          <div class="row">
            <div class="pill">å…±æœ‰ã‚³ãƒ¼ãƒ‰: <span id="lobbyCode" class="code">-</span> <span id="copyCode" class="copy">ğŸ“‹</span></div>
            <div class="pill">ã‚ãªãŸ: <span id="whoami">æœªæ¥ç¶š</span></div>
            <div class="pill"><span id="hostBadge">å‚åŠ è€…</span></div>
          </div>

          <div class="col" id="horseAdjustments">
            <h3 style="margin:8px 0 4px 0; font-size:14px">é¦¬ã®èƒ½åŠ›èª¿æ•´</h3>
            <div id="statsPoints" style="text-align:center; font-size:16px; font-weight:bold; color:var(--accent); margin-bottom:8px">
              æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆ: <span id="remainingPoints">100</span> / 100
            </div>
            <div class="adjustments-container">
              <div class="slider">
                <div>æœ€é«˜é€Ÿåº¦</div>
                <input type="range" id="sTop" min="0" max="100" step="1" value="20">
                <div><span id="vTop">20</span> pt</div>
              </div>
              <div class="slider">
                <div>åŠ é€Ÿåº¦</div>
                <input type="range" id="sAcc" min="0" max="100" step="1" value="20">
                <div><span id="vAcc">20</span> pt</div>
              </div>
              <div class="slider">
                <div>ã‚¹ã‚¿ãƒŸãƒŠ</div>
                <input type="range" id="sSta" min="0" max="100" step="1" value="20">
                <div><span id="vSta">20</span> pt</div>
              </div>
              <div class="slider">
                <div>ã‚³ãƒ¼ãƒŠãƒ¼</div>
                <input type="range" id="sCorner" min="0" max="100" step="1" value="20">
                <div><span id="vCorner">20</span> pt</div>
              </div>
              <div class="slider">
                <div>æœ«è„š</div>
                <input type="range" id="sFinish" min="0" max="100" step="1" value="20">
                <div><span id="vFinish">20</span> pt</div>
              </div>
              <div class="slider">
                <div>é¦¬ã®è‰²</div>
                <input type="color" id="horseColor" value="#7dd3fc" />
                <div><span class="colorBox" id="colorBox" style="display:inline-block; width:20px; height:20px; border-radius:4px; border:1px solid var(--border)"></span></div>
              </div>
            </div>

            <div class="row">
              <button id="saveHorseBtn">è¨­å®šã‚’ä¿å­˜ / æ›´æ–°</button>
              <button id="readyBtn" class="success" style="display:none">æº–å‚™OK</button>
              <button id="startBtn" class="danger" style="display:none">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰</button>
            </div>
            <div class="help">
              <div>ãƒ»ãƒ­ãƒ“ãƒ¼ä½œæˆè€…ãŒãƒ›ã‚¹ãƒˆã§ã™ã€‚å‚åŠ è€…ã¯4æ¡ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã§å‚åŠ ã§ãã¾ã™ã€‚</div>
              <div>ãƒ»<b>è¨­å®šã‚’ä¿å­˜ã—ã¦ã‹ã‚‰æº–å‚™OKã‚’æŠ¼ã—ã¦ãã ã•ã„</b>ï¼ˆä¿å­˜å¿…é ˆï¼‰ã€‚</div>
              <div>ãƒ»<b>ãƒ¬ãƒ¼ã‚¹ä¸­ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚„è‰²ã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“</b>ï¼ˆè‡ªå‹•ã§ãƒ­ãƒƒã‚¯ï¼‰ã€‚</div>
              <div>ãƒ»<b>èª°ã‹ãŒé€”ä¸­ã§æŠœã‘ãŸã‚‰è©¦åˆã¯æ”¾æ£„</b>ï¼ˆå…¨å“¡ã«é€šçŸ¥ï¼‰ã€‚</div>
              <div>ãƒ»<b>3å‘¨åˆ¶ãƒ¬ãƒ¼ã‚¹</b>ï¼šã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã‚’3å›é€šéã—ãŸã‚‰ã‚´ãƒ¼ãƒ«ï¼</div>
              <div>ãƒ»<b>ã‚¹ã‚¿ãƒŸãƒŠé‡è¦</b>ï¼š0ã ã¨æ¥µã‚ã¦é…ããªã‚‹ã€‚ãƒšãƒ¼ã‚¹ã‚’è½ã¨ã™ã¨å›å¾©ã™ã‚‹</div>
              <div>ãƒ»<b>æˆ¦ç•¥æ€§</b>ï¼šåºç›¤æŠ‘ãˆã¦å¾ŒåŠå‹è²  vs åºç›¤é£›ã°ã—ã¦é€ƒã’åˆ‡ã‚Š</div>
            </div>
          </div>

          <div class="card pad" style="margin-top:8px">
            <h2>å‚åŠ è€…ä¸€è¦§</h2>
            <div id="playersList" class="col"></div>
          </div>
        </div>

        <details style="display:none">
          <summary>Firebase è¨­å®šã‚’é–‹ã</summary>
          <pre class="code" id="cfgPreview"></pre>
        </details>
      </div>
    </section>

    <!-- å³ï¼šãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
    <section class="card pad" id="right">
      <h2>ãƒ¬ãƒ¼ã‚¹ï¼ˆ3å‘¨åˆ¶ï¼‰</h2>
      <div id="canvasWrap" class="card">
        <canvas id="race"></canvas>
        <div id="overlay"><div class="big" id="countDown"></div></div>
        <div id="results" class="col" style="display:none"></div>
        
        <!-- ãƒ¬ãƒ¼ã‚¹ä¸­ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div id="raceControls">
          <button id="leaveBtn2" class="secondary">ãƒ­ãƒ“ãƒ¼ã‹ã‚‰æŠœã‘ã‚‹</button>
          <button id="resetBtn2" class="secondary">ãƒ¬ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="abortBtn2" class="danger">è©¦åˆã‚’ä¸­æ–­</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px" id="normalControls">
        <button id="leaveBtn" class="secondary">ãƒ­ãƒ“ãƒ¼ã‹ã‚‰æŠœã‘ã‚‹</button>
        <button id="resetBtn" class="secondary">ãƒ¬ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ›ã‚¹ãƒˆï¼‰</button>
        <button id="abortBtn" class="danger" style="display:none">è©¦åˆã‚’ä¸­æ–­ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</button>
      </div>
      <div class="help" style="margin-top:8px">ãƒ¬ãƒ¼ã‚¹ã¯ãƒ›ã‚¹ãƒˆç«¯æœ«ã§è¨ˆç®—ã—ã€ä»–ç«¯æœ«ã¸é…ä¿¡ã—ã¾ã™ã€‚3å‘¨ã—ãŸã‚‰ã‚´ãƒ¼ãƒ«ï¼</div>
    </section>
  </main>

  <div class="footerNote">â€» Firebase ã®è¨­å®šã‚’åŸ‹ã‚ã‚‹ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸãŒæœ‰åŠ¹ã«ãªã‚Šã€èª°ã§ã‚‚ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ã§å‚åŠ ã§ãã¾ã™ã€‚</div>

  <!-- Firebaseï¼ˆä»»æ„ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOqe--KczRP2fFCykd4iH1iaAVpyQTlSE",
    authDomain: "keiba-66344.firebaseapp.com",
    databaseURL: "https://keiba-66344-default-rtdb.firebaseio.com",
    projectId: "keiba-66344",
    storageBucket: "keiba-66344.firebasestorage.app",
    messagingSenderId: "636995719079",
    appId: "1:636995719079:web:dbb09c8860101a4c82b082",
    measurementId: "G-QSPM8PBTTH"
  };

  const el = (id)=>document.getElementById(id);
  const uid = localStorage.getItem('uid') || (()=>{const v=crypto.getRandomValues(new Uint32Array(4)); const s=[...v].map(x=>x.toString(16).padStart(8,'0')).join(''); localStorage.setItem('uid', s); return s;})();

  const state = {
    net:false, app:null, db:null,
    me:{ id:uid, name:"", horse:null, ready:false, saved:false }, // ä¿å­˜çŠ¶æ…‹ã‚’è¿½åŠ 
    lobby:null, lobbyCode:null, isHost:false, players:{},
    started:false, seed:null, results:[],
    ctx:null, canvas:null, dpr:Math.min(2, window.devicePixelRatio||1),
    lanes:[], lastState:null, trackLen:400, // 1å‘¨ã®è·é›¢ï¼ˆ3å‘¨ã§1200mï¼‰
    totalLaps:3, // ç·å‘¨å›æ•°
    racePlayerIds:[],
    abandoned:null,
    emptyLobbyTimeout:null, // ç©ºãƒ­ãƒ“ãƒ¼å‰Šé™¤ç”¨ã‚¿ã‚¤ãƒãƒ¼
    moodUpdatedForAbandoned:false, // ä¸­æ–­æ™‚ã®æ°—åˆ†æ›´æ–°ãƒ•ãƒ©ã‚°
    loading:false // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãƒ•ãƒ©ã‚°
  };

  const $ = {
    code: el('lobbyCode'), who: el('whoami'), hostBadge: el('hostBadge'), onlineBadge: el('onlineBadge'),
    create: el('createLobbyBtn'), joinBtn: el('joinLobbyBtn'), joinCode: el('joinCode'), copy: el('copyCode'),
    pName: el('playerName'), hName: el('horseName'),
    sTop: el('sTop'), sAcc: el('sAcc'), sSta: el('sSta'), sCorner: el('sCorner'), sFinish: el('sFinish'), hColor: el('horseColor'),
    vTop: el('vTop'), vAcc: el('vAcc'), vSta: el('vSta'), vCorner: el('vCorner'), vFinish: el('vFinish'), colorBox: el('colorBox'),
    save: el('saveHorseBtn'), ready: el('readyBtn'), start: el('startBtn'), playersList: el('playersList'),
    canvas: el('race'), overlay: el('overlay'), count: el('countDown'), results: el('results'),
    leave: el('leaveBtn'), reset: el('resetBtn'), abort: el('abortBtn'), cfgPreview: el('cfgPreview'),
    remainingPoints: el('remainingPoints')
  };

  function syncLabels(){
    $.vTop.textContent = (+$.sTop.value).toFixed(0);
    $.vAcc.textContent = (+$.sAcc.value).toFixed(0);
    $.vSta.textContent = (+$.sSta.value).toFixed(0);
    $.vCorner.textContent = (+$.sCorner.value).toFixed(0);
    $.vFinish.textContent = (+$.sFinish.value).toFixed(0);
    $.colorBox.style.background = $.hColor.value;
    
    // æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
    const totalUsed = (+$.sTop.value) + (+$.sAcc.value) + (+$.sSta.value) + (+$.sCorner.value) + (+$.sFinish.value);
    const remaining = 100 - totalUsed;
    
    if($.remainingPoints) {
      $.remainingPoints.textContent = remaining;
      $.remainingPoints.style.color = remaining < 0 ? 'var(--bad)' : remaining === 0 ? 'var(--ok)' : 'var(--accent)';
    }
    
    // ãƒã‚¤ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ã¾ãŸã¯æœªä½¿ç”¨ã®å ´åˆã¯ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if($.save) {
      $.save.disabled = remaining !== 0 || state.started;
      $.save.style.opacity = remaining !== 0 ? '0.5' : '1';
    }
    
    // è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ä¿å­˜çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ‰‹å‹•å¤‰æ›´æ™‚ã®ã¿ï¼‰
    if(!state.loading) { // loadingä¸­ã¯ä¿å­˜çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ãªã„
      state.me.saved = false;
      updateReadyButtonState();
    }
  }
  
  // æº–å‚™ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
  function updateReadyButtonState() {
    if($.ready) {
      const canReady = state.me.saved && !state.started;
      $.ready.disabled = !canReady;
      $.ready.style.opacity = canReady ? '1' : '0.5';
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
      console.log('Ready button state:', { 
        saved: state.me.saved, 
        started: state.started, 
        canReady: canReady,
        readyDisabled: $.ready.disabled 
      });
    }
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å€‹åˆ¥ã«è¨­å®š
  [$.sTop, $.sAcc, $.sSta, $.sCorner, $.sFinish, $.hColor].forEach(slider => {
    if(slider) {
      slider.addEventListener('input', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æ‰‹å‹•å¤‰æ›´ã®å ´åˆã®ã¿ä¿å­˜çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        if(!state.loading) {
          console.log('User changed settings, resetting saved state');
          state.me.saved = false;
        }
        
        syncLabels();
        if(state.me.ready) setReady(false);
      });
      
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‡¦ç†
      slider.addEventListener('touchmove', (e) => {
        e.stopPropagation();
      });
      
      slider.addEventListener('touchstart', (e) => {
        e.stopPropagation();
      });
    }
  });
  
  syncLabels();

  function initFirebase(){
    if(typeof window.firebase==='undefined'){ $.onlineBadge.textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆSDKæœªèª­è¾¼ï¼‰'; return; }
    if(!firebaseConfig || !firebaseConfig.apiKey){ $.onlineBadge.textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ¢ï¼‰'; return; }
    try{
      state.app=firebase.initializeApp(firebaseConfig);
      state.db=firebase.database();
      state.net=true;
      firebase.auth().signInAnonymously().catch(console.error);
      $.onlineBadge.textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æœ‰åŠ¹ï¼ˆFirebaseï¼‰';
    }catch(e){ console.error(e); $.onlineBadge.textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼‰'; }
  }
  initFirebase();

  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const randSeeded=(seed)=>{ let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return s/0x100000000; } };
  const R=(path)=> state.db?state.db.ref(path):null;

  function makeCode(){ return String(Math.floor(Math.random()*10000)).padStart(4,'0'); }

  const COLOR_PALETTE=['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6','#e67e22','#1abc9c','#e84393','#d35400','#27ae60','#2980b9','#8e44ad','#16a085','#2c3e50'];
  function uniqueColor(desired, excludeSelf=true){
    const used=new Set(Object.entries(state.players||{})
      .filter(([id])=>!excludeSelf||id!==uid)
      .map(([,p])=>p&&p.horse&&p.horse.color)
      .filter(Boolean));
    if(desired && !used.has(desired)) return desired;
    for(const c of COLOR_PALETTE){ if(!used.has(c)) return c; }
    for(let i=0;i<360;i+=27){ const c=`hsl(${(i+Math.floor(Math.random()*27))%360} 70% 60%)`; if(!used.has(c)) return c; }
    return '#7dd3fc';
  }

  function buildLanesFromPlayers(){
    const lanes=[]; Object.entries(state.players||{}).forEach(([id,p])=>{ lanes.push({id, color:(p&&p.horse&&p.horse.color)||'#7dd3fc'}); });
    state.lanes=lanes;
  }

  function updateHeader(){ el('hostBadge').textContent = state.isHost? 'ãƒ›ã‚¹ãƒˆ' : 'å‚åŠ è€…'; }

  function updateRoleUI(){
    const host = state.isHost;
    const joined = !!state.lobbyCode && (!!(state.players && state.players[uid]) || state.isHost);
    
    // åˆæœŸç”»é¢ã¨è©³ç´°è¨­å®šç”»é¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    const initialSetup = document.getElementById('initialSetup');
    const detailedSetup = document.getElementById('detailedSetup');
    
    if(joined) {
      if(initialSetup) initialSetup.style.display = 'none';
      if(detailedSetup) detailedSetup.style.display = 'block';
    } else {
      if(initialSetup) initialSetup.style.display = 'block';
      if(detailedSetup) detailedSetup.style.display = 'none';
    }
    
    if($.ready) $.ready.style.display = joined ? '' : 'none';
    applyLockState();
    updateButtonsState();
    updateStartVisibility();
  }

  function applyLockState(){
    const trackEditable = state.isHost && !state.started;
    [$.sTop,$.sAcc,$.sSta,$.sLuck,$.hColor,$.save].forEach(e=>{ if(e) e.disabled = !!state.started; });
  }

  function updateButtonsState(){
    const disableAll = state.started;
    const btns = [ $.create,$.joinBtn,$.save,$.ready,$.start,$.leave,$.reset ];
    btns.forEach(b=>{ if(!b) return; b.disabled = !!disableAll; });
    const showAbort = state.isHost && state.started && !state.abandoned;
    if($.abort){ $.abort.style.display = showAbort ? 'inline-block' : 'none'; $.abort.disabled = !showAbort; }
    
    // ãƒ¬ãƒ¼ã‚¹ä¸­ã®UIã®åˆ‡ã‚Šæ›¿ãˆ
    const main = document.querySelector('main');
    const raceControls = document.getElementById('raceControls');
    const normalControls = document.getElementById('normalControls');
    
    if(state.started && !state.abandoned) {
      // ãƒ¬ãƒ¼ã‚¹ä¸­ï¼šãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º
      main.classList.add('racing');
      if(raceControls) raceControls.classList.add('show');
      if(normalControls) normalControls.style.display = 'none';
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å†èª¿æ•´
      setTimeout(() => setupCanvas(), 100);
      
      // ãƒ¬ãƒ¼ã‚¹ä¸­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®š
      const leave2 = document.getElementById('leaveBtn2');
      const reset2 = document.getElementById('resetBtn2');
      const abort2 = document.getElementById('abortBtn2');
      
      if(leave2) leave2.disabled = false;
      if(reset2) { reset2.style.display = state.isHost ? 'block' : 'none'; reset2.disabled = false; }
      if(abort2) { abort2.style.display = state.isHost ? 'block' : 'none'; abort2.disabled = false; }
    } else {
      // é€šå¸¸æ™‚ï¼šé€šå¸¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
      main.classList.remove('racing');
      if(raceControls) raceControls.classList.remove('show');
      if(normalControls) normalControls.style.display = 'flex';
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å†èª¿æ•´
      setTimeout(() => setupCanvas(), 100);
    }
  }

  function renderPlayers(){
    $.playersList.innerHTML='';
    const keys=Object.keys(state.players||{});
    if(keys.length===0){ $.playersList.innerHTML='<div class="muted">ï¼ˆã¾ã å‚åŠ è€…ã¯ã„ã¾ã›ã‚“ï¼‰</div>'; return; }
    keys.forEach(id=>{
      const p=state.players[id]; if(!p) return;
      const div=document.createElement('div'); div.className='row'; div.style.justifyContent='space-between';
      const status=p.ready?'<span class="badge" style="border-color:#6cff80">READY</span>':'<span class="badge" style="border-color:#ffd166">å¾…æ©Ÿ</span>';
      const moodInfo = p.horse?.mood ? `<span class="badge" style="border-color:${p.horse.mood.color}">${p.horse.mood.emoji} ${p.horse.mood.name}</span>` : '';
      
      // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
      const pointsInfo = p.horse?.points ? 
        `S${p.horse.points.speed} A${p.horse.points.accel} T${p.horse.points.stamina} C${p.horse.points.corner} F${p.horse.points.finish}` :
        `V${p.horse&&p.horse.topSpeed||'?'} A${p.horse&&p.horse.accel||'?'} S${p.horse&&p.horse.stamina||'?'} C${p.horse&&p.horse.corner||'?'} F${p.horse&&p.horse.finish||'?'}`;
      
      div.innerHTML=`<div><b>${p.name||'åç„¡ã—'}</b> <span class="muted">/ ${p.horse&&p.horse.name||'é¦¬'}</span></div>
        <div class="row">${status} ${moodInfo} <span class="badge" style="border-color:${p.horse&&p.horse.color||'#888'}">${p.horse&&p.horse.color||'#888'}</span>
        <span class="muted">${pointsInfo}</span></div>`;
      $.playersList.appendChild(div);
    });
  }

  function renderResults(){
    const res=state.results||[];
    if(!res.length){ $.results.style.display='none'; $.results.innerHTML=''; return; }
    $.results.style.display='block';
    $.results.innerHTML='<b>çµæœ</b>'+ res.map(r=>`<div class="row" style="justify-content:space-between"><span>${r.rank}. <b>${r.player}</b> <span class="muted">/ ${r.horse}</span></span> <span class="badge" style="border-color:${r.color}">${r.color}</span></div>`).join('');
  }

  function everyoneReady(){ 
    const ps = state.players || {}; 
    const ids = Object.keys(ps); 
    if(!ids.length) return false; 
    
    // å…¨å“¡ãŒæº–å‚™å®Œäº†ã‹ã¤ã€å…¨å“¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æŒ¯ã‚ŠãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    return ids.every(id => {
      const player = ps[id];
      if(!player || !player.ready) return false;
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
      if(player.horse && player.horse.points) {
        const totalPoints = player.horse.points.speed + player.horse.points.accel + 
                           player.horse.points.stamina + player.horse.points.corner + 
                           player.horse.points.finish;
        return totalPoints === 100;
      }
      return true; // å¤ã„å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾é€šã™
    });
  }
  function updateStartVisibility(){ const show=state.isHost && everyoneReady() && !state.started && !state.abandoned; $.start.style.display=show? 'inline-block':'none'; }
  function updateReadyButton(){ 
    $.ready.textContent=state.me.ready? 'æº–å‚™è§£é™¤':'æº–å‚™OK'; 
    $.ready.className=state.me.ready? 'secondary':'success';
    updateReadyButtonState(); // ä¿å­˜çŠ¶æ…‹ã‚‚ãƒã‚§ãƒƒã‚¯
  }

  function generateRandomMood() {
    const moods = [
      { name: 'çµ¶å¥½èª¿', emoji: 'ğŸ˜¤', multiplier: 1.2, color: '#ff6b6b' },
      { name: 'å¥½èª¿', emoji: 'ğŸ˜Š', multiplier: 1.1, color: '#4ecdc4' },
      { name: 'æ™®é€š', emoji: 'ğŸ˜', multiplier: 1.0, color: '#95a5a6' },
      { name: 'ä¸èª¿', emoji: 'ğŸ˜”', multiplier: 0.9, color: '#f39c12' },
      { name: 'çµ¶ä¸èª¿', emoji: 'ğŸ˜©', multiplier: 0.8, color: '#9b59b6' }
    ];
    return moods[Math.floor(Math.random() * moods.length)];
  }

  function collectHorse(newMood = false){ 
    // æ–°ã—ã„æ°—åˆ†ãŒå¿…è¦ãªå ´åˆã€ã¾ãŸã¯æ—¢å­˜ã®æ°—åˆ†ãŒãªã„å ´åˆã®ã¿ç”Ÿæˆ
    let mood;
    if(newMood || !state.me.horse?.mood) {
      mood = generateRandomMood();
    } else {
      mood = state.me.horse.mood; // æ—¢å­˜ã®æ°—åˆ†ã‚’ä¿æŒ
    }
    
    // ãƒãƒ©ãƒ³ã‚¹èª¿æ•´æ¸ˆã¿ã®èƒ½åŠ›å€¤å¤‰æ›
    // æœ€é«˜é€Ÿåº¦: åŸºç¤å€¤ã‚’ä¸‹ã’ã€ä¸Šé™ã‚‚æŠ‘åˆ¶
    const topSpeedBase = 12 + (+$.sTop.value) * 0.15; // 12-27 m/s (ä»¥å‰: 8-33)
    
    // åŠ é€Ÿåº¦: ã‚ˆã‚Šé‡è¦åº¦ã‚’ä¸Šã’ã€åŠ¹æœã‚’æ˜ç¢ºã«
    const accelBase = 1.5 + (+$.sAcc.value) * 0.08; // 1.5-9.5 m/sÂ² (ä»¥å‰: 0.8-6.8)
    
    // ã‚¹ã‚¿ãƒŸãƒŠ: ã‚ˆã‚ŠåŠ¹æœçš„ã«ã€å¾ŒåŠã¸ã®å½±éŸ¿ã‚’å¼·åŒ–
    const staminaBase = 200 + (+$.sSta.value) * 50; // 200-5200 (ä»¥å‰: 100-4100)
    
    // ã‚³ãƒ¼ãƒŠãƒ¼: åŠ¹æœã‚’ã‚ˆã‚Šæ˜ç¢ºã«
    const cornerBase = 1.0 + (+$.sCorner.value) * 0.06; // 1.0-7.0 (ä»¥å‰: 0.5-5.5)
    
    // æœ«è„š: æœ€çµ‚å±€é¢ã§ã®é‡è¦æ€§ã‚’å‘ä¸Š
    const finishBase = 1.0 + (+$.sFinish.value) * 0.08; // 1.0-9.0 (ä»¥å‰: 0.5-5.5)
    
    return { 
      name: $.hName.value.trim()||'ãƒãƒ¼ãƒãƒ«', 
      color: $.hColor.value, 
      topSpeed: +(topSpeedBase).toFixed(2), 
      accel: +(accelBase).toFixed(2), 
      stamina: +(staminaBase).toFixed(0), 
      corner: +(cornerBase).toFixed(2),
      finish: +(finishBase).toFixed(2),
      mood: mood,
      // ãƒã‚¤ãƒ³ãƒˆå€¤ã‚‚ä¿å­˜
      points: {
        speed: +$.sTop.value,
        accel: +$.sAcc.value,
        stamina: +$.sSta.value,
        corner: +$.sCorner.value,
        finish: +$.sFinish.value
      }
    }; 
  }

  function ensurePresence(){
    if(!state.net || !state.lobbyCode) return;
    try{
      const pref=R('lobbies/'+state.lobbyCode+'/players/'+uid);
      pref && pref.onDisconnect().remove();
      if(state.isHost){
        const lref=R('lobbies/'+state.lobbyCode);
        lref && lref.child('started').onDisconnect().set(false);
        lref && lref.child('abandoned').onDisconnect().set({ at: Date.now(), reason:'host_disconnected' });
        R('lobbies/'+state.lobbyCode+'/state').onDisconnect().remove();
        R('lobbies/'+state.lobbyCode+'/results').onDisconnect().remove();
      }
    }catch(e){ console.warn('presence onDisconnect set failed', e); }
  }

  async function upsertMe(newMood = false){
    if(state.started){ ensurePresence(); return; }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
    state.loading = true;
    
    const name=$.pName.value.trim()||`Player-${uid.slice(0,4).toUpperCase()}`;
    let horse=collectHorse(newMood); // æ–°ã—ã„æ°—åˆ†ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
    
    // ä»–ã®é¦¬ã¨è¢«ã‚‰ãªã„è‰²ã‚’å–å¾—ï¼ˆå‚åŠ æ™‚ã‚‚é©ç”¨ï¼‰
    horse.color=uniqueColor(horse.color,true);
    $.hColor.value=horse.color; 
    $.colorBox.style.background=horse.color;
    
    state.me.name=name; 
    state.me.horse=horse; 
    $.who.textContent=name;
    
    // ä¿å­˜çŠ¶æ…‹ã‚’æ›´æ–°
    state.me.saved = true;
    console.log('Settings saved, state.me.saved:', state.me.saved);
    
    if(state.net && state.lobbyCode){
      await R('lobbies/'+state.lobbyCode+'/players/'+uid).set({ name, horse, updatedAt:Date.now(), ready:state.me.ready||false });
      ensurePresence();
    } else {
      state.players[uid]={ name, horse, ready:state.me.ready||false };
      renderPlayers(); buildLanesFromPlayers(); updateStartVisibility();
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
    state.loading = false;
    
    // UIæ›´æ–°
    updateReadyButtonState();
    
    // è¨­å®šä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆnewMoodãŒfalseã®å ´åˆã®ã¿ï¼‰
    if(!newMood) {
      showMessage('è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ©Ÿèƒ½
  function showMessage(text, type = 'info') {
    // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
    const existingMessage = document.getElementById('gameMessage');
    if(existingMessage) {
      existingMessage.remove();
    }
    
    const message = document.createElement('div');
    message.id = 'gameMessage';
    message.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      z-index: 1000;
      animation: messageSlide 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    if(type === 'success') {
      message.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
      message.style.color = 'white';
      message.style.border = '2px solid #45a049';
    } else if(type === 'info') {
      message.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
      message.style.color = 'white';
      message.style.border = '2px solid #1976D2';
    }
    
    message.textContent = text;
    document.body.appendChild(message);
    
    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      if(message && message.parentNode) {
        message.style.animation = 'messageSlideOut 0.3s ease-in';
        setTimeout(() => message.remove(), 300);
      }
    }, 3000);
  }

  // å‡ºé¦¬è¡¨è¡¨ç¤ºæ©Ÿèƒ½
  async function showStartingLineup() {
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
    const overlay = document.createElement('div');
    overlay.id = 'startingLineupOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.5s ease-out;
    `;
    
    // ã‚¿ã‚¤ãƒˆãƒ«
    const title = document.createElement('div');
    title.style.cssText = `
      font-size: 48px;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 40px;
      text-align: center;
      animation: titleGlow 2s ease-in-out infinite alternate;
    `;
    title.textContent = 'ğŸ ä»Šå›ã®å‡ºèµ°é¦¬ãŸã¡ï¼ ğŸ';
    
    // é¦¬ã®ãƒªã‚¹ãƒˆ
    const horseList = document.createElement('div');
    horseList.style.cssText = `
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      width: 90%;
    `;
    
    // å„é¦¬ã®æƒ…å ±ã‚’è¡¨ç¤º
    Object.entries(state.players || {}).forEach(([id, player], index) => {
      const horseCard = document.createElement('div');
      horseCard.style.cssText = `
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border: 2px solid ${player.horse?.color || '#7dd3fc'};
        border-radius: 15px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        animation: slideIn 0.5s ease-out ${index * 0.2}s both;
        backdrop-filter: blur(10px);
      `;
      
      // é¦¬ã®è‰²è¡¨ç¤º
      const colorBox = document.createElement('div');
      colorBox.style.cssText = `
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: ${player.horse?.color || '#7dd3fc'};
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      `;
      
      // ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
      const textInfo = document.createElement('div');
      textInfo.style.cssText = `
        flex: 1;
        color: white;
      `;
      
      const playerName = document.createElement('div');
      playerName.style.cssText = `
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      `;
      playerName.textContent = player.name || 'è¬ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
      
      const horseName = document.createElement('div');
      horseName.style.cssText = `
        font-size: 18px;
        color: #FFD700;
        margin-bottom: 8px;
      `;
      horseName.textContent = `ğŸ ${player.horse?.name || 'åç„¡ã—'}`;
      
      textInfo.appendChild(playerName);
      textInfo.appendChild(horseName);
      
      // æ°—åˆ†è¡¨ç¤º
      if(player.horse?.mood) {
        const moodInfo = document.createElement('div');
        moodInfo.style.cssText = `
          font-size: 16px;
          color: ${player.horse.mood.color};
        `;
        moodInfo.textContent = `${player.horse.mood.emoji} ${player.horse.mood.name}`;
        textInfo.appendChild(moodInfo);
      }
      
      horseCard.appendChild(colorBox);
      horseCard.appendChild(textInfo);
      horseList.appendChild(horseCard);
    });
    
    overlay.appendChild(title);
    overlay.appendChild(horseList);
    document.body.appendChild(overlay);
    
    // 3ç§’å¾Œã«å‰Šé™¤
    await sleep(3000);
    
    overlay.style.animation = 'fadeOut 0.5s ease-in';
    setTimeout(() => {
      if(overlay && overlay.parentNode) {
        overlay.remove();
      }
    }, 500);
  }

  async function setReady(val){ 
    if(!state.me.saved && val) {
      showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¦ã‹ã‚‰æº–å‚™OKã‚’æŠ¼ã—ã¦ãã ã•ã„', 'info');
      return;
    }
    state.me.ready=!!val; 
    updateReadyButton(); 
    if(state.net && state.lobbyCode){ 
      await R('lobbies/'+state.lobbyCode+'/players/'+uid).update({ ready:state.me.ready, updatedAt:Date.now() }); 
    } 
    renderPlayers(); 
    updateStartVisibility(); 
  }

  async function createLobby(){
    const code=makeCode(); 
    state.lobbyCode=code; 
    state.isHost=true; 
    updateHeader();
    
    if(state.net){ 
      await R('lobbies/'+code).set({ 
        createdAt:Date.now(), 
        hostId:uid, 
        started:false, 
        abandoned:null, 
        trackLen: state.trackLen,
        totalLaps: state.totalLaps,
        seed:0 
      }); 
      subscribeLobby(code); 
    }
    
    $.code.textContent=code; 
    history.replaceState(null,'', location.pathname+`?room=${code}`);
    
    // ãƒ­ãƒ“ãƒ¼ä½œæˆæ™‚ã«è‡ªå‹•ä¿å­˜ï¼ˆä»–ã®é¦¬ã¨è¢«ã‚‰ãªã„è‰²ã§ï¼‰
    await upsertMe(true); // æ–°ã—ã„æ°—åˆ†ã‚’ç”Ÿæˆã—ã¦è‡ªå‹•ä¿å­˜
    ensurePresence(); 
    updateRoleUI();
  }

  async function joinLobby(code){ 
    state.lobbyCode=code; 
    state.isHost=false; 
    updateHeader(); 
    
    if(state.net){ 
      subscribeLobby(code); 
      ensurePresence(); 
      await sleep(100); // å°‘ã—é•·ã‚ã«å¾…æ©Ÿã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å–å¾—
      
      // å‚åŠ æ™‚ã«ä»–ã®é¦¬ã¨è¢«ã‚‰ãªã„è‰²ã§è‡ªå‹•ä¿å­˜
      await upsertMe(true); // æ–°ã—ã„æ°—åˆ†ã‚’ç”Ÿæˆã—ã¦è‡ªå‹•ä¿å­˜
    } 
    
    $.code.textContent=code; 
    history.replaceState(null,'', location.pathname+`?room=${code}`); 
    updateRoleUI(); 
  }

  async function abandonRace(reason){ if(!state.net || !state.lobbyCode) return; await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:{ at:Date.now(), reason } }); await R('lobbies/'+state.lobbyCode+'/state').remove(); await R('lobbies/'+state.lobbyCode+'/results').remove(); }

  async function abortToLobby(){
    if(!(state.isHost && state.started)) return;
    
    console.log('=== ABORT TO LOBBY START ===');
    console.log('Before abort - me.ready:', state.me.ready, 'me.saved:', state.me.saved);
    
    if(state.net && state.lobbyCode){
      console.log('Updating Firebase lobby state...');
      
      // ãƒ­ãƒ“ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      await R('lobbies/'+state.lobbyCode).update({ 
        started: false, 
        abandoned: null 
      });
      await R('lobbies/'+state.lobbyCode+'/state').remove();
      
      console.log('Resetting all players ready state...');
      
      // å…¨å“¡ã®æº–å‚™çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆï¼ˆå€‹åˆ¥ã«æ›´æ–°ï¼‰
      const playerIds = Object.keys(state.players);
      for(const playerId of playerIds) {
        await R(`lobbies/${state.lobbyCode}/players/${playerId}`).update({
          ready: false,
          updatedAt: Date.now()
        });
        console.log(`Reset ready state for player: ${playerId}`);
      }
      
      console.log('Firebase updates completed');
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
    state.started = false; 
    state.abandoned = null; 
    state.results = []; 
    state.lastState = null;
    
    // è‡ªåˆ†ã®æº–å‚™çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ & æ–°ã—ã„æ°—åˆ†ã‚’ç”Ÿæˆ
    state.me.ready = false;
    state.me.saved = false; // ä¿å­˜çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
    
    console.log('After local reset - me.ready:', state.me.ready, 'me.saved:', state.me.saved);
    
    // UIæ›´æ–°
    updateReadyButton();
    updateReadyButtonState();
    
    // æ–°ã—ã„æ°—åˆ†ã§å†ä¿å­˜
    await upsertMe(true); // æ–°ã—ã„æ°—åˆ†ã‚’ç”Ÿæˆ
    
    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
    sim.reset(); 
    if(state.ctx) drawRace();
    
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
    applyLockState(); 
    updateButtonsState(); 
    updateStartVisibility();
    
    console.log('Final state - me.ready:', state.me.ready, 'me.saved:', state.me.saved);
    console.log('=== ABORT TO LOBBY END ===');
  }

  function subscribeLobby(code){ 
    if(!state.net) return;
    
    R('lobbies/'+code).on('value', snap=>{
      const v=snap.val()||{};
      
      // ãƒ­ãƒ“ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆå‰Šé™¤ã•ã‚ŒãŸå ´åˆï¼‰
      if(!v || Object.keys(v).length === 0) {
        console.log('Lobby does not exist or was deleted, resetting state');
        resetLobbyState();
        return;
      }
      
      // ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã®å¤‰åŒ–ã‚’æ¤œå‡º
      const wasStarted = state.started;
      const isStarted = !!v.started;
      
      state.lobby=v; 
      state.started=isStarted; 
      state.seed=v.seed||0; 
      state.trackLen=v.trackLen||400; 
      state.totalLaps=v.totalLaps||3;
      state.abandoned=v.abandoned||null;
      
      // å‚åŠ è€…å´ã§ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æ¤œå‡ºã—ãŸå ´åˆ
      if(!state.isHost && !wasStarted && isStarted) {
        console.log('Game started detected by participant, starting race...');
        sim.start();
      }
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã§è¨­å®šã‚’æ›´æ–°
      state.loading = true;
      syncLabels(); 
      state.loading = false;
      
      applyLockState(); 
      updateButtonsState();
      if(state.abandoned){ 
        $.count.textContent='è©¦åˆæ”¾æ£„'; 
      } else if(!state.started){ 
        $.count.textContent=''; 
      }
      updateStartVisibility();
    });
    
    R('lobbies/'+code+'/players').on('value', snap=>{
      const players = snap.val()||{};
      const oldPlayers = state.players || {};
      
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ
      if(Object.keys(players).length === 0) {
        console.log('No players in lobby, scheduling cleanup');
        checkAndCleanupLobby(code, players);
        return;
      }
      
      state.players = players; 
      
      // è‡ªåˆ†ãŒãƒ­ãƒ“ãƒ¼ã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
      if(!players[uid] && oldPlayers[uid]) {
        console.log('Player was removed from lobby, resetting state');
        resetLobbyState();
        return;
      }
      
      // Firebaseä¸Šã§è‡ªåˆ†ã®æº–å‚™çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚åŒæœŸ
      if(players[uid] && state.me.ready !== players[uid].ready) {
        console.log('Syncing ready state from Firebase:', players[uid].ready);
        state.me.ready = players[uid].ready;
        updateReadyButton();
      }
      
      // æ–°ã—ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‚åŠ ã—ãŸå ´åˆã€è‰²ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
      const newPlayerIds = Object.keys(players).filter(id => !oldPlayers[id]);
      if(newPlayerIds.length > 0 && newPlayerIds.includes(uid)) {
        // è‡ªåˆ†ãŒæ–°è¦å‚åŠ è€…ã®å ´åˆã€è‰²ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿®æ­£
        setTimeout(() => {
          const currentColor = $.hColor.value;
          const newColor = uniqueColor(currentColor, true);
          if(currentColor !== newColor) {
            state.loading = true; // è‰²å¤‰æ›´ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã§è¡Œã†
            $.hColor.value = newColor;
            $.colorBox.style.background = newColor;
            state.loading = false;
            // è‰²ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯è‡ªå‹•ã§å†ä¿å­˜
            upsertMe(false);
          }
        }, 100);
      }
      
      renderPlayers(); 
      buildLanesFromPlayers(); 
      updateRoleUI(); 
      updateStartVisibility();
      
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•å‰Šé™¤å‡¦ç†
      checkAndCleanupLobby(code, players);
      
      if(state.isHost && state.started && state.racePlayerIds.length){
        const nowIds=new Set(Object.keys(players));
        for(const pid of state.racePlayerIds){ 
          if(!nowIds.has(pid)){ 
            abandonRace('player_left'); 
            break; 
          } 
        }
      }
    });
    
    R('lobbies/'+code+'/state').on('value', snap=>{ 
      state.lastState=snap.val()||null; 
    });
    
    R('lobbies/'+code+'/results').on('value', snap=>{ 
      state.results=snap.val()||[]; 
      renderResults(); 
    });
  }

  // ãƒ­ãƒ“ãƒ¼è‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ï¼ˆå®Œå…¨ç‰ˆï¼‰
  function checkAndCleanupLobby(code, players) {
    if(!state.net || !code) return;
    
    const playerCount = Object.keys(players).length;
    console.log(`Checking lobby ${code}, player count: ${playerCount}`);
    
    if(playerCount === 0) {
      // èª°ã‚‚ã„ãªã„å ´åˆã€5ç§’å¾Œã«å‰Šé™¤äºˆç´„ï¼ˆã•ã‚‰ã«çŸ­ç¸®ï¼‰
      if(!state.emptyLobbyTimeout) {
        console.log(`Lobby ${code} is empty, scheduling deletion in 5 seconds`);
        state.emptyLobbyTimeout = setTimeout(async () => {
          try {
            console.log(`Attempting to delete empty lobby ${code}`);
            
            // ãƒ­ãƒ“ãƒ¼å…¨ä½“ã‚’å¼·åˆ¶å‰Šé™¤
            await R('lobbies/'+code).remove();
            console.log(`Empty lobby ${code} has been deleted successfully`);
            
            // è‡ªåˆ†ãŒãã®ãƒ­ãƒ“ãƒ¼ã«ã„ãŸå ´åˆã¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if(state.lobbyCode === code) {
              console.log('Resetting own state due to lobby deletion');
              await resetLobbyState();
            }
          } catch(e) {
            console.error('Failed to cleanup empty lobby:', e);
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ãƒªãƒˆãƒ©ã‚¤
            setTimeout(() => {
              if(state.lobbyCode === code) {
                checkAndCleanupLobby(code, {});
              }
            }, 5000);
          }
          state.emptyLobbyTimeout = null;
        }, 5000); // 5ç§’ã«çŸ­ç¸®
      }
    } else {
      // èª°ã‹ãŒã„ã‚‹å ´åˆã€å‰Šé™¤äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      if(state.emptyLobbyTimeout) {
        console.log(`Lobby ${code} has players, deletion cancelled`);
        clearTimeout(state.emptyLobbyTimeout);
        state.emptyLobbyTimeout = null;
      }
    }
  }

  // ãƒ­ãƒ“ãƒ¼çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆï¼ˆå¼·åŒ–ç‰ˆï¼‰
  async function resetLobbyState() {
    console.log('Resetting lobby state completely');
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if(state.emptyLobbyTimeout) {
      clearTimeout(state.emptyLobbyTimeout);
      state.emptyLobbyTimeout = null;
    }
    
    // çŠ¶æ…‹ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    state.lobbyCode = null;
    state.isHost = false;
    state.players = {};
    state.started = false;
    state.results = [];
    state.abandoned = null;
    state.me.ready = false;
    state.me.saved = false;
    
    // UIæ›´æ–°
    $.code.textContent = '-';
    $.who.textContent = 'æœªæ¥ç¶š';
    $.count.textContent = '';
    
    renderPlayers();
    buildLanesFromPlayers();
    renderResults();
    updateStartVisibility();
    updateRoleUI();
    updateReadyButton();
    updateReadyButtonState();
    
    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
    sim.reset();
    if(state.ctx) drawRace();
    
    // URLã‚‚æ›´æ–°
    history.replaceState(null, '', location.pathname);
    
    console.log('Lobby state reset completed');
  }

  async function leaveLobby(){ 
    console.log('=== LEAVING LOBBY ===');
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if(state.emptyLobbyTimeout) {
      clearTimeout(state.emptyLobbyTimeout);
      state.emptyLobbyTimeout = null;
    }
    
    const currentLobbyCode = state.lobbyCode;
    
    if(state.net && currentLobbyCode){ 
      console.log('Removing player from Firebase...');
      await R('lobbies/'+currentLobbyCode+'/players/'+uid).remove(); 
      
      if(state.isHost && state.started){ 
        console.log('Host leaving during race, abandoning...');
        await abandonRace('host_left'); 
      } 
      
      // é›¢è„±å¾Œã«å³åº§ã«ãƒ­ãƒ“ãƒ¼ã®å‰Šé™¤ãƒã‚§ãƒƒã‚¯
      setTimeout(async () => {
        try {
          const snapshot = await R('lobbies/'+currentLobbyCode+'/players').once('value');
          const remainingPlayers = snapshot.val() || {};
          const playerCount = Object.keys(remainingPlayers).length;
          
          console.log(`After leaving, lobby ${currentLobbyCode} has ${playerCount} players`);
          
          if(playerCount === 0) {
            console.log('No players remaining, deleting lobby immediately');
            await R('lobbies/'+currentLobbyCode).remove();
            console.log(`Lobby ${currentLobbyCode} deleted successfully`);
          }
        } catch(e) {
          console.error('Error checking lobby after leaving:', e);
        }
      }, 1000);
    } 
    
    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    await resetLobbyState();
    console.log('=== LOBBY LEFT ===');
  }

  const sim = {
    running:false, horses:{}, order:[],
    reset(){ 
      this.horses={}; 
      this.order=[]; 
      this.running=false; 
      $.results.style.display='none'; 
      $.count.textContent=''; 
    },
    setupFromPlayers(){ 
      const lanes=[]; 
      Object.entries(state.players||{}).forEach(([id,p])=>{ 
        const h=p.horse||{}; 
        const maxStamina = Math.max(200, h.stamina||400);
        this.horses[id]={ 
          id, 
          name:p.name||id.slice(0,4), 
          horse:h, 
          x: 0, // åˆæœŸå€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®š
          v: 0, // åˆæœŸå€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®š
          s: maxStamina, // ã‚¹ã‚¿ãƒŸãƒŠã¯æœ€å¤§å€¤ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
          maxS: maxStamina, // æœ€å¤§ã‚¹ã‚¿ãƒŸãƒŠã‚’è¨˜éŒ²
          done: false,
          laps: 0, // åˆæœŸå€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®š
          totalDistance: 0 // åˆæœŸå€¤ã‚’æ˜ç¤ºçš„ã«è¨­å®š
        }; 
        lanes.push({id, color:h.color||'#fff'}); 
      }); 
      state.lanes=lanes; 
    },
    async start(){ 
      this.reset(); 
      this.setupFromPlayers(); 
      state.started=true; 
      state.abandoned=null; 
      
      if(state.isHost){ 
        state.seed=Math.floor(Math.random()*1e9); 
        state.racePlayerIds=Object.keys(state.players||{}); 
        
        if(state.net){ 
          await R('lobbies/'+state.lobbyCode).update({ 
            started:true, 
            abandoned:null, 
            seed:state.seed, 
            trackLen:state.trackLen,
            totalLaps:state.totalLaps
          }); 
        } 
      } else {
        // å‚åŠ è€…å´ã®å ´åˆã€ã‚·ãƒ¼ãƒ‰ã‚’å–å¾—
        if(state.lobby && state.lobby.seed) {
          state.seed = state.lobby.seed;
        }
      }
      
      updateButtonsState(); 
      applyLockState();
      
      // å‡ºé¦¬è¡¨ã®è¡¨ç¤ºï¼ˆå…¨å“¡ã«è¡¨ç¤ºï¼‰
      await showStartingLineup();
      
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆå…¨å“¡ã«è¡¨ç¤ºï¼‰
      for(let i=3;i>0;i--){ 
        $.count.textContent=String(i); 
        await sleep(800);
      } 
      
      $.count.textContent='GO!'; 
      await sleep(400); 
      $.count.textContent='';
      
      // ãƒ›ã‚¹ãƒˆã®ã¿ç‰©ç†æ¼”ç®—ã‚’é–‹å§‹
      if(state.isHost){ 
        this.loopHost(); 
      }
    },
    physics(dt,noise){ 
      const L=state.trackLen;
      const totalLaps=state.totalLaps;
      
      // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯
      if(isNaN(dt) || dt <= 0 || dt > 1) {
        console.warn('Invalid dt value:', dt);
        return;
      }
      
      for(const id in this.horses){ 
        const H=this.horses[id]; 
        if(H.done) continue; 
        const spec=H.horse; 
        
        // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
        if(isNaN(H.x)) H.x = 0;
        if(isNaN(H.v)) H.v = 0;
        if(isNaN(H.s)) H.s = H.maxS || Math.max(200, spec.stamina || 400);
        if(isNaN(H.maxS)) H.maxS = Math.max(200, spec.stamina || 400);
        if(isNaN(H.laps)) H.laps = 0;
        if(isNaN(H.totalDistance)) H.totalDistance = 0;
        
        // ã‚¹ã‚¿ãƒŸãƒŠã‚·ã‚¹ãƒ†ãƒ ã®æ”¹è‰¯ï¼ˆãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼‰
        const maxStamina = H.maxS;
        const currentStamina = Math.max(0, H.s);
        const staminaRatio = currentStamina / maxStamina;
        
        // ã‚¹ã‚¿ãƒŸãƒŠã«ã‚ˆã‚‹å½±éŸ¿ã‚’ç·©å’Œï¼ˆã‚ˆã‚Šç¾å®Ÿçš„ã«ï¼‰
        let staminaEffect = 1.0;
        if(staminaRatio > 0.8) {
          // 80%ä»¥ä¸Šï¼šã»ã¼ãƒ•ãƒ«æ€§èƒ½
          staminaEffect = 0.95 + staminaRatio * 0.05; // 99-100%
        } else if(staminaRatio > 0.6) {
          // 60-80%ï¼šã‚ãšã‹ã«æ€§èƒ½ä½ä¸‹
          staminaEffect = 0.85 + staminaRatio * 0.15; // 94-97%
        } else if(staminaRatio > 0.4) {
          // 40-60%ï¼šå¾ã€…ã«æ€§èƒ½ä½ä¸‹
          staminaEffect = 0.7 + staminaRatio * 0.25; // 80-85%
        } else if(staminaRatio > 0.2) {
          // 20-40%ï¼šæ˜ç¢ºãªæ€§èƒ½ä½ä¸‹
          staminaEffect = 0.5 + staminaRatio * 0.5; // 60-70%
        } else if(staminaRatio > 0.1) {
          // 10-20%ï¼šå¤§å¹…ãªæ€§èƒ½ä½ä¸‹
          staminaEffect = 0.3 + staminaRatio * 1.0; // 40-50%
        } else {
          // 10%ä»¥ä¸‹ï¼šé‡ã„çŠ¶æ…‹ã ãŒå‹•ã‘ã‚‹
          staminaEffect = 0.25 + staminaRatio * 0.5; // 25-30%
        }
        
        // ä½ç½®ã«åŸºã¥ãã‚³ãƒ¼ã‚¹åˆ†æï¼ˆ0-1ã®é€²è¡Œåº¦ï¼‰
        const raceProgress = Math.max(0, Math.min(1, (H.totalDistance || 0) / (L * totalLaps)));
        const lapProgress = Math.max(0, Math.min(1, (H.x || 0) / L));
        
        // ã‚³ãƒ¼ãƒŠãƒ¼åˆ¤å®šï¼ˆæ¥•å††ã®å·¦å³éƒ¨åˆ†ã‚’ã‚³ãƒ¼ãƒŠãƒ¼ã¨ã™ã‚‹ï¼‰
        const angle = lapProgress * 2 * Math.PI;
        const isInCorner = (angle > Math.PI/4 && angle < 3*Math.PI/4) || 
                          (angle > 5*Math.PI/4 && angle < 7*Math.PI/4);
        
        // ç›´ç·šåˆ¤å®šï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«å‰ã®ç›´ç·šï¼‰
        const isInStraight = (angle >= 7*Math.PI/4) || (angle <= Math.PI/4);
        const isFinalStraight = H.laps >= totalLaps - 1 && isInStraight;
        
        // æ°—åˆ†ã«ã‚ˆã‚‹èƒ½åŠ›è£œæ­£
        const moodMultiplier = (spec.mood && spec.mood.multiplier) ? spec.mood.multiplier : 1.0;
        
        // åŸºæœ¬èƒ½åŠ›å€¤ï¼ˆãƒãƒ©ãƒ³ã‚¹èª¿æ•´æ¸ˆã¿ï¼‰
        let adjustedTopSpeed = Math.max(5, (spec.topSpeed || 15) * moodMultiplier);
        let adjustedAccel = Math.max(0.5, (spec.accel || 3) * moodMultiplier);
        
        // ã‚¹ã‚¿ãƒŸãƒŠåŠ¹æœã‚’å…¨ä½“ã«é©ç”¨ï¼ˆæœ€é‡è¦ï¼‰
        adjustedTopSpeed *= staminaEffect;
        adjustedAccel *= staminaEffect;
        
        // ã‚³ãƒ¼ãƒŠãƒ¼ãƒ¯ãƒ¼ã‚¯é©æ€§ï¼ˆåŠ¹æœã‚’å¼·åŒ–ï¼‰
        if(isInCorner) {
          const cornerSkill = Math.max(0, Math.min(1, (spec.corner || 2) / 8)); // 0-1ã«æ­£è¦åŒ–
          adjustedTopSpeed *= (0.6 + cornerSkill * 0.5); // ã‚³ãƒ¼ãƒŠãƒ¼ã§ã¯åŸºæœ¬60-110%
          adjustedAccel *= (0.7 + cornerSkill * 0.4);   // åŠ é€Ÿã‚‚å½±éŸ¿ã‚’å¼·åŒ–
        }
        
        // æœ«è„šï¼ˆæœ€çµ‚ç›´ç·šã§ã®è¿½ã„è¾¼ã¿ï¼‰å¼·åŒ–
        if(isFinalStraight && raceProgress > 0.8) {
          const finishSkill = Math.max(0, Math.min(1, (spec.finish || 2) / 10)); // 0-1ã«æ­£è¦åŒ–
          // æœ«è„šã¯ã‚¹ã‚¿ãƒŸãƒŠæ®‹é‡ã«å¤§ããä¾å­˜
          const finishBoost = 1 + finishSkill * Math.pow(staminaRatio, 0.5) * 1.2;
          adjustedAccel *= finishBoost;
          
          // æœ«è„šã®å¼·ã„é¦¬ã¯æœ€å¾Œã«ä¸€æ°—ã«ä¼¸ã³ã‚‹ï¼ˆã‚¹ã‚¿ãƒŸãƒŠå¿…é ˆï¼‰
          if(raceProgress > 0.9 && staminaRatio > 0.3) {
            adjustedTopSpeed *= (1 + finishSkill * staminaRatio * 0.8);
          }
        }
        
        // åºç›¤ã®å‡ºé…ã‚Œï¼ˆåŠ é€Ÿåº¦ã®é‡è¦æ€§ã‚’å‘ä¸Šï¼‰
        if(raceProgress < 0.15) { // ç¯„å›²ã‚’æ‹¡å¤§
          const startPenalty = Math.max(0, Math.min(0.5, 1 - (spec.accel || 2) / 5)); // åŠ é€Ÿåº¦ã®å½±éŸ¿ã‚’å¼·åŒ–
          adjustedAccel *= (1 - startPenalty * 0.4); // ä»¥å‰: 0.3
        }
        
        // ä¸­ç›¤ã§ã®ã‚¹ã‚¿ãƒŸãƒŠé…åˆ†æˆ¦ç•¥
        if(raceProgress > 0.3 && raceProgress < 0.8) {
          // ã‚¹ã‚¿ãƒŸãƒŠã«ä½™è£•ãŒã‚ã‚‹é¦¬ã¯ãƒšãƒ¼ã‚¹ã‚¢ãƒƒãƒ—
          if(staminaRatio > 0.7) {
            adjustedAccel *= 1.1;
          }
          // ã‚¹ã‚¿ãƒŸãƒŠãŒå°‘ãªã„é¦¬ã¯ãƒšãƒ¼ã‚¹ãƒ€ã‚¦ãƒ³ã§æ¸©å­˜
          else if(staminaRatio < 0.4) {
            adjustedTopSpeed *= 0.85;
            adjustedAccel *= 0.7;
          }
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ï¼ˆãƒ¬ãƒ¼ã‚¹å±•é–‹ã®å¦™ï¼‰
        const randomFactor = 0.95 + (noise() * 0.1); // Â±5%ã®ãƒ©ãƒ³ãƒ€ãƒ 
        
        // æœ€çµ‚çš„ãªåŠ é€Ÿåº¦è¨ˆç®—
        const targetSpeed = Math.max(0, adjustedTopSpeed * randomFactor);
        const accelRate = Math.max(0, adjustedAccel * randomFactor);
        
        // é€Ÿåº¦æ›´æ–°ï¼ˆã‚ˆã‚Šæ»‘ã‚‰ã‹ã«ï¼‰
        if(H.v < targetSpeed) {
          H.v = Math.min(targetSpeed, H.v + accelRate * dt);
        } else {
          H.v = Math.max(0, Math.max(targetSpeed, H.v - accelRate * dt * 0.5)); // æ¸›é€Ÿã¯ç·©ã‚„ã‹
        }
        
        // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯
        if(isNaN(H.v)) H.v = 0;
        H.v = Math.max(0, H.v); // è² ã®å€¤ã‚’é˜²æ­¢
        
        // ä½ç½®æ›´æ–°
        const oldX = H.x;
        const deltaX = H.v * dt;
        if(isNaN(deltaX)) {
          console.warn('NaN deltaX detected', { v: H.v, dt: dt });
          continue;
        }
        
        H.x += deltaX; 
        H.totalDistance += deltaX;
        
        // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯
        if(isNaN(H.x)) H.x = oldX;
        if(isNaN(H.totalDistance)) H.totalDistance = Math.max(0, oldX);
        
        // ã‚¹ã‚¿ãƒŸãƒŠæ¶ˆè²»ï¼ˆå¤§å¹…ç·©å’Œ - 3å€é•·æŒã¡ï¼‰
        let staminaCost = 0.4; // åŸºæœ¬æ¶ˆè²»ã‚’ã•ã‚‰ã«åŠæ¸›ä»¥ä¸‹ï¼ˆä»¥å‰: 1.0ï¼‰
        
        // é€Ÿåº¦ã«ã‚ˆã‚‹æ¶ˆè²»ï¼ˆå¤§å¹…ç·©å’Œï¼‰
        staminaCost += Math.pow(H.v / 15, 1.5) * 1.2; // å¤§å¹…ç·©å’Œï¼ˆä»¥å‰: (H.v/12)^1.8 * 2.0ï¼‰
        
        // ã‚³ãƒ¼ã‚¹çŠ¶æ³ã«ã‚ˆã‚‹æ¶ˆè²»ï¼ˆç·©å’Œï¼‰
        if(isInCorner) staminaCost *= 1.2; // ã•ã‚‰ã«ç·©å’Œï¼ˆä»¥å‰: 1.3å€ï¼‰
        if(isFinalStraight && raceProgress > 0.8) staminaCost *= 1.4; // ã•ã‚‰ã«ç·©å’Œï¼ˆä»¥å‰: 1.6å€ï¼‰
        
        // åŠ é€Ÿä¸­ã®è¿½åŠ æ¶ˆè²»ï¼ˆç·©å’Œï¼‰
        const accelPenalty = Math.max(0, (adjustedAccel - 1) * 0.2); // ã•ã‚‰ã«ç·©å’Œï¼ˆä»¥å‰: 0.3ï¼‰
        staminaCost += accelPenalty;
        
        const staminaDecrease = staminaCost * dt * 15; // æ¶ˆè²»é€Ÿåº¦ã‚’åŠæ¸›ï¼ˆä»¥å‰: 30ï¼‰
        if(!isNaN(staminaDecrease)) {
          H.s -= staminaDecrease;
          H.s = Math.max(0, H.s); // è² ã®å€¤ã‚’é˜²æ­¢
        }
        
        // ã‚¹ã‚¿ãƒŸãƒŠå›å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã•ã‚‰ã«å¼·åŒ–ï¼‰
        if(H.v < adjustedTopSpeed * 0.85) { // 85%ä»¥ä¸‹ã®é€Ÿåº¦ã§èµ°ã£ã¦ã„ã‚‹æ™‚ï¼ˆä»¥å‰: 80%ï¼‰
          const recoveryRate = (adjustedTopSpeed * 0.85 - H.v) / adjustedTopSpeed * 4.0; // å›å¾©ç‡å¤§å¹…å‘ä¸Šï¼ˆä»¥å‰: 3.0ï¼‰
          const recovery = recoveryRate * dt * 60; // å›å¾©é€Ÿåº¦å‘ä¸Šï¼ˆä»¥å‰: 50ï¼‰
          if(!isNaN(recovery)) {
            H.s = Math.min(H.maxS, H.s + recovery); // æœ€å¤§å€¤ã¾ã§å›å¾©
          }
        }
        
        // ã‚¹ã‚¿ãƒŸãƒŠåˆ‡ã‚Œæ™‚ã®å‡¦ç†ï¼ˆã•ã‚‰ã«ç·©å’Œï¼‰
        if(H.s <= 0) {
          H.v *= 0.99; // æ¸›é€Ÿã‚’ã•ã‚‰ã«ç·©å’Œï¼ˆä»¥å‰: 0.98ã§2%æ¸›é€Ÿã€ç¾åœ¨: 0.99ã§1%æ¸›é€Ÿï¼‰
          H.v = Math.max(adjustedTopSpeed * 0.35, H.v); // æœ€ä½é€Ÿåº¦ã‚’ã•ã‚‰ã«å‘ä¸Šï¼ˆä»¥å‰: 25%ã€ç¾åœ¨: 35%ï¼‰
        }
        
        // 1å‘¨åˆ¤å®š
        if(oldX < L && H.x >= L) {
          H.laps++;
          H.x = H.x - L; // è¶…éåˆ†ã‚’æ¬¡ã®å‘¨ã«æŒã¡è¶Šã—
          
          // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯
          if(isNaN(H.x)) H.x = 0;
          if(isNaN(H.laps)) H.laps = 1;
          
          // ã‚´ãƒ¼ãƒ«åˆ¤å®šï¼ˆ3å‘¨å®Œäº†ï¼‰
          if(H.laps >= totalLaps) {
            H.x = 0; // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã«å›ºå®š
            H.done = true;
            this.order.push(id);
          }
        }
      } 
    },
    loopHost(){ 
      this.running=true; 
      const noise=randSeeded(state.seed); 
      let last=performance.now(), sendAcc=0; 
      const step=(now)=>{ 
        if(!this.running||!state.started||state.abandoned){ 
          return; 
        } 
        const dt=Math.min(0.05,(now-last)/1000); 
        last=now; 
        this.physics(dt,noise); 
        sendAcc+=dt; 
        if(sendAcc>0.10 && state.net){ 
          const pos={}, vel={}, laps={}, totalDist={}, stamina={}, maxStamina={}; 
          Object.values(this.horses).forEach(H=>{
            // NaNå€¤ã®ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
            const safeX = isNaN(H.x) ? 0 : H.x;
            const safeV = isNaN(H.v) ? 0 : H.v;
            const safeLaps = isNaN(H.laps) ? 0 : H.laps;
            const safeTotalDistance = isNaN(H.totalDistance) ? 0 : H.totalDistance;
            const safeStamina = isNaN(H.s) ? 0 : H.s;
            const safeMaxStamina = isNaN(H.maxS) ? 400 : H.maxS;
            
            pos[H.id] = Math.round(safeX); 
            vel[H.id] = Math.round(safeV * 100) / 100;
            laps[H.id] = safeLaps;
            totalDist[H.id] = Math.round(safeTotalDistance);
            stamina[H.id] = Math.round(safeStamina);
            maxStamina[H.id] = Math.round(safeMaxStamina);
          }); 
          const colors={}; 
          Object.values(this.horses).forEach(H=>{ 
            const p=state.players[H.id]; 
            colors[H.id]=(p&&p.horse&&p.horse.color)||'#7dd3fc'; 
          }); 
          
          // NaNå€¤ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          const hasNaN = Object.values(pos).some(v => isNaN(v)) || 
                        Object.values(vel).some(v => isNaN(v)) || 
                        Object.values(laps).some(v => isNaN(v)) || 
                        Object.values(totalDist).some(v => isNaN(v)) ||
                        Object.values(stamina).some(v => isNaN(v)) ||
                        Object.values(maxStamina).some(v => isNaN(v));
          
          if(!hasNaN) {
            R('lobbies/'+state.lobbyCode+'/state').set({ 
              t:Date.now(), 
              L:state.trackLen, 
              totalLaps:state.totalLaps, 
              pos, vel, laps, totalDist, stamina, maxStamina, colors 
            }); 
          } else {
            console.warn('NaN values detected, skipping Firebase update');
          }
          sendAcc=0; 
        } 
        if(state.ctx) drawRace(); 
        if(this.order.length===Object.keys(this.horses).length){ 
          this.finish(); 
          return; 
        } 
        requestAnimationFrame(step); 
      }; 
      requestAnimationFrame(step); 
    },
    async finish(){ this.running=false; const out=this.order.map((id,idx)=>{ const p=state.players[id]; return { rank:idx+1, id, player:p&&p.name||id, horse:p&&p.horse&&p.horse.name||'é¦¬', color:p&&p.horse&&p.horse.color||'#fff' }; }); if(state.net){ await R('lobbies/'+state.lobbyCode+'/results').set(out); await R('lobbies/'+state.lobbyCode).update({ started:false }); } state.results=out; renderResults(); state.started=false; updateButtonsState(); applyLockState(); }
  };

  function setupCanvas(){ 
    const c=$.canvas; 
    const wrap=document.getElementById('canvasWrap'); 
    const dpr=state.dpr; 
    
    const containerWidth = wrap.clientWidth;
    const containerHeight = wrap.clientHeight;
    
    // ãƒ¬ãƒ¼ã‚¹ä¸­ã¯ç”»é¢å…¨ä½“ã‚’ä½¿ç”¨
    if(document.querySelector('main').classList.contains('racing')) {
      c.width = Math.floor(containerWidth * dpr); 
      c.height = Math.floor(containerHeight * dpr); 
    } else {
      // é€šå¸¸æ™‚ã¯4:3ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
      const aspectRatio = 4/3;
      let canvasWidth, canvasHeight;
      
      if(containerWidth / containerHeight > aspectRatio) {
        canvasHeight = containerHeight;
        canvasWidth = canvasHeight * aspectRatio;
      } else {
        canvasWidth = containerWidth;
        canvasHeight = canvasWidth / aspectRatio;
      }
      
      c.width = Math.floor(canvasWidth * dpr); 
      c.height = Math.floor(canvasHeight * dpr); 
    }
    
    c.style.width = '100%';
    c.style.height = '100%';
    
    state.ctx = c.getContext('2d'); 
    if(state.ctx) drawRace(); 
  }
  window.addEventListener('resize', setupCanvas);

  function getPos(id){ 
    if(state.isHost){ 
      const horse = sim.horses[id];
      const pos = horse ? horse.x : 0;
      return isNaN(pos) ? 0 : pos;
    } 
    const st = state.lastState; 
    if(!st || !st.pos) return 0; 
    const pos = st.pos[id] || 0;
    return isNaN(pos) ? 0 : pos;
  }

  function getLaps(id){
    if(state.isHost){
      const horse = sim.horses[id];
      const laps = horse ? horse.laps : 0;
      return isNaN(laps) ? 0 : laps;
    }
    const st = state.lastState;
    if(!st || !st.laps) return 0;
    const laps = st.laps[id] || 0;
    return isNaN(laps) ? 0 : laps;
  }

  // ç¸¦å‘ãæ¥•å††ã‚³ãƒ¼ã‚¹ã§ã®ãƒ¬ãƒ¼ã‚¹æç”»ï¼ˆ3å‘¨åˆ¶å¯¾å¿œï¼‰
  function drawRace(){ 
    const ctx=state.ctx; 
    if(!ctx) return; 
    const c=$.canvas; 
    const dpr=state.dpr; 
    ctx.clearRect(0,0,c.width,c.height); 
    const lanes=state.lanes; 
    const L=state.trackLen; 
    const totalLaps=state.totalLaps;
    
    // ç”»é¢ã‚µã‚¤ã‚ºåˆ¤å®šã‚’æœ€åˆã«è¡Œã†
    const isSmall = c.width < 400*dpr;
    
    if(!lanes.length){ 
      ctx.fillStyle='rgba(255,255,255,.08)'; 
      ctx.font=`${16*dpr}px system-ui`; 
      const text = 'ãƒ­ãƒ“ãƒ¼ã«å‚åŠ ã—ã¦é¦¬ã‚’ç™»éŒ²';
      const textWidth = ctx.measureText(text).width;
      ctx.fillText(text, (c.width - textWidth)/2, c.height/2); 
      return; 
    } 
    
    // ç¸¦å‘ãæ¥•å††ã‚³ãƒ¼ã‚¹ã®è¨­å®š
    const centerX = c.width / 2;
    const centerY = c.height / 2;
    const trackHeight = Math.min(c.height * 0.8, c.width * 1.4); // ç¸¦é•·
    const trackWidth = trackHeight * 0.6; // æ¥•å††ã®ç¸¦æ¨ªæ¯”ã‚’èª¿æ•´ï¼ˆç¸¦é•·ï¼‰
    const radiusX = trackWidth / 2;
    const radiusY = trackHeight / 2;
    
    const laneCount = lanes.length;
    const laneSpacing = Math.min(12*dpr, radiusX * 0.15);
    
    // ã‚³ãƒ¼ã‚¹ã®å¤–æ ã¨å†…æ ã‚’æç”»
    for(let i = 0; i <= laneCount; i++) {
      const currentRadiusX = radiusX - i * laneSpacing;
      const currentRadiusY = radiusY - i * laneSpacing;
      
      if(currentRadiusX > 0 && currentRadiusY > 0) {
        ctx.strokeStyle = i === 0 ? 'rgba(108,255,128,.6)' : 'rgba(255,255,255,.15)';
        ctx.lineWidth = i === 0 ? 4*dpr : 1*dpr;
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, currentRadiusX, currentRadiusY, 0, 0, 2 * Math.PI);
        ctx.stroke();
      }
    }
    
    // ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³ï¼ˆå³å´ã®æ¨ªç·šï¼‰- ã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«
    ctx.strokeStyle = 'rgba(255,204,108,.9)';
    ctx.lineWidth = 6*dpr;
    ctx.setLineDash([]);
    ctx.beginPath();
    const lineLength = laneSpacing * (laneCount + 1);
    ctx.moveTo(centerX + radiusX - lineLength, centerY);
    ctx.lineTo(centerX + radiusX + lineLength, centerY);
    ctx.stroke();
    
    // ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«è¡¨ç¤º
    ctx.fillStyle = 'rgba(255,204,108,.9)';
    ctx.font = `bold ${16*dpr}px system-ui`;
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ START / GOAL', centerX + radiusX + 60*dpr, centerY);
    
    // è·é›¢ã¨å‘¨å›æ•°è¡¨ç¤º
    ctx.fillStyle = 'rgba(255,255,255,.8)';
    ctx.font = `${14*dpr}px ui-monospace, monospace`;
    ctx.textAlign = 'center';
    ctx.fillText(`${totalLaps}å‘¨åˆ¶ (1å‘¨ ${L}m)`, centerX, centerY - radiusY - 45*dpr);
    
    // å„é¦¬ã®æç”»
    lanes.forEach((ln, i) => {
      const laneRadiusX = radiusX - (i + 0.5) * laneSpacing;
      const laneRadiusY = radiusY - (i + 0.5) * laneSpacing;
      
      if(laneRadiusX <= 0 || laneRadiusY <= 0) return;
      
      const pos = getPos(ln.id);
      const laps = getLaps(ln.id);
      const progress = Math.max(0, Math.min(1, pos / L));
      
      // æ¥•å††ä¸Šã®ä½ç½®è¨ˆç®—ï¼ˆå³å´ã‹ã‚‰æ™‚è¨ˆå›ã‚Šï¼‰
      const angle = progress * 2 * Math.PI; // å³å´(START/GOAL)ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
      const x = centerX + laneRadiusX * Math.cos(angle);
      const y = centerY + laneRadiusY * Math.sin(angle);
      
      const p = state.players[ln.id];
      const col = (state.lastState?.colors?.[ln.id]) || (p?.horse?.color) || ln.color || '#7dd3fc';
      
      // é¦¬ã‚’å††å½¢ã§æç”»
      const horseSize = Math.min(14*dpr, laneSpacing * 0.9);
      ctx.fillStyle = col;
      ctx.beginPath();
      ctx.arc(x, y, horseSize/2, 0, 2 * Math.PI);
      ctx.fill();
      
      // é¦¬ã®è¼ªéƒ­
      ctx.strokeStyle = 'rgba(255,255,255,.8)';
      ctx.lineWidth = 2*dpr;
      ctx.stroke();
      
      // æ°—åˆ†ã‚¨ãƒ¢ã‚¸ã‚’é¦¬ã®ä¸Šã«è¡¨ç¤º
      if(p?.horse?.mood) {
        ctx.font = `${horseSize*0.8}px system-ui`;
        ctx.textAlign = 'center';
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        ctx.fillText(p.horse.mood.emoji, x, y - horseSize/2 - 8*dpr);
      }
      
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨å‘¨å›æ•°ã‚’é¦¬ã®è¿‘ãã«è¡¨ç¤º
      if(p?.horse?.name) {
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        const fontSize = isSmall ? 10*dpr : 12*dpr;
        ctx.font = `${fontSize}px system-ui`;
        ctx.textAlign = 'center';
        const nameText = `${p.horse.name} (${laps}/${totalLaps})`; // é¦¬ã®åå‰ã‚’è¡¨ç¤º
        const nameWidth = ctx.measureText(nameText).width;
        
        // åå‰ã®èƒŒæ™¯
        ctx.fillStyle = 'rgba(0,0,0,.8)';
        ctx.fillRect(x - nameWidth/2 - 3*dpr, y + horseSize/2 + 2*dpr, nameWidth + 6*dpr, fontSize + 4*dpr);
        
        // åå‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå‘¨å›æ•°ä»˜ãï¼‰
        ctx.fillStyle = laps >= totalLaps ? 'rgba(255,215,0,.9)' : 'rgba(255,255,255,.9)'; // ã‚´ãƒ¼ãƒ«æ™‚ã¯é‡‘è‰²
        ctx.fillText(nameText, x, y + horseSize/2 + fontSize + 4*dpr);
      }
      
      // è·é›¢è¡¨ç¤ºï¼ˆå°ã•ãï¼‰
      if(!isSmall) {
        ctx.fillStyle = 'rgba(255,255,255,.6)';
        ctx.font = `${9*dpr}px ui-monospace, monospace`;
        ctx.textAlign = 'center';
        const distText = `${Math.round(pos)}m`;
        ctx.fillText(distText, x, y + horseSize/2 + 25*dpr);
      }
    });
    
    
    // textAlignã‚’ãƒªã‚»ãƒƒãƒˆ
    ctx.textAlign = 'left';
  }

  // --- Buttons ---
  $.create.addEventListener('click', async ()=>{ 
    const name=$.pName.value.trim(); 
    const hname=$.hName.value.trim(); 
    if(!name||!hname){ 
      alert('ãƒ­ãƒ“ãƒ¼ä½œæˆå‰ã«ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã€ã¨ã€Œé¦¬ã®åå‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); 
      return; 
    } 
    await createLobby(); 
  });
  $.joinBtn.addEventListener('click', ()=>{ 
    const name=$.pName.value.trim(); 
    const hname=$.hName.value.trim(); 
    if(!name||!hname){ 
      alert('å‚åŠ å‰ã«ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã€ã¨ã€Œé¦¬ã®åå‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); 
      return; 
    } 
    const code=($.joinCode.value||'').split('').filter(ch=>ch>='0'&&ch<='9').join(''); 
    if(code.length!==4){ 
      alert('ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™'); 
      return; 
    } 
    joinLobby(code); 
  });
  $.copy.addEventListener('click', ()=>{ if(!state.lobbyCode) return; navigator.clipboard.writeText(state.lobbyCode); $.copy.textContent='âœ…'; setTimeout(()=>$.copy.textContent='ğŸ“‹', 1200); });
  $.save.addEventListener('click', () => upsertMe(false)); // æ°—åˆ†ã‚’å¤‰æ›´ã—ãªã„
  $.ready.addEventListener('click', ()=> setReady(!state.me.ready));
  $.start.addEventListener('click', async ()=>{ if(!state.isHost) return; if(!everyoneReady()){ alert('å…¨å“¡ã®æº–å‚™ãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“'); return; } if(!(state.players[uid]&&state.players[uid].ready)){ alert('ãƒ›ã‚¹ãƒˆã‚‚ã€Œæº–å‚™OKã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; } await upsertMe(false); sim.start(); }); // æ°—åˆ†ã‚’å¤‰æ›´ã—ãªã„
  
  // é€šå¸¸ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
  $.leave.addEventListener('click', leaveLobby);
  $.reset.addEventListener('click', async ()=>{ 
    if(!state.isHost||!state.net||!state.lobbyCode) return; 
    await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:null, seed:0 }); 
    await R('lobbies/'+state.lobbyCode+'/state').remove(); 
    await R('lobbies/'+state.lobbyCode+'/results').remove(); 
    state.started=false; 
    state.results=[]; 
    state.lastState=null; 
    state.abandoned=null; 
    sim.reset(); 
    if(state.ctx) drawRace(); 
    updateButtonsState(); 
    applyLockState(); 
    updateStartVisibility(); 
  });
  $.abort.addEventListener('click', async ()=>{ await abortToLobby(); });

  // ãƒ¬ãƒ¼ã‚¹ä¸­ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
  const leave2 = document.getElementById('leaveBtn2');
  const reset2 = document.getElementById('resetBtn2');
  const abort2 = document.getElementById('abortBtn2');
  
  if(leave2) leave2.addEventListener('click', leaveLobby);
  if(reset2) reset2.addEventListener('click', async ()=>{ 
    if(!state.isHost||!state.net||!state.lobbyCode) return; 
    await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:null, seed:0 }); 
    await R('lobbies/'+state.lobbyCode+'/state').remove(); 
    await R('lobbies/'+state.lobbyCode+'/results').remove(); 
    state.started=false; 
    state.results=[]; 
    state.lastState=null; 
    state.abandoned=null; 
    sim.reset(); 
    if(state.ctx) drawRace(); 
    updateButtonsState(); 
    applyLockState(); 
    updateStartVisibility(); 
  });
  if(abort2) abort2.addEventListener('click', async ()=>{ await abortToLobby(); });

  // URLã‹ã‚‰è‡ªå‹•å‚åŠ 
  (function autoJoin(){ 
    const q=new URLSearchParams(location.search); 
    const room=(q.get('room')||'').split('').filter(ch=>ch>='0'&&ch<='9').join(''); 
    if(room){ 
      joinLobby(room.padStart(4,'0')); 
    } else { 
      updateRoleUI(); 
    } 
  })();

  // åå‰/é¦¬åãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
  (function restoreLocal(){ 
    const pn=localStorage.getItem('playerName'); 
    if(pn) $.pName.value=pn; 
    const hn=localStorage.getItem('horseName'); 
    if(hn) $.hName.value=hn; 
  })();
  
  // åå‰å¤‰æ›´æ™‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
  $.pName.addEventListener('input', ()=>{
    localStorage.setItem('playerName',$.pName.value);
    // åå‰å¤‰æ›´æ™‚ã‚‚ä¿å­˜çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    if(!state.loading) {
      state.me.saved = false;
      updateReadyButtonState();
    }
  });
  $.hName.addEventListener('input', ()=>{
    localStorage.setItem('horseName',$.hName.value);
    // é¦¬åå¤‰æ›´æ™‚ã‚‚ä¿å­˜çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    if(!state.loading) {
      state.me.saved = false;
      updateReadyButtonState();
    }
  });

  // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
  setupCanvas(); 
  
  function clientLoop(){ 
    if(state.ctx) {
      drawRace(); 
    }
    requestAnimationFrame(clientLoop); 
  }
  clientLoop();

  document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); alert('ãƒ’ãƒ³ãƒˆ: Firebaseè¨­å®šã‚’åŸ‹ã‚ã‚‹ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚'); });

  if(!CanvasRenderingContext2D.prototype.roundRect){ CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){ this.beginPath(); this.moveTo(x+r,y); this.lineTo(x+w-r,y); this.quadraticCurveTo(x+w,y,x+w,y+r); this.lineTo(x+w,y+h-r); this.quadraticCurveTo(x+w,y+h,x+w-r,y+h); this.lineTo(x+r,y+h); this.quadraticCurveTo(x,y+h,x,y+h-r); this.lineTo(x,y+r); this.quadraticCurveTo(x,y,x+r,y); this.closePath(); return this; }; }
  </script>
</body>
</html>
