<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>みんなで競馬 - ロビー&オンライン対戦（ポイント振り分け対応）</title>
  <style>
    :root{ --bg:#0f1221; --panel:#171a2e; --text:#e6e7ff; --muted:#9aa0c7; --accent:#6cf; --ok:#6cff80; --warn:#ffd166; --bad:#ff6c9f; --border:rgba(255,255,255,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; display:grid; grid-template-rows:auto 1fr; gap:14px}
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border)}
    header h1{margin:0; font-size:18px}
    header .tag{font-size:12px; color:var(--muted)}
    main{display:grid; grid-template-columns:400px 1fr; gap:14px; padding:0 14px 14px}
    @media (max-width:1024px){ main{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:15px; margin:0 0 10px 0; color:#dfe2ff}
    .pad{padding:16px}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    input,button{font:inherit; color:inherit}
    input[type="text"],input[type="number"],.readonly{width:100%; background:#0e1121; border:1px solid var(--border); border-radius:12px; padding:10px 12px}
    button{background:linear-gradient(180deg,rgba(108,204,255,.25),rgba(108,204,255,.12)); border:1px solid rgba(108,204,255,.45); color:#e8f6ff; padding:10px 14px; border-radius:12px; cursor:pointer}
    button.secondary{background:transparent; border:1px solid var(--border)}
    .danger{background:linear-gradient(180deg,rgba(255,108,159,.2),rgba(255,108,159,.12)); border:1px solid rgba(255,108,159,.45)}
    .success{background:linear-gradient(180deg,rgba(108,255,128,.2),rgba(108,255,128,.12)); border:1px solid rgba(108,255,128,.45)}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#0c1020; border:1px solid var(--border)}
    #canvasWrap{height:520px; position:relative}
    canvas{width:100%; height:100%; background:repeating-linear-gradient(90deg,#111430,#111430 14px,#121535 14px,#121535 28px)}
    #overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    #overlay .big{font-size:72px; font-weight:700; text-shadow:0 10px 30px rgba(0,0,0,.4)}
    #results{position:absolute; right:16px; top:16px; background:rgba(0,0,0,.4); border:1px solid var(--border); border-radius:12px; padding:10px; max-width:300px}
    .slider{display:grid; grid-template-columns:120px 1fr 80px; gap:8px; align-items:center}
    input[type=range]{width:100%}
    .help{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>🏇 みんなで競馬 <span class="tag">ロビー & リアルタイム対戦</span></h1>
    <div id="onlineBadge" class="badge">初期化中...</div>
  </header>

  <main>
    <section class="card pad">
      <h2>ロビー</h2>
      <div class="col">
        <div class="row" style="justify-content:space-between">
          <button id="createLobbyBtn">＋ ロビー作成</button>
          <div class="row"><input type="text" id="joinCode" placeholder="ロビーコードを入力" /><button id="joinLobbyBtn" class="secondary">参加</button></div>
        </div>
        <div class="row">
          <div class="badge">コード: <span id="lobbyCode" class="code">-</span></div>
          <div class="badge">あなた: <span id="whoami">未接続</span></div>
          <div class="badge" id="hostBadge">参加者</div>
        </div>

        <div class="col">
          <div class="row" style="gap:14px">
            <div style="flex:1"><label>プレイヤー名</label><input type="text" id="playerName" placeholder="例：ピカソ" /></div>
            <div style="flex:1"><label>馬の名前</label><input type="text" id="horseName" placeholder="例：サンダー" /></div>
          </div>

          <div class="row" style="gap:14px">
            <div style="flex:1"><label>色</label><input type="color" id="horseColor" value="#7dd3fc" style="width:100%"/></div>
            <div style="flex:2"><label>距離</label><input type="range" id="trackLen" min="200" max="5000" step="10" value="1200"/><div class="muted">コース長: <span id="vLen">1200</span> m</div></div>
          </div>

          <div class="card pad">
            <h2>ポイント振り分け（合計 <span id="ptTotal">300</span> pt）</h2>
            <div class="help">残り: <b id="ptRemain">300</b> pt ／ 合計が0未満または余りがあると保存できません。</div>
            <div class="col" style="gap:10px">
              <div class="slider"><div>最高速度</div><input type="range" id="pTop" min="0" max="300" step="1" value="75"/><div><span id="pvTop">75</span> pt</div></div>
              <div class="slider"><div>加速度</div><input type="range" id="pAcc" min="0" max="300" step="1" value="75"/><div><span id="pvAcc">75</span> pt</div></div>
              <div class="slider"><div>スタミナ</div><input type="range" id="pSta" min="0" max="300" step="1" value="120"/><div><span id="pvSta">120</span> pt</div></div>
              <div class="slider"><div>運（ゆらぎ）</div><input type="range" id="pLuck" min="0" max="300" step="1" value="30"/><div><span id="pvLuck">30</span> pt</div></div>
            </div>
            <div class="help" id="derivedLine">V 0.0 m/s / A 0.00 m/s² / S 0 / L 0.00</div>
          </div>

          <div class="row">
            <button id="saveHorseBtn" class="secondary" disabled>設定を保存 / 更新</button>
            <button id="readyBtn" class="success" disabled>準備OK</button>
            <button id="startBtn" class="danger" style="display:none">ゲーム開始（ホストのみ）</button>
          </div>
          <div class="help">※ 合計がちょうど <span id="ptTotal2">300</span>pt になるまで保存/準備は有効化されません。全員READYでホストだけ「ゲーム開始」ボタンが表示されます。</div>
        </div>

        <div class="card pad" style="margin-top:10px"><h2>参加者一覧</h2><div id="playersList" class="col"></div></div>

        <div class="card pad" style="margin-top:10px">
          <h2>オンライン有効化（必須）</h2>
          <div class="help">異なるデバイス & Wi‑Fi から参加するには、下の <b>firebaseConfig</b> を埋めてください。未設定時はオフライン動作のみ。</div>
          <details><summary>Firebase 設定を開く</summary><pre class="code" id="cfgPreview"></pre></details>
        </div>
      </div>
    </section>

    <section class="card pad">
      <h2>レース</h2>
      <div id="canvasWrap" class="card">
        <canvas id="race"></canvas>
        <div id="overlay"><div class="big" id="countDown"></div></div>
        <div id="results" class="col" style="display:none"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="leaveBtn" class="secondary">ロビーから抜ける</button>
        <button id="resetBtn" class="secondary">レースをリセット（ホスト）</button>
      </div>
      <div class="help" style="margin-top:8px">レース計算はホスト端末で実行し、進行状況は他端末にも配信されます。</div>
    </section>
  </main>

  <!-- Firebase（任意・オンライン同期用） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ========= Firebase 設定（あなたの値を入れてOK） =========
  const firebaseConfig = {
    apiKey: "AIzaSyBOqe--KczRP2fFCykd4iH1iaAVpyQTlSE",
    authDomain: "keiba-66344.firebaseapp.com",
    databaseURL: "https://keiba-66344-default-rtdb.firebaseio.com",
    projectId: "keiba-66344",
    storageBucket: "keiba-66344.firebasestorage.app",
    messagingSenderId: "636995719079",
    appId: "1:636995719079:web:dbb09c8860101a4c82b082",
    measurementId: "G-QSPM8PBTTH"
  };
  // ==========================================================

  const POINT_TOTAL = 300;
  const RANGES = {
    topSpeed:[8,25], // m/s
    accel:[0.2,7],   // m/s^2
    stamina:[50,1200], // SP
    luck:[0,3]
  };

  const el = (id)=>document.getElementById(id);
  const uid = localStorage.getItem('uid') || (()=>{const v=crypto.getRandomValues(new Uint32Array(4)); const s=[...v].map(x=>x.toString(16).padStart(8,'0')).join(''); localStorage.setItem('uid', s); return s;})()

  const state = { net:false, app:null, db:null, me:{ id:uid, name:"", horse:null, ready:false }, lobby:null, lobbyCode:null, isHost:false, players:{}, started:false, seed:null, results:[], ctx:null, canvas:null, dpr:Math.min(2, window.devicePixelRatio||1), lanes:[], trackLen:1200, lastState:null };

  const $ = {
    code: el('lobbyCode'), who: el('whoami'), hostBadge: el('hostBadge'), onlineBadge: el('onlineBadge'),
    create: el('createLobbyBtn'), joinBtn: el('joinLobbyBtn'), joinCode: el('joinCode'),
    pName: el('playerName'), hName: el('horseName'), hColor: el('horseColor'),
    trackLen: el('trackLen'), vLen: el('vLen'),
    pTop: el('pTop'), pAcc: el('pAcc'), pSta: el('pSta'), pLuck: el('pLuck'),
    pvTop: el('pvTop'), pvAcc: el('pvAcc'), pvSta: el('pvSta'), pvLuck: el('pvLuck'),
    ptRemain: el('ptRemain'), ptTotal: el('ptTotal'), ptTotal2: el('ptTotal2'), derived: el('derivedLine'),
    save: el('saveHorseBtn'), ready: el('readyBtn'), start: el('startBtn'), playersList: el('playersList'),
    canvas: el('race'), count: el('countDown'), results: el('results'),
    leave: el('leaveBtn'), reset: el('resetBtn'), cfgPreview: el('cfgPreview')
  };
  $.ptTotal.textContent = POINT_TOTAL; $.ptTotal2.textContent = POINT_TOTAL;

  function syncPoints(){
    $.pvTop.textContent=$.pTop.value; $.pvAcc.textContent=$.pAcc.value; $.pvSta.textContent=$.pSta.value; $.pvLuck.textContent=$.pLuck.value;
    const sum = (+$.pTop.value)+(+$.pAcc.value)+(+$.pSta.value)+(+$.pLuck.value);
    const remain = POINT_TOTAL - sum; $.ptRemain.textContent = remain;
    $.vLen.textContent = (+$.trackLen.value).toFixed(0);
    const stats = deriveStats();
    $.derived.textContent = 'V '+stats.topSpeed.toFixed(1)+' m/s / A '+stats.accel.toFixed(2)+' m/s² / S '+Math.round(stats.stamina)+' / L '+stats.luck.toFixed(2);
    const ok = (remain===0 && stats.topSpeed>0);
    $.save.disabled = !ok; $.ready.disabled = !ok;
    if(state.me.ready && remain!==0) setReady(false);
  }
  ;[$.pTop,$.pAcc,$.pSta,$.pLuck,$.trackLen].forEach(i=>i.addEventListener('input', syncPoints));
  syncPoints();

  function mapLinear(p,min,max){ const f = Math.max(0, Math.min(1, p/POINT_TOTAL)); return min + (max-min)*f; }
  function deriveStats(){
    return {
      topSpeed: mapLinear(+$.pTop.value, RANGES.topSpeed[0], RANGES.topSpeed[1]),
      accel:    mapLinear(+$.pAcc.value, RANGES.accel[0],    RANGES.accel[1]),
      stamina:  mapLinear(+$.pSta.value, RANGES.stamina[0],  RANGES.stamina[1]),
      luck:     mapLinear(+$.pLuck.value, RANGES.luck[0],    RANGES.luck[1])
    };
  }

  function initFirebase(){
    if(typeof window.firebase==='undefined'){
      $.onlineBadge.textContent='オフライン（SDK未読込）';
      $.cfgPreview.textContent='FirebaseのCDNがブロックされているか、ローカルの制限で読めていません。\n→ 別ブラウザ/シークレットで開く、拡張機能を一時OFF、ローカルでファイルを直接開く、などを試してください。';
      return;
    }
    if(!firebaseConfig || !firebaseConfig.apiKey){
      $.onlineBadge.textContent='オフライン（デモ）';
      $.cfgPreview.textContent='const firebaseConfig = {\n  apiKey: "<APIキー>",\n  authDomain: "<xxx>.firebaseapp.com",\n  databaseURL: "https://<xxx>-default-rtdb.<region>.firebasedatabase.app",\n  projectId: "<プロジェクトID>",\n  storageBucket: "<xxx>.appspot.com",\n  messagingSenderId: "<数字>",\n  appId: "<appId>"\n};';
      return;
    }
    try{
      state.app=firebase.initializeApp(firebaseConfig);
      state.db=firebase.database();
      state.net=true;
      firebase.auth().signInAnonymously().catch(console.error);
      $.onlineBadge.textContent='オンライン有効（Firebase）';
    }catch(e){ console.error(e); $.onlineBadge.textContent='オフライン（初期化エラー）'; }
  }
  initFirebase();

  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const randSeeded=(seed)=>{let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return s/0x100000000; }};
  const prettyCode=c=>c?c.replace(/(.{3})/g,'$1 ').trim():'-';
  const R=(path)=> state.db?state.db.ref(path):null;
  function makeCode(){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<5;i++){ s+=chars[Math.floor(Math.random()*chars.length)]; } return s; }

  function collectHorse(){
    const d = deriveStats();
    return {
      name: $.hName.value.trim() || 'ノーマル',
      color: $.hColor.value,
      topSpeed: +d.topSpeed.toFixed(2),
      accel: +d.accel.toFixed(2),
      stamina: Math.round(d.stamina),
      luck: +d.luck.toFixed(2)
    };
  }

  function everyoneReady(){ const ps=state.players||{}; const ids=Object.keys(ps); if(!ids.length) return false; return ids.every(id=>!!ps[id]&&!!ps[id].ready); }
  function updateStartVisibility(){ const show=state.isHost && everyoneReady() && !state.started; $.start.style.display = show ? 'inline-block' : 'none'; }
  function updateReadyButton(){ $.ready.textContent = state.me.ready? '準備解除':'準備OK'; $.ready.className = state.me.ready? 'secondary':'success'; }

  async function upsertMe(){
    const name = $.pName.value.trim() || ('Player-'+uid.slice(0,4).toUpperCase());
    const horse = collectHorse(); state.me.name=name; state.me.horse=horse; $.who.textContent=name;
    if(state.net && state.lobbyCode){ await R('lobbies/'+state.lobbyCode+'/players/'+uid).set({ name, horse, ready: state.me.ready||false, updatedAt: Date.now() }); }
    else { state.players[uid] = { name, horse, ready: state.me.ready||false }; renderPlayers(); updateStartVisibility(); }
  }
  async function setReady(val){ state.me.ready=!!val; updateReadyButton(); if(state.net && state.lobbyCode){ await R('lobbies/'+state.lobbyCode+'/players/'+uid).update({ ready: state.me.ready, updatedAt: Date.now() }); } renderPlayers(); updateStartVisibility(); }

  function renderPlayers(){
    $.playersList.innerHTML=''; const keys=Object.keys(state.players||{}); if(keys.length===0){ $.playersList.innerHTML='<div class="muted">（まだ参加者はいません）</div>'; return; }
    keys.forEach(function(id){ const p=state.players[id]; if(!p) return; const div=document.createElement('div'); div.className='row'; div.style.justifyContent='space-between'; var status=p.ready?'<span class="badge" style="border-color:#6cff80">READY</span>':'<span class="badge" style="border-color:#ffd166">待機</span>'; var colorBadge='<span class="badge" style="border-color:'+(p.horse && p.horse.color || '#888')+'">'+(p.horse && p.horse.color || '#888')+'</span>'; var spec='V'+(p.horse && p.horse.topSpeed || '?')+' A'+(p.horse && p.horse.accel || '?')+' S'+(p.horse && p.horse.stamina || '?')+' L'+(p.horse && p.horse.luck || '?'); div.innerHTML='<div><b>'+ (p.name||'名無し') +'</b> <span class="muted">/ '+ (p.horse && p.horse.name || '馬') +'</span></div><div class="row">'+status+' '+colorBadge+' <span class="muted">'+spec+'</span></div>'; $.playersList.appendChild(div); });
  }

  function renderResults(){ const res=state.results||[]; if(!res.length){ $.results.style.display='none'; $.results.innerHTML=''; return; } $.results.style.display='block'; $.results.innerHTML='<b>結果</b>'+ res.map(function(r){ return '<div class="row" style="justify-content:space-between"><span>'+r.rank+'. <b>'+r.player+'</b> <span class="muted">/ '+r.horse+'</span></span></div>'; }).join(''); }

  async function createLobby(){ const code=makeCode(); state.lobbyCode=code; state.isHost=true; $.hostBadge.textContent='ホスト'; if(state.net){ await R('lobbies/'+code).set({ createdAt: Date.now(), hostId: uid, started:false, trackLen:+$.trackLen.value, seed:0 }); subscribeLobby(code); } $.code.textContent=prettyCode(code); history.replaceState(null,'', location.pathname+'?room='+code); updateStartVisibility(); }
  async function joinLobby(code){ state.lobbyCode=code; $.hostBadge.textContent='参加者'; if(state.net){ subscribeLobby(code); await sleep(50); await upsertMe(); } $.code.textContent=prettyCode(code); history.replaceState(null,'', location.pathname+'?room='+code); updateStartVisibility(); }

  function subscribeLobby(code){ if(!state.net) return; R('lobbies/'+code).on('value', function(s){ var v=s.val()||{}; state.lobby=v; state.started=!!v.started; state.trackLen=v.trackLen||1200; $.trackLen.value=state.trackLen; $.vLen.textContent=String(state.trackLen); updateStartVisibility(); }); R('lobbies/'+code+'/players').on('value', function(s){ state.players=s.val()||{}; renderPlayers(); updateStartVisibility(); }); R('lobbies/'+code+'/state').on('value', function(s){ state.lastState=s.val()||null; }); R('lobbies/'+code+'/results').on('value', function(s){ state.results=s.val()||[]; renderResults(); }); }

  async function leaveLobby(){ if(state.net && state.lobbyCode){ await R('lobbies/'+state.lobbyCode+'/players/'+uid).remove(); } state.lobbyCode=null; state.isHost=false; state.players={}; state.started=false; state.results=[]; $.code.textContent='-'; $.who.textContent='未接続'; renderPlayers(); renderResults(); updateStartVisibility(); history.replaceState(null,'', location.pathname); }

  const sim = { horses:{}, order:[], finished:false, reset:function(){ this.horses={}; this.order=[]; this.finished=false; $.results.style.display='none'; $.count.textContent=''; }, setupFromPlayers:function(){ var list=Object.entries(state.players||{}); var lanes=[]; list.forEach(function(ent){ var id=ent[0], p=ent[1]; var h=p.horse||{}; sim.horses[id]={ id:id, name:p.name||id.slice(0,4), horse:h, x:0, v:0, s:h.stamina||200, done:false }; lanes.push({id:id, color:h.color||'#7dd3fc'}); }); state.lanes=lanes; }, start: async function(){ this.reset(); this.setupFromPlayers(); state.started=true; state.seed=Math.floor(Math.random()*1e9); if(state.net){ await R('lobbies/'+state.lobbyCode).update({ started:true, seed:state.seed, trackLen:+$.trackLen.value }); } updateStartVisibility(); await this.countdown(); if(state.isHost){ this.loopHost(); } }, countdown: async function(){ for(var i=3;i>0;i--){ $.count.textContent=String(i); await sleep(800);} $.count.textContent='GO!'; await sleep(400); $.count.textContent=''; }, physics:function(dt,noise){ var L=state.trackLen; for(var id in this.horses){ var H=this.horses[id]; if(H.done) continue; var spec=H.horse; var fatigue = clamp(1 - (H.s/Math.max(1,spec.stamina)),0,0.75); var accel = spec.accel*(1-0.5*fatigue) + (noise()-0.5)*spec.luck*0.6; H.v = clamp(H.v + accel*dt, 0, spec.topSpeed*(1-0.4*fatigue)); H.x += H.v*dt; H.s -= (0.015*H.v*H.v + 0.5*dt); if(H.x>=L){ H.x=L; H.done=true; this.order.push(id);} } }, loopHost: async function(){ var noise=randSeeded(state.seed); var L=state.trackLen; var last=performance.now(), sendAcc=0; var step=(now)=>{ var dt=Math.min(0.05,(now-last)/1000); last=now; this.physics(dt, noise); sendAcc+=dt; if(sendAcc>0.10 && state.net){ var pos={}; var vs={}; Object.values(this.horses).forEach(function(H){ pos[H.id]=Math.round(H.x); vs[H.id]=Math.round(H.v*100)/100; }); R('lobbies/'+state.lobbyCode+'/state').set({ t:Date.now(), L:L, pos:pos, vel:vs }); sendAcc=0; } drawRace(); if(this.order.length===Object.keys(this.horses).length){ this.finish(); return; } requestAnimationFrame(step); }; requestAnimationFrame(step); }, finish: async function(){ var out=this.order.map(function(id,idx){ var p=state.players[id]; return { rank:idx+1, id:id, player:(p&&p.name)||id, horse:(p&&p.horse&&p.horse.name)||'馬', color:(p&&p.horse&&p.horse.color)||'#7dd3fc' }; }); if(state.net){ await R('lobbies/'+state.lobbyCode+'/results').set(out); } state.results=out; renderResults(); } };

  function getPos(id){ if(state.isHost){ return sim.horses[id] && sim.horses[id].x || 0; } var st=state.lastState; if(!st||!st.pos) return 0; return st.pos[id]||0; }

  function setupCanvas(){ var c=$.canvas; var wrap=document.getElementById('canvasWrap'); var dpr=state.dpr; c.width=Math.floor(wrap.clientWidth*dpr); c.height=Math.floor(wrap.clientHeight*dpr); state.ctx=c.getContext('2d'); drawRace(); }
  window.addEventListener('resize', setupCanvas);

  function drawRace(){ var ctx=state.ctx; if(!ctx) return; var c=$.canvas; var dpr=state.dpr; ctx.clearRect(0,0,c.width,c.height); var lanes=state.lanes; var L=state.trackLen; if(!lanes.length){ ctx.fillStyle='rgba(255,255,255,.08)'; ctx.font=(18*dpr)+'px system-ui'; ctx.fillText('ロビーに参加して馬を登録してください',20*dpr,40*dpr); return; } var H=Math.max(60,Math.min(120,(c.height/lanes.length)-10)); var pad=30*dpr; var left=120*dpr; var right=c.width-20*dpr; var w=right-left; ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.lineWidth=2*dpr; ctx.setLineDash([8*dpr,8*dpr]); ctx.beginPath(); ctx.moveTo(left+w,pad); ctx.lineTo(left+w,c.height-pad); ctx.stroke(); ctx.setLineDash([]); ctx.font=(14*dpr)+'px ui-monospace, monospace'; ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillText(L+' m', left+w-40*dpr, pad-6*dpr); lanes.forEach(function(ln,i){ var y=pad+i*(H+8)+10; ctx.fillStyle='rgba(255,255,255,.03)'; ctx.fillRect(left-10*dpr,y,w+20*dpr,H); var pos=getPos(ln.id); var x=left + w * Math.max(0,Math.min(1,pos/L)); var p=state.players[ln.id]; ctx.fillStyle=(p && p.horse && p.horse.color) || '#7dd3fc'; ctx.fillRect(x-30*dpr, y+H*0.2, 60*dpr, H*0.6); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font=(16*dpr)+'px system-ui'; var label=((p&&p.name)||'??')+' / '+((p&&p.horse&&p.horse.name)||'馬'); ctx.fillText(label, 14*dpr, y + H*0.55); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.font=(12*dpr)+'px ui-monospace, monospace'; ctx.fillText(Math.round(pos)+'m', x-18*dpr, y + H*0.95); }); }

  setupCanvas();
  (function loopClient(){ var step=function(){ drawRace(); requestAnimationFrame(step); }; requestAnimationFrame(step); })();

  $.create.addEventListener('click', createLobby);
  $.joinBtn.addEventListener('click', function(){ var code=$.joinCode.value.toUpperCase().replace(/\s|-/g,''); if(code.length<4){ alert('ロビーコードが短すぎます'); return; } joinLobby(code); });
  $.save.addEventListener('click', upsertMe);
  $.ready.addEventListener('click', function(){ setReady(!state.me.ready); });
  $.start.addEventListener('click', async function(){ if(!state.isHost) return; if(!everyoneReady()){ alert('全員の準備がまだ完了していません'); return; } if(!(state.players[uid]&&state.players[uid].ready)){ alert('ホストも「準備OK」を押してください'); return; } await upsertMe(); sim.start(); });
  $.leave.addEventListener('click', leaveLobby);
  $.reset.addEventListener('click', async function(){ if(!state.isHost||!state.net||!state.lobbyCode) return; await R('lobbies/'+state.lobbyCode).update({ started:false, seed:0 }); await R('lobbies/'+state.lobbyCode+'/state').remove(); await R('lobbies/'+state.lobbyCode+'/results').remove(); state.started=false; state.results=[]; state.lastState=null; sim.reset(); drawRace(); updateStartVisibility(); });

  (function autoJoin(){ var q=new URLSearchParams(location.search); var room=(q.get('room')||'').toUpperCase(); if(room){ joinLobby(room);} })();

  document.addEventListener('contextmenu', function(e){ e.preventDefault(); alert('ヒント: Firebase設定を埋めるとオンライン対戦が有効になります。'); });
  </script>
</body>
</html>
