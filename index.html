<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>みんなで競馬 - ロビー&オンライン対戦</title>
  <style>
    :root{--bg:#0f1221;--panel:#171a2e;--text:#e6e7ff;--muted:#9aa0c7;--accent:#6cf;--accent2:#9f6cff;--ok:#6cff80;--warn:#ffd166;--bad:#ff6c9f;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1500px 800px at 20% -10%,rgba(159,108,255,.12),transparent 60%),radial-gradient(1200px 900px at 110% 20%,rgba(108,204,255,.10),transparent 60%),var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,sans-serif;display:grid;grid-template-rows:auto 1fr;gap:14px}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    header h1{margin:0;font-size:18px;letter-spacing:.4px}
    header .tag{font-size:12px;color:var(--muted)}
    main{display:grid;grid-template-columns:minmax(320px,700px) 1fr;gap:14px;padding:0 14px 14px}
    main.racing{grid-template-columns:1fr;height:100vh;padding:0;gap:0}
    main.racing #left{display:none}
    main.racing #right{height:100vh;width:100vw;border-radius:0;margin:0;padding:0}
    main.racing #canvasWrap{height:100vh;width:100vw;border-radius:0}
    #raceControls{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.8);border:1px solid var(--border);border-radius:12px;padding:8px;display:none;flex-direction:column;gap:6px;z-index:100;backdrop-filter:blur(10px);max-width:150px}
    #raceControls.show{display:flex}
    #raceControls button{padding:6px 10px;font-size:11px;min-width:120px}
    @media(max-width:1024px){main{grid-template-columns:1fr;padding:0 8px 8px}}
    @media(max-width:768px){header{padding:6px 8px}header h1{font-size:14px}.pad{padding:6px}.slider{flex-direction:column;gap:4px;text-align:center;padding:8px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px}input,button{padding:8px 10px;font-size:12px;min-height:44px}.card h2{font-size:12px}.adjustments-container{flex-direction:column;gap:6px}#raceControls{bottom:5px;right:5px;padding:6px;gap:4px;max-width:130px}#raceControls button{padding:5px 8px;font-size:10px;min-width:110px}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:15px;margin:0 0 10px 0;color:#dfe2ff}
    .pad{padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace,monospace}
    input,select,button{font:inherit;color:inherit}
    input[type="text"],input[type="number"],.readonly{width:100%;background:#0e1121;border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none;transition:.2s}
    input:focus{border-color:#6cf;box-shadow:0 0 0 3px rgba(108,204,255,.15)}
    button{background:linear-gradient(180deg,rgba(108,204,255,.25),rgba(108,204,255,.12));border:1px solid rgba(108,204,255,.45);color:#e8f6ff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent;border:1px solid var(--border)}
    button.danger{background:linear-gradient(180deg,rgba(255,108,159,.25),rgba(255,108,159,.12));border:1px solid rgba(255,108,159,.45)}
    .success{background:linear-gradient(180deg,rgba(108,255,128,.2),rgba(108,255,128,.12));border:1px solid rgba(108,255,128,.45)}
    .adjust-btn{width:32px;height:32px;min-height:32px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;background:linear-gradient(180deg,rgba(108,204,255,.15),rgba(108,204,255,.08));border:1px solid rgba(108,204,255,.3);border-radius:8px;cursor:pointer}
    .adjust-btn:hover{background:linear-gradient(180deg,rgba(108,204,255,.25),rgba(108,204,255,.15))}
    .adjust-btn:disabled{opacity:.3;cursor:not-allowed}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed var(--border);border-radius:999px;color:var(--muted)}
    .copy{cursor:pointer}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#0c1020;border:1px solid var(--border)}
    #canvasWrap{height:520px;position:relative;overflow:hidden}
    @media(max-width:768px){#canvasWrap{height:300px;aspect-ratio:4/3;width:100%}}
    canvas{width:100%;height:100%;background:repeating-linear-gradient(90deg,#111430,#111430 14px,#121535 14px,#121535 28px);object-fit:contain}
    #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    #overlay .big{font-size:72px;font-weight:700;text-shadow:0 10px 30px rgba(0,0,0,.4)}
    @media(max-width:768px){#overlay .big{font-size:48px}}
    #results{position:absolute;right:16px;top:16px;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:12px;padding:10px;max-width:300px}
    .slider{display:grid;grid-template-columns:140px 1fr 100px;gap:12px;align-items:center;min-height:44px}
    .adjustments-container{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:768px){.slider,.adjustments-container{display:flex;flex-direction:column;gap:6px}}
    input[type=range]{width:100%;-webkit-appearance:none;height:12px;cursor:pointer}
    input[type=range]::-webkit-slider-track{height:12px;background:linear-gradient(180deg,rgba(255,255,255,.15),rgba(255,255,255,.05));border:1px solid var(--border);border-radius:999px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:#e6e7ff;border:2px solid rgba(108,204,255,.8);margin-top:-8px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    .help{font-size:12px;color:var(--muted)}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .error{color:var(--bad)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}
    @keyframes titleGlow{from{text-shadow:2px 2px 4px rgba(0,0,0,0.5),0 0 10px rgba(255,215,0,0.3)}to{text-shadow:2px 2px 4px rgba(0,0,0,0.5),0 0 20px rgba(255,215,0,0.6)}}
    @keyframes slideIn{from{transform:translateX(-50px);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes messageSlide{from{transform:translateX(-50%)translateY(-20px);opacity:0}to{transform:translateX(-50%)translateY(0);opacity:1}}
    @keyframes messageSlideOut{from{transform:translateX(-50%)translateY(0);opacity:1}to{transform:translateX(-50%)translateY(-20px);opacity:0}}
  </style>
</head>
<body>
  <header>
    <h1>🏇 みんなで競馬 <span class="tag">ロビー & リアルタイム対戦</span></h1>
    <div id="onlineBadge" class="badge">オフライン（デモ）</div>
  </header>

  <main>
    <section class="card pad" id="left">
      <h2>ロビー</h2>
      <div class="col" id="lobbySection">
        <div class="col" id="initialSetup">
          <div class="grid2">
            <div>
              <label>プレイヤー名</label>
              <input type="text" id="playerName" placeholder="例：ピカソ" />
            </div>
            <div>
              <label>馬の名前</label>
              <input type="text" id="horseName" placeholder="例：サンダー" />
            </div>
          </div>
          <div class="row">
            <button id="createLobbyBtn">＋ ロビー作成</button>
            <div class="row">
              <input type="text" id="joinCode" placeholder="4桁コード" style="max-width:120px" />
              <button id="joinLobbyBtn" class="secondary">参加</button>
            </div>
          </div>
        </div>

        <div class="col" id="detailedSetup" style="display:none">
          <div class="row">
            <div class="pill">共有コード: <span id="lobbyCode" class="code">-</span> <span id="copyCode" class="copy">📋</span></div>
            <div class="pill">あなた: <span id="whoami">未接続</span></div>
            <div class="pill"><span id="hostBadge">参加者</span></div>
          </div>

          <div class="col" id="hostSettings" style="display:none">
            <h3 style="margin:8px 0 4px 0;font-size:14px">レース設定（ホストのみ）</h3>
            <div class="grid2">
              <div>
                <label>レース名</label>
                <input type="text" id="raceTitle" value="みんなで競馬" />
              </div>
              <div>
                <label>周回数</label>
                <input type="number" id="totalLaps" min="1" max="10" value="3" />
              </div>
            </div>
          </div>

          <div class="col">
            <h3 style="margin:8px 0 4px 0;font-size:14px">馬の能力調整</h3>
            <div style="text-align:center;font-size:16px;font-weight:bold;color:var(--accent);margin-bottom:8px">
              残りポイント: <span id="remainingPoints">150</span> / 150
            </div>
            <div class="adjustments-container">
              <div class="slider">
                <div>最高速度</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="adjust-btn" data-stat="sTop" data-delta="-1">−</button>
                  <input type="range" id="sTop" min="0" max="150" value="30">
                  <button class="adjust-btn" data-stat="sTop" data-delta="1">＋</button>
                </div>
                <div><span id="vTop">30</span> pt</div>
              </div>
              <div class="slider">
                <div>加速度</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="adjust-btn" data-stat="sAcc" data-delta="-1">−</button>
                  <input type="range" id="sAcc" min="0" max="150" value="30">
                  <button class="adjust-btn" data-stat="sAcc" data-delta="1">＋</button>
                </div>
                <div><span id="vAcc">30</span> pt</div>
              </div>
              <div class="slider">
                <div>スタミナ</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="adjust-btn" data-stat="sSta" data-delta="-1">−</button>
                  <input type="range" id="sSta" min="0" max="150" value="30">
                  <button class="adjust-btn" data-stat="sSta" data-delta="1">＋</button>
                </div>
                <div><span id="vSta">30</span> pt</div>
              </div>
              <div class="slider">
                <div>コーナー</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="adjust-btn" data-stat="sCorner" data-delta="-1">−</button>
                  <input type="range" id="sCorner" min="0" max="150" value="30">
                  <button class="adjust-btn" data-stat="sCorner" data-delta="1">＋</button>
                </div>
                <div><span id="vCorner">30</span> pt</div>
              </div>
              <div class="slider">
                <div>末脚</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="adjust-btn" data-stat="sFinish" data-delta="-1">−</button>
                  <input type="range" id="sFinish" min="0" max="150" value="30">
                  <button class="adjust-btn" data-stat="sFinish" data-delta="1">＋</button>
                </div>
                <div><span id="vFinish">30</span> pt</div>
              </div>
              <div class="slider">
                <div>馬の色</div>
                <input type="color" id="horseColor" value="#7dd3fc" />
                <div><span id="colorBox" style="display:inline-block;width:20px;height:20px;border-radius:4px;border:1px solid var(--border)"></span></div>
              </div>
            </div>

            <div class="row">
              <button id="saveHorseBtn">設定を保存</button>
              <button id="readyBtn" class="success" style="display:none">準備OK</button>
              <button id="startBtn" class="danger" style="display:none">ゲーム開始</button>
            </div>
            <div class="help">
              <div>・設定を保存してから準備OKを押してください。</div>
              <div>・レース毎に気分と配置が変わります。</div>
              <div>・バランス調整により接戦になりやすくなっています。</div>
            </div>
          </div>

          <div class="card pad" style="margin-top:8px">
            <h2>参加者一覧</h2>
            <div id="playersList" class="col"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card pad" id="right">
      <h2 id="raceHeader">レース</h2>
      <div id="canvasWrap" class="card">
        <canvas id="race"></canvas>
        <div id="overlay"><div class="big" id="countDown"></div></div>
        <div id="results" class="col" style="display:none"></div>
        <div id="raceControls">
          <button id="leaveBtn2" class="secondary">抜ける</button>
          <button id="resetBtn2" class="secondary">リセット</button>
          <button id="abortBtn2" class="danger">試合中断</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px" id="normalControls">
        <button id="leaveBtn" class="secondary">ロビーから抜ける</button>
        <button id="resetBtn" class="secondary">リセット（ホスト）</button>
        <button id="abortBtn" class="danger" style="display:none">試合中断（ホスト）</button>
      </div>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOqe--KczRP2fFCykd4iH1iaAVpyQTlSE",
    authDomain: "keiba-66344.firebaseapp.com",
    databaseURL: "https://keiba-66344-default-rtdb.firebaseio.com",
    projectId: "keiba-66344",
    storageBucket: "keiba-66344.firebasestorage.app",
    messagingSenderId: "636995719079",
    appId: "1:636995719079:web:dbb09c8860101a4c82b082"
  };

  const el=id=>document.getElementById(id);
  const uid=localStorage.getItem('uid')||(()=>{const v=crypto.getRandomValues(new Uint32Array(4));const s=[...v].map(x=>x.toString(16).padStart(8,'0')).join('');localStorage.setItem('uid',s);return s})();

  const state={
    net:false,db:null,me:{id:uid,name:"",horse:null,ready:false,saved:false},
    lobby:null,lobbyCode:null,isHost:false,players:{},
    started:false,seed:null,results:[],
    ctx:null,canvas:null,dpr:Math.min(2,window.devicePixelRatio||1),
    lanes:[],lastState:null,trackLen:400,totalLaps:3,raceTitle:"みんなで競馬",
    racePlayerIds:[],abandoned:null,loading:false,emptyLobbyTimeout:null,
    startPositions:{}
  };

  const $={
    code:el('lobbyCode'),who:el('whoami'),hostBadge:el('hostBadge'),onlineBadge:el('onlineBadge'),
    create:el('createLobbyBtn'),joinBtn:el('joinLobbyBtn'),joinCode:el('joinCode'),copy:el('copyCode'),
    pName:el('playerName'),hName:el('horseName'),
    sTop:el('sTop'),sAcc:el('sAcc'),sSta:el('sSta'),sCorner:el('sCorner'),sFinish:el('sFinish'),hColor:el('horseColor'),
    vTop:el('vTop'),vAcc:el('vAcc'),vSta:el('vSta'),vCorner:el('vCorner'),vFinish:el('vFinish'),colorBox:el('colorBox'),
    save:el('saveHorseBtn'),ready:el('readyBtn'),start:el('startBtn'),playersList:el('playersList'),
    canvas:el('race'),overlay:el('overlay'),count:el('countDown'),results:el('results'),
    leave:el('leaveBtn'),reset:el('resetBtn'),abort:el('abortBtn'),
    remainingPoints:el('remainingPoints'),raceTitle:el('raceTitle'),totalLaps:el('totalLaps'),
    hostSettings:el('hostSettings'),raceHeader:el('raceHeader')
  };

  function syncLabels(){
    ['Top','Acc','Sta','Corner','Finish'].forEach(s=>{
      $['v'+s].textContent=(+$['s'+s].value).toFixed(0);
    });
    $.colorBox.style.background=$.hColor.value;
    
    const totalUsed=[$.sTop,$.sAcc,$.sSta,$.sCorner,$.sFinish].reduce((sum,e)=>sum+(+e.value),0);
    const remaining=150-totalUsed;
    
    $.remainingPoints.textContent=remaining;
    $.remainingPoints.style.color=remaining<0?'var(--bad)':remaining===0?'var(--ok)':'var(--accent)';
    $.save.disabled=remaining!==0||state.started;
    $.save.style.opacity=remaining!==0?'0.5':'1';
    
    if(!state.loading){
      state.me.saved=false;
      updateReadyButtonState();
    }
  }

  function updateReadyButtonState(){
    if($.ready){
      const canReady=state.me.saved&&!state.started;
      $.ready.disabled=!canReady;
      $.ready.style.opacity=canReady?'1':'0.5';
    }
  }

  [$.sTop,$.sAcc,$.sSta,$.sCorner,$.sFinish,$.hColor].forEach(s=>{
    if(s)s.addEventListener('input',()=>{
      if(!state.loading)state.me.saved=false;
      syncLabels();
      if(state.me.ready)setReady(false);
    });
  });

  document.addEventListener('click',e=>{
    if(e.target.classList.contains('adjust-btn')){
      e.preventDefault();
      if(state.started)return;
      const targetId=e.target.dataset.stat;
      const delta=parseInt(e.target.dataset.delta);
      const targetEl=el(targetId);
      if(targetEl){
        const newVal=Math.max(0,Math.min(150,parseInt(targetEl.value)+delta));
        if(newVal!==parseInt(targetEl.value)){
          targetEl.value=newVal;
          if(!state.loading)state.me.saved=false;
          syncLabels();
          if(state.me.ready)setReady(false);
        }
      }
    }
  });

  syncLabels();

  function initFirebase(){
    if(!window.firebase||!firebaseConfig.apiKey){$.onlineBadge.textContent='オフライン（デモ）';return;}
    try{
      firebase.initializeApp(firebaseConfig);
      state.db=firebase.database();
      state.net=true;
      $.onlineBadge.textContent='オンライン有効';
      startLobbyCleanupScheduler();
    }catch(e){$.onlineBadge.textContent='オフライン';}
  }
  initFirebase();

  const sleep=ms=>new Promise(r=>setTimeout(r,ms));
  const R=path=>state.db?state.db.ref(path):null;
  const makeCode=()=>String(Math.floor(Math.random()*10000)).padStart(4,'0');
  const randSeeded=seed=>{let s=seed>>>0;return()=>{s=(s*1664525+1013904223)>>>0;return s/0x100000000;}};

  function checkAndCleanupLobby(code,players){
    if(!state.net||!code)return;
    const playerCount=Object.keys(players).length;
    if(playerCount===0){
      setTimeout(async()=>{
        try{
          const snapshot=await R('lobbies/'+code+'/players').once('value');
          const currentPlayers=snapshot.val()||{};
          if(Object.keys(currentPlayers).length===0){
            await R('lobbies/'+code).remove();
            if(state.lobbyCode===code)resetLobbyState();
          }
        }catch(e){}
      },3000);
    }
  }

  function startLobbyCleanupScheduler(){
    if(!state.net)return;
    setInterval(async()=>{
      try{
        const snapshot=await R('lobbies').once('value');
        const lobbies=snapshot.val()||{};
        const now=Date.now();
        const thirtyMinutesAgo=now-(30*60*1000);
        for(const[lobbyCode,lobbyData]of Object.entries(lobbies)){
          if(!lobbyData){await R('lobbies/'+lobbyCode).remove();continue;}
          const createdAt=lobbyData.createdAt||0;
          const players=lobbyData.players||{};
          if(createdAt<thirtyMinutesAgo&&Object.keys(players).length===0){
            await R('lobbies/'+lobbyCode).remove();
          }
        }
      }catch(e){}
    },2*60*1000);
  }

  function generateRandomMood(){
    const moods=[
      {name:'絶好調',emoji:'😤',multiplier:1.15,color:'#ff6b6b'},
      {name:'好調',emoji:'😊',multiplier:1.08,color:'#4ecdc4'},
      {name:'普通',emoji:'😐',multiplier:1.0,color:'#95a5a6'},
      {name:'不調',emoji:'😔',multiplier:0.92,color:'#f39c12'},
      {name:'絶不調',emoji:'😩',multiplier:0.85,color:'#9b59b6'}
    ];
    return moods[Math.floor(Math.random()*moods.length)];
  }

  function showMessage(text,type='info'){
    const existingMessage=el('gameMessage');
    if(existingMessage)existingMessage.remove();
    const message=document.createElement('div');
    message.id='gameMessage';
    message.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;font-weight:bold;font-size:16px;z-index:1000;animation:messageSlide 0.3s ease-out;box-shadow:0 4px 12px rgba(0,0,0,0.3);`;
    if(type==='success'){
      message.style.background='linear-gradient(135deg,#4CAF50,#45a049)';
      message.style.color='white';
    }else{
      message.style.background='linear-gradient(135deg,#2196F3,#1976D2)';
      message.style.color='white';
    }
    message.textContent=text;
    document.body.appendChild(message);
    setTimeout(()=>{
      if(message&&message.parentNode){
        message.style.animation='messageSlideOut 0.3s ease-in';
        setTimeout(()=>message.remove(),300);
      }
    },3000);
  }

  async function showRaceTitle(){
    const overlay=document.createElement('div');
    overlay.style.cssText=`position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.5s ease-out;`;
    const title=document.createElement('div');
    title.style.cssText=`font-size:64px;font-weight:bold;color:#FFD700;text-shadow:2px 2px 4px rgba(0,0,0,0.5);margin-bottom:20px;text-align:center;animation:titleGlow 2s ease-in-out infinite alternate;`;
    title.textContent=state.raceTitle||'みんなで競馬';
    const subtitle=document.createElement('div');
    subtitle.style.cssText=`font-size:24px;color:#ffffff;text-align:center;text-shadow:1px 1px 2px rgba(0,0,0,0.5);`;
    subtitle.textContent=`${state.totalLaps}周制レース`;
    overlay.appendChild(title);
    overlay.appendChild(subtitle);
    document.body.appendChild(overlay);
    await sleep(2500);
    overlay.style.animation='fadeOut 0.5s ease-in';
    setTimeout(()=>overlay.remove(),500);
  }

  async function showStartingLineup(){
    const overlay=document.createElement('div');
    overlay.style.cssText=`position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.5s ease-out;overflow-y:auto;padding:20px;`;
    const title=document.createElement('div');
    title.style.cssText=`font-size:48px;font-weight:bold;color:#FFD700;text-shadow:2px 2px 4px rgba(0,0,0,0.5);margin-bottom:40px;text-align:center;animation:titleGlow 2s ease-in-out infinite alternate;`;
    title.textContent='🐎 今回の出走馬たち！ 🐎';
    const horseList=document.createElement('div');
    horseList.style.cssText=`display:flex;flex-direction:column;gap:20px;max-width:600px;width:90%;`;
    Object.entries(state.players||{}).forEach(([id,player],index)=>{
      const horseCard=document.createElement('div');
      horseCard.style.cssText=`background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border:2px solid ${player.horse?.color||'#7dd3fc'};border-radius:15px;padding:20px;display:flex;align-items:center;gap:20px;animation:slideIn 0.5s ease-out ${index*0.2}s both;backdrop-filter:blur(10px);`;
      const colorBox=document.createElement('div');
      colorBox.style.cssText=`width:40px;height:40px;border-radius:50%;background:${player.horse?.color||'#7dd3fc'};border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);`;
      const textInfo=document.createElement('div');
      textInfo.style.cssText=`flex:1;color:white;`;
      const playerName=document.createElement('div');
      playerName.style.cssText=`font-size:24px;font-weight:bold;margin-bottom:5px;`;
      playerName.textContent=player.name||'謎のプレイヤー';
      const horseName=document.createElement('div');
      horseName.style.cssText=`font-size:18px;color:#FFD700;margin-bottom:8px;`;
      horseName.textContent=`🐎 ${player.horse?.name||'名無し'}`;
      textInfo.appendChild(playerName);
      textInfo.appendChild(horseName);
      if(player.horse?.mood){
        const moodInfo=document.createElement('div');
        moodInfo.style.cssText=`font-size:16px;color:${player.horse.mood.color};`;
        moodInfo.textContent=`${player.horse.mood.emoji} ${player.horse.mood.name}`;
        textInfo.appendChild(moodInfo);
      }
      horseCard.appendChild(colorBox);
      horseCard.appendChild(textInfo);
      horseList.appendChild(horseCard);
    });
    overlay.appendChild(title);
    overlay.appendChild(horseList);
    document.body.appendChild(overlay);
    await sleep(3000);
    overlay.style.animation='fadeOut 0.5s ease-in';
    setTimeout(()=>overlay.remove(),500);
