<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã¿ã‚“ãªã§ç«¶é¦¬ - ãƒ­ãƒ“ãƒ¼&ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</title>
  <style>
    :root{
      --bg:#0f1221; --panel:#171a2e; --text:#e6e7ff; --muted:#9aa0c7; --accent:#6cf; --accent2:#9f6cff; --ok:#6cff80; --warn:#ffd166; --bad:#ff6c9f;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background:radial-gradient(1500px 800px at 20% -10%, rgba(159,108,255,.12), transparent 60%),
      radial-gradient(1200px 900px at 110% 20%, rgba(108,204,255,.10), transparent 60%), var(--bg);
      color:var(--text); font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      display:grid; grid-template-rows:auto 1fr; gap:14px;
    }
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); backdrop-filter: blur(6px);}    
    header h1{margin:0; font-size:18px; letter-spacing:.4px;}
    header .tag{font-size:12px; color:var(--muted)}
    main{display:grid; grid-template-columns:400px 1fr; gap:14px; padding:0 14px 14px;}
    @media (max-width:1024px){ main{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .card h2{font-size:15px; margin:0 0 10px 0; letter-spacing:.3px; color:#dfe2ff}
    .pad{padding:16px}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    input, select, button{font:inherit; color:inherit}
    input[type="text"], input[type="number"], .readonly{
      width:100%; background:#0e1121; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
      outline:none; transition:.2s border-color, .2s box-shadow;
    }
    input[type="text"]:focus, input[type="number"]:focus{border-color:#6cf; box-shadow:0 0 0 3px rgba(108,204,255,.15)}
    .readonly{opacity:.8}
    button{
      background:linear-gradient(180deg, rgba(108,204,255,.25), rgba(108,204,255,.12));
      border:1px solid rgba(108,204,255,.45); color:#e8f6ff; padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s transform ease, .2s filter;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent; border:1px solid var(--border);}
    $1

    .success{background:linear-gradient(180deg, rgba(108,255,128,.2), rgba(108,255,128,.12)); border:1px solid rgba(108,255,128,.45)}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed var(--border); border-radius:999px; color:var(--muted)}
    .copy{cursor:pointer;}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#0c1020; border:1px solid var(--border)}

    #canvasWrap{height:520px; position:relative}
    canvas{width:100%; height:100%; background:repeating-linear-gradient(90deg, #111430, #111430 14px, #121535 14px, #121535 28px);}    
    #overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    #overlay .big{font-size:72px; font-weight:700; text-shadow:0 10px 30px rgba(0,0,0,.4)}
    #results{position:absolute; right:16px; top:16px; background:rgba(0,0,0,.4); border:1px solid var(--border); border-radius:12px; padding:10px; max-width:300px}

    .slider{display:grid; grid-template-columns:100px 1fr 60px; gap:8px; align-items:center}
    input[type=range]{width:100%}
    .colorBox{width:36px; height:24px; border-radius:6px; border:1px solid var(--border)}

    .help{font-size:12px; color:var(--muted)}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .error{color:var(--bad)}
    .footerNote{font-size:12px; color:var(--muted); padding:0 18px 18px}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‡ ã¿ã‚“ãªã§ç«¶é¦¬ <span class="tag">ãƒ­ãƒ“ãƒ¼ & ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦</span></h1>
    <div id="onlineBadge" class="badge">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ¢ï¼‰</div>
  </header>

  <main>
    <!-- å·¦ï¼šãƒ­ãƒ“ãƒ¼/è¨­å®š -->
    <section class="card pad" id="left">
      <h2>ãƒ­ãƒ“ãƒ¼</h2>
      <div class="col" id="lobbySection">
        <div class="grid2">
          <button id="createLobbyBtn">ï¼‹ ãƒ­ãƒ“ãƒ¼ä½œæˆ</button>
          <div class="row">
            <input type="text" id="joinCode" placeholder="ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
            <button id="joinLobbyBtn" class="secondary">å‚åŠ </button>
          </div>
        </div>
        <div class="row">
          <div class="pill">å…±æœ‰ã‚³ãƒ¼ãƒ‰: <span id="lobbyCode" class="code">-</span> <span id="copyCode" class="copy">ğŸ“‹</span></div>
          <div class="pill">ã‚ãªãŸ: <span id="whoami">æœªæ¥ç¶š</span></div>
          <div class="pill"><span id="hostBadge">å‚åŠ è€…</span></div>
        </div>

        <div class="col" id="nameHorse">
          <div class="grid2">
            <div>
              <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
              <input type="text" id="playerName" placeholder="ä¾‹ï¼šãƒ”ã‚«ã‚½" />
            </div>
            <div>
              <label>é¦¬ã®åå‰</label>
              <input type="text" id="horseName" placeholder="ä¾‹ï¼šã‚µãƒ³ãƒ€ãƒ¼" />
            </div>
          </div>

          <div class="grid3">
            <div class="slider">
              <div>æœ€é«˜é€Ÿåº¦</div>
              <input type=\"range\" id=\"sTop\" min=\"1\" max=\"50\" step=\"0.1\" value=\"14\">
              <div><span id="vTop">14.0</span> m/s</div>
            </div>
            <div class="slider">
              <div>åŠ é€Ÿåº¦</div>
              <input type=\"range\" id=\"sAcc\" min=\"0.1\" max=\"10\" step=\"0.01\" value=\"2.2\">
              <div><span id="vAcc">2.20</span> m/sÂ²</div>
            </div>
            <div class="slider">
              <div>ã‚¹ã‚¿ãƒŸãƒŠ</div>
              <input type=\"range\" id=\"sSta\" min=\"10\" max=\"5000\" step=\"1\" value=\"200\">
              <div><span id="vSta">200</span> SP</div>
            </div>
          </div>
          <div class="grid3">
            <div class="slider">
              <div>é‹ï¼ˆã‚†ã‚‰ãï¼‰</div>
              <input type=\"range\" id=\"sLuck\" min=\"0\" max=\"3\" step=\"0.01\" value=\"0.5\">
              <div><span id="vLuck">0.50</span></div>
            </div>
            <div class="slider">
              <div>è‰²</div>
              <input type="color" id="horseColor" value="#7dd3fc" />
              <div><span class="colorBox" id="colorBox"></span></div>
            </div>
            <div class="slider">
              <div>è·é›¢</div>
              <input type=\"range\" id=\"trackLen\" min=\"200\" max=\"5000\" step=\"10\" value=\"1200\">
              <div><span id="vLen">1200</span> m</div>
            </div>
          </div>

          <div class=\"row\">
            <button id=\"saveHorseBtn\">è¨­å®šã‚’ä¿å­˜ / æ›´æ–°</button>
            <button id=\"readyBtn\" class=\"success\">æº–å‚™OK</button>
            <button id=\"startBtn\" class=\"danger\" style=\"display:none\">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰</button>
          </div>

          <div class="help">
            <div>ãƒ»ãƒ­ãƒ“ãƒ¼ä½œæˆè€…ãŒãƒ›ã‚¹ãƒˆã§ã™ã€‚å‚åŠ è€…ã¯ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã§å‚åŠ ã§ãã¾ã™ã€‚</div>
            <div>ãƒ»é¦¬ã®æ€§èƒ½ã¯è‡ªç”±ã«èª¿æ•´ã§ãã¾ã™ï¼ˆç¯„å›²å†…ï¼‰ã€‚ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã¨ãƒ¬ãƒ¼ã‚¹ãŒå§‹ã¾ã‚Šã¾ã™ã€‚</div>
          </div>
        </div>

        <div class="card pad" style="margin-top:10px">
          <h2>å‚åŠ è€…ä¸€è¦§</h2>
          <div id="playersList" class="col"></div>
        </div>

        <div class="card pad" style="margin-top:10px">
          <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æœ‰åŠ¹åŒ–ï¼ˆå¿…é ˆï¼‰</h2>
          <div class="help">ç•°ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ & Wiâ€‘Fi ã‹ã‚‰å‚åŠ ã™ã‚‹ã«ã¯ã€ä¸‹è¨˜ã® <b>Firebase è¨­å®š</b> ã‚’åŸ‹ã‚ã¦ãã ã•ã„ã€‚æœªè¨­å®šã®å ´åˆã¯åŒä¸€ç«¯æœ«ã®ãƒ‡ãƒ¢è¡¨ç¤ºã®ã¿ã«ãªã‚Šã¾ã™ã€‚</div>
          <details>
            <summary>Firebase è¨­å®šã‚’é–‹ã</summary>
<pre class="code" id="cfgPreview"></pre>
            <div class="help">1) Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ â†’ 2) Realtime Database ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ«æ¨å¥¨ï¼‰â†’ 3) èªè¨¼ã§ã€ŒåŒ¿åã€ã‚’æœ‰åŠ¹ â†’ 4) ä¸‹ã® <code>firebaseConfig</code> ã‚’åŸ‹ã‚ã¦ä¿å­˜ã€‚<br>å…±æœ‰ç›¸æ‰‹ã¯åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã ã‘ã§å‚åŠ ã§ãã¾ã™ï¼ˆãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ã§åŒæœŸï¼‰ã€‚</div>
          </details>
        </div>
      </div>
    </section>

    <!-- å³ï¼šãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
    <section class="card pad" id="right">
      <h2>ãƒ¬ãƒ¼ã‚¹</h2>
      <div id="canvasWrap" class="card">
        <canvas id="race"></canvas>
        <div id="overlay"><div class="big" id="countDown"></div></div>
        <div id="results" class="col" style="display:none"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="leaveBtn" class="secondary">ãƒ­ãƒ“ãƒ¼ã‹ã‚‰æŠœã‘ã‚‹</button>
        <button id="resetBtn" class="secondary">ãƒ¬ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ›ã‚¹ãƒˆï¼‰</button>
      </div>
      <div class="help" style="margin-top:8px">æç”»ãŒé‡ã„å ´åˆã¯ã‚¿ãƒ–ã‚’ï¼‘ã¤ã ã‘é–‹ã„ã¦ãã ã•ã„ã€‚ãƒ¬ãƒ¼ã‚¹ã¯ãƒ›ã‚¹ãƒˆç«¯æœ«ã§è¨ˆç®—ã—ã€ä»–ç«¯æœ«ã¸é…ä¿¡ã—ã¾ã™ã€‚</div>
    </section>
  </main>

  <div class="footerNote">
    â€» ã“ã®HTMLã¯ 1ãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã—ã¾ã™ã€‚Firebase ã®è¨­å®šã‚’åŸ‹ã‚ã‚‹ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸãŒæœ‰åŠ¹ã«ãªã‚Šã€èª°ã§ã‚‚ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ã§å‚åŠ ã§ãã¾ã™ã€‚
  </div>

  <!-- Firebaseï¼ˆä»»æ„ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ========= ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼šã“ã“ã« Firebase è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ =========
  const firebaseConfig = {
    apiKey: "AIzaSyBOqe--KczRP2fFCykd4iH1iaAVpyQTlSE",
    authDomain: "keiba-66344.firebaseapp.com",
    databaseURL: "https://keiba-66344-default-rtdb.firebaseio.com",
    projectId: "keiba-66344",
    storageBucket: "keiba-66344.firebasestorage.app",
    messagingSenderId: "636995719079",
    appId: "1:636995719079:web:dbb09c8860101a4c82b082",
    measurementId: "G-QSPM8PBTTH"
  };
  // ============================================================

  const el = (id)=>document.getElementById(id);
  const uid = localStorage.getItem('uid') || (()=>{const v=crypto.getRandomValues(new Uint32Array(4)); const s=[...v].map(x=>x.toString(16).padStart(8,'0')).join(''); localStorage.setItem('uid', s); return s;})()
  const state = {
    net:false, app:null, db:null, me:{ id:uid, name:"", horse:null },
    lobby:null, lobbyCode:null, isHost:false, players:{},
    started:false, seed:null, results:[],
    // ãƒ¬ãƒ¼ã‚¹æç”»
    ctx:null, canvas:null, dpr:Math.min(2, window.devicePixelRatio||1),
    lanes:[], lastTick:0, lastState:null, interp:{t:0, a:null, b:null},
    trackLen:1200, // m
  };

  // UI è¦ç´ å‚ç…§
  const $ = {
    code: el('lobbyCode'), who: el('whoami'), hostBadge: el('hostBadge'), onlineBadge: el('onlineBadge'),
    create: el('createLobbyBtn'), joinBtn: el('joinLobbyBtn'), joinCode: el('joinCode'), copy: el('copyCode'),
    pName: el('playerName'), hName: el('horseName'),
    sTop: el('sTop'), sAcc: el('sAcc'), sSta: el('sSta'), sLuck: el('sLuck'), hColor: el('horseColor'),
    vTop: el('vTop'), vAcc: el('vAcc'), vSta: el('vSta'), vLuck: el('vLuck'), colorBox: el('colorBox'),
    save: el('saveHorseBtn'), ready: el('readyBtn'), start: el('startBtn'), playersList: el('playersList'),
    trackLen: el('trackLen'), vLen: el('vLen'),
    canvas: el('race'), overlay: el('overlay'), count: el('countDown'), results: el('results'),
    leave: el('leaveBtn'), reset: el('resetBtn'), cfgPreview: el('cfgPreview'),
  };

  // å€¤è¡¨ç¤º
  function syncLabels(){
    $.vTop.textContent = (+$.sTop.value).toFixed(1);
    $.vAcc.textContent = (+$.sAcc.value).toFixed(2);
    $.vSta.textContent = (+$.sSta.value).toFixed(0);
    $.vLuck.textContent = (+$.sLuck.value).toFixed(2);
    $.vLen.textContent = (+$.trackLen.value).toFixed(0);
    $.colorBox.style.background = $.hColor.value;
  }
  [$.sTop,$.sAcc,$.sSta,$.sLuck,$.hColor,$.trackLen].forEach(i=>i.addEventListener('input', ()=>{ syncLabels(); if(state.me.ready) setReady(false); }));
  syncLabels();

  // Firebase åˆæœŸåŒ–ï¼ˆè¨­å®šãŒåŸ‹ã¾ã£ã¦ã„ã‚Œã°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ONï¼‰
  function initFirebase(){
    // Firebase SDKãŒèª­ã¿è¾¼ã‚ãªã„/ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
    if (typeof window.firebase === 'undefined') {
      $.onlineBadge.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆSDKæœªèª­è¾¼ï¼‰';
      $.onlineBadge.style.background='linear-gradient(180deg, rgba(255,209,102,.2), rgba(255,209,102,.12))';
      $.onlineBadge.style.border='1px solid rgba(255,209,102,.45)';
      $.cfgPreview.textContent = 'Firebaseã®CDNãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã®åºƒå‘Š/ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚OFF
ãƒ»åˆ¥ã‚¿ãƒ–/åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§ã“ã®HTMLã‚’é–‹ã
ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç¢ºèª
ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚è¨­å®šãŒæƒãˆã°è‡ªå‹•ã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ã€‚';
      return; // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ»ãƒ‡ãƒ¢ã¨ã—ã¦ç¶™ç¶š
    }
    if(!firebaseConfig || !firebaseConfig.apiKey){
      $.onlineBadge.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ¢ï¼‰';
      $.onlineBadge.style.background='linear-gradient(180deg, rgba(255,209,102,.2), rgba(255,209,102,.12))';
      $.onlineBadge.style.border='1px solid rgba(255,209,102,.45)';
      $.cfgPreview.textContent = 'const firebaseConfig = {
  apiKey: "<APIã‚­ãƒ¼>",
  authDomain: "<xxx>.firebaseapp.com",
  databaseURL: "https://<xxx>-default-rtdb.<region>.firebasedatabase.app",
  projectId: "<ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>",
  storageBucket: "<xxx>.appspot.com",
  messagingSenderId: "<æ•°å­—>",
  appId: "<appId>"
};';
      return;
    }
    try{
      state.app = firebase.initializeApp(firebaseConfig);
      state.db = firebase.database();
      state.net = true;
      firebase.auth().signInAnonymously().catch(console.error);
      $.onlineBadge.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æœ‰åŠ¹ï¼ˆFirebaseï¼‰';
      $.onlineBadge.style.background='linear-gradient(180deg, rgba(108,204,255,.25), rgba(108,204,255,.12))';
      $.onlineBadge.style.border='1px solid rgba(108,204,255,.45)';
    }catch(e){
      console.error(e);
      $.onlineBadge.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼‰';
      $.onlineBadge.style.background='linear-gradient(180deg, rgba(255,209,102,.2), rgba(255,209,102,.12))';
      $.onlineBadge.style.border='1px solid rgba(255,209,102,.45)';
    }
  }
  initFirebase();

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  const randSeeded = (seed)=>{ let s = seed>>>0; return ()=>{ s = (s*1664525 + 1013904223)>>>0; return s/0x100000000; } };
  const clamp=(n,min,max)=> Math.max(min, Math.min(max,n));
  const prettyCode = c => c ? c.replace(/(.{3})/g,'$1 ').trim() : '-';

  // ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰
  function makeCode(){
    const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let s=''; for(let i=0;i<5;i++){ s += chars[Math.floor(Math.random()*chars.length)]; }
    return s;
  }

  // DB å‚ç…§
  const R = (path)=> state.db.ref(path);

  // å‚åŠ è€…UIåæ˜ 
  function renderPlayers(){
    $.playersList.innerHTML = '';
    const keys = Object.keys(state.players||{});
    if(keys.length===0){ $.playersList.innerHTML = '<div class="muted">ï¼ˆã¾ã å‚åŠ è€…ã¯ã„ã¾ã›ã‚“ï¼‰</div>'; return; }
    keys.forEach(id=>{
      const p = state.players[id];
      if(!p) return;
      const div = document.createElement('div');
      div.className='row';
      div.style.justifyContent='space-between';
      div.innerHTML = `<div><b>${p.name||'åç„¡ã—'}</b> <span class="muted">/ ${p.horse?.name||'é¦¬'}</span></div>
        <div class="row"><span class="badge" style="border-color:${p.horse?.color||'#888'}">${p.horse?.color||'#888'}</span>
        <span class="muted">V${p.horse?.topSpeed||'?'} A${p.horse?.accel||'?'} S${p.horse?.stamina||'?'} L${p.horse?.luck||'?'} </span></div>`;
      $.playersList.appendChild(div);
      const row = div.querySelector('.row'); if(row){ row.insertAdjacentHTML('afterbegin', (p.ready ? '<span class=\"badge\" style=\"border-color:#6cff80\">READY</span>' : '<span class=\"badge\" style=\"border-color:#ffd166\">å¾…æ©Ÿ</span>')); }
    });
  }

  // ãƒ­ãƒ“ãƒ¼ä½œæˆ
  async function createLobby(){
    const code = makeCode();
    state.lobbyCode = code; state.isHost = true; updateHeader();
    if(state.net){
      const now = Date.now();
      await R(`lobbies/${code}`).set({
        createdAt: now,
        hostId: uid,
        started: false,
        trackLen: +$.trackLen.value,
        seed: 0
      });
      subscribeLobby(code);
    }
    $.code.textContent = prettyCode(code);
    history.replaceState(null,'', location.pathname + `?room=${code}`);
    updateStartVisibility();
  }`).set({
        createdAt: now,
        hostId: uid,
        started: false,
        trackLen: +$.trackLen.value,
        seed: 0
      });
      subscribeLobby(code);
    }
    $.code.textContent = prettyCode(code);
    history.replaceState(null,'', location.pathname + `?room=${code}`);
    $.start.disabled = false;
  }

  // ãƒ­ãƒ“ãƒ¼å‚åŠ 
  async function joinLobby(code){
    state.lobbyCode = code; updateHeader();
    if(state.net){
      subscribeLobby(code);
      await sleep(50);
      await upsertMe();
    }
    $.code.textContent = prettyCode(code);
    history.replaceState(null,'', location.pathname + `?room=${code}`);
    updateStartVisibility();
  }
    $.code.textContent = prettyCode(code);
    history.replaceState(null,'', location.pathname + `?room=${code}`);
  }

  // è‡ªåˆ†ã®æƒ…å ±ã‚’ä¿å­˜
  async function upsertMe(){
    const name = $.pName.value.trim() || `Player-${uid.slice(0,4).toUpperCase()}`;
    const horse = collectHorse();
    state.me.name = name; state.me.horse = horse; $.who.textContent = name;
    if(state.net && state.lobbyCode){
      await R(`lobbies/${state.lobbyCode}/players/${uid}`).set({
        name, horse, updatedAt: Date.now(), ready: state.me.ready||false
      });
    } else {
      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚æœ€ä½é™UIãŒå‹•ãã‚ˆã†ã«ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’åæ˜ 
      state.players[uid] = {name, horse, ready: state.me.ready||false};
      renderPlayers(); updateStartVisibility();
    }
  }
  }

  // ãƒ­ãƒ“ãƒ¼è³¼èª­
  function subscribeLobby(code){
    if(!state.net) return;
    R(`lobbies/${code}`).on('value', snap=>{
      const v = snap.val()||{}; state.lobby = v; state.started = !!v.started; state.seed = v.seed||0; state.trackLen = v.trackLen||1200;
      $.trackLen.value = state.trackLen; syncLabels();
      updateStartVisibility();
    });
    R(`lobbies/${code}/players`).on('value', snap=>{ state.players = snap.val()||{}; renderPlayers(); updateStartVisibility(); });
    R(`lobbies/${code}/state`).on('value', snap=>{ state.lastState = snap.val()||null; });
    R(`lobbies/${code}/results`).on('value', snap=>{ state.results = snap.val()||[]; renderResults(); });
  }

  // é€€å®¤
  async function leaveLobby(){
    if(state.net && state.lobbyCode){
      await R(`lobbies/${state.lobbyCode}/players/${uid}`).remove();
    }
    state.lobbyCode=null; state.isHost=false; state.players={}; state.started=false; state.results=[];
    $.code.textContent='-'; $.who.textContent='æœªæ¥ç¶š'; renderPlayers(); renderResults(); updateStartVisibility();
    history.replaceState(null,'', location.pathname);
  }/players/${uid}`).remove();
    }
    state.lobbyCode=null; state.isHost=false; state.players={}; state.started=false; state.results=[];
    $.code.textContent='-'; $.who.textContent='æœªæ¥ç¶š'; $.start.disabled=true; renderPlayers(); renderResults();
    history.replaceState(null,'', location.pathname);
  }

  // ãƒ˜ãƒƒãƒ€æ›´æ–°
  function updateHeader(){
    el('hostBadge').textContent = state.isHost? 'ãƒ›ã‚¹ãƒˆ' : 'å‚åŠ è€…';
  }

  // é¦¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åé›†
  function collectHorse(){
    return {
      name: $.hName.value.trim() || 'ãƒãƒ¼ãƒãƒ«',
      color: $.hColor.value,
      topSpeed: +(+$.sTop.value).toFixed(2),
      accel: +(+$.sAcc.value).toFixed(2),
      stamina: +(+$.sSta.value).toFixed(0),
      luck: +(+$.sLuck.value).toFixed(2),
    };
  }

  // æº–å‚™ãƒ•ãƒ©ã‚° & ã‚¹ã‚¿ãƒ¼ãƒˆå¯å¦
  function everyoneReady(){
    const ps = state.players || {};
    const ids = Object.keys(ps);
    if(ids.length===0) return false;
    return ids.every(id => ps[id]?.ready);
  }
  function updateStartVisibility(){
    const show = state.isHost && everyoneReady() && !state.started;
    $.start.style.display = show ? 'inline-block' : 'none';
  }
  function updateReadyButton(){
    if(!$.ready) return;
    const on = !!state.me.ready;
    $.ready.textContent = on ? 'æº–å‚™è§£é™¤' : 'æº–å‚™OK';
    $.ready.className = on ? 'secondary' : 'success';
  }
  async function setReady(val){
    state.me.ready = !!val;
    updateReadyButton();
    if(state.net && state.lobbyCode){
      await R(`lobbies/${state.lobbyCode}/players/${uid}`).update({ready: state.me.ready, updatedAt: Date.now()});
    }
    updateStartVisibility();
  }

  // === ãƒ¬ãƒ¼ã‚¹ã‚·ãƒŸãƒ¥ ===
  const sim = {
    horses:{}, order:[], finished:false, countdown:0,
    reset(){ this.horses={}; this.order=[]; this.finished=false; this.countdown=3; $.results.style.display='none'; $.count.textContent=''; },
    setupFromPlayers(){
      const list = Object.entries(state.players||{});
      const lanes = [];
      list.forEach(([id,p],i)=>{
        const h = p.horse||{};
        this.horses[id] = {
          id, name:p.name||id.slice(0,4), horse:h, x:0, v:0, s:h.stamina||200, done:false, tFinish:0
        };
        lanes.push({id, color:h.color||'#fff'});
      });
      state.lanes = lanes;
    },
    async start(){
      this.reset();
      this.setupFromPlayers();
      state.started = true; state.seed = Math.floor(Math.random()*1e9);
      if(state.net){
        await R(`lobbies/${state.lobbyCode}`).update({ started:true, seed: state.seed, trackLen: +$.trackLen.value });
      }
      updateStartVisibility();
      await this.countdownAnim();
      if(state.isHost){ this.loopHost(); }
    }`).update({ started:true, seed: state.seed, trackLen: +$.trackLen.value });
      }
      await this.countdownAnim();
      if(state.isHost){ this.loopHost(); }
    },
    async countdownAnim(){
      for(let i=3;i>0;i--){ $.count.textContent = i; await sleep(800); }
      $.count.textContent = 'GO!'; await sleep(400); $.count.textContent='';
    },
    physics(dt, noise){
      const L = state.trackLen;
      for(const id in this.horses){
        const H = this.horses[id]; if(H.done) continue;
        const spec = H.horse;
        const fatigue = clamp(1 - (H.s / Math.max(1, spec.stamina)), 0, 0.75); // 0~0.75 ã§æœ€å¤§25%ä½ä¸‹
        const accel = spec.accel * (1 - 0.5*fatigue) + (noise()-0.5)*spec.luck*0.6;
        H.v = clamp(H.v + accel*dt, 0, spec.topSpeed*(1 - 0.4*fatigue));
        H.x += H.v * dt;
        H.s -= (0.015*H.v*H.v + 0.5*dt); // é€Ÿåº¦äºŒä¹—ã§æ¶ˆè²» + æ™‚é–“æ¸›è¡°
        if(H.x>=L){ H.x=L; H.done=true; H.tFinish = performance.now(); this.order.push(id); }
      }
    },
    async loopHost(){
      const noise = randSeeded(state.seed);
      const L = state.trackLen;
      let last = performance.now();
      const send = async ()=>{
        if(state.net){
          const snapshot = {}; const vs={};
          Object.values(this.horses).forEach(H=>{ snapshot[H.id] = Math.round(H.x); vs[H.id]=Math.round(H.v*100)/100; });
          await R(`lobbies/${state.lobbyCode}/state`).set({ t: Date.now(), L, pos: snapshot, vel: vs });
        }
      };
      let acc = 0, sendAcc=0;
      const step = (now)=>{
        const dt = Math.min(0.05, (now-last)/1000); last=now; acc += dt; sendAcc+=dt;
        this.physics(dt, noise);
        if(sendAcc>0.10){ send(); sendAcc=0; }
        drawRace();
        if(this.order.length===Object.keys(this.horses).length){
          this.finished=true; this.pushResults();
          return;
        }
        requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    },
    async pushResults(){
      const out = this.order.map((id,idx)=>{
        const p = state.players[id];
        return { rank: idx+1, id, player: p?.name||id, horse: p?.horse?.name||'é¦¬', color: p?.horse?.color||'#fff' };
      });
      $.results.style.display='block';
      if(state.net){ await R(`lobbies/${state.lobbyCode}/results`).set(out); }
      renderResults();
    }
  };

  // çµæœè¡¨ç¤º
  function renderResults(){
    const res = state.results||[];
    if(!res.length){ $.results.style.display='none'; $.results.innerHTML=''; return; }
    $.results.style.display='block';
    $.results.innerHTML = '<b>çµæœ</b>' + res.map(r=>`<div class="row" style="justify-content:space-between"><span>${r.rank}. <b>${r.player}</b> <span class="muted">/ ${r.horse}</span></span> <span class="badge" style="border-color:${r.color}">${r.color}</span></div>`).join('');
  }

  // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»
  function setupCanvas(){
    const c = $.canvas; const wrap = el('canvasWrap');
    const dpr = state.dpr; c.width = Math.floor(wrap.clientWidth * dpr); c.height = Math.floor(wrap.clientHeight * dpr);
    state.ctx = c.getContext('2d'); state.canvas=c; drawRace(true);
  }
  window.addEventListener('resize', setupCanvas);

  function drawRace(force=false){
    const ctx = state.ctx; if(!ctx) return; const c = state.canvas; const dpr = state.dpr;
    ctx.clearRect(0,0,c.width,c.height);
    const lanes = state.lanes; const L = state.trackLen; if(!lanes.length){
      ctx.fillStyle='rgba(255,255,255,.08)'; ctx.font=`${18*dpr}px system-ui`; ctx.fillText('ãƒ­ãƒ“ãƒ¼ã«å‚åŠ ã—ã¦é¦¬ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', 20*dpr, 40*dpr); return; }

    const H = Math.max(60, Math.min(120, (c.height/lanes.length)-10));
    const pad = 30*dpr; const left=120*dpr; const right=c.width-20*dpr; const w = right-left; 
    // ã‚´ãƒ¼ãƒ«ç·š
    ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.lineWidth=2*dpr;
    ctx.setLineDash([8*dpr,8*dpr]);
    ctx.beginPath(); ctx.moveTo(left+w, pad); ctx.lineTo(left+w, c.height-pad); ctx.stroke();
    ctx.setLineDash([]);
    ctx.font = `${14*dpr}px ui-monospace, monospace`; ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillText(`${L} m`, left+w-40*dpr, pad-6*dpr);

    lanes.forEach((ln, i)=>{
      const y = pad + i*(H+8) + 10;
      // ãƒ¬ãƒ¼ãƒ³
      ctx.fillStyle = 'rgba(255,255,255,.03)'; ctx.fillRect(left-10*dpr, y, w+20*dpr, H);
      // é¦¬
      const pos = getPos(ln.id);
      const x = left + w * clamp(pos/L, 0, 1);
      ctx.fillStyle = ln.color; ctx.beginPath(); ctx.roundRect(x-30*dpr, y+H*0.2, 60*dpr, H*0.6, 10*dpr); ctx.fill();
      // åå‰
      ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font = `${16*dpr}px system-ui`; const p = state.players[ln.id];
      const label = `${p?.name||'??'} / ${p?.horse?.name||'é¦¬'}`;
      ctx.fillText(label, 14*dpr, y + H*0.55);
      // è·é›¢
      ctx.fillStyle='rgba(255,255,255,.6)'; ctx.font = `${12*dpr}px ui-monospace, monospace`;
      ctx.fillText(`${Math.round(pos)}m`, x-18*dpr, y + H*0.95);
    });
  }

  function getPos(id){
    if(state.isHost){ return sim.horses[id]?.x || 0; }
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯é…ä¿¡ã•ã‚ŒãŸ state ã‚’ä½¿ç”¨
    const st = state.lastState; if(!st || !st.pos) return 0; const L = st.L||state.trackLen; const p = st.pos[id]||0; return p;
  }

  // ãƒ¬ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ
  async function resetRace(){
    if(!state.isHost || !state.net || !state.lobbyCode) return;
    await R(`lobbies/${state.lobbyCode}`).update({ started:false, seed:0 });
    await R(`lobbies/${state.lobbyCode}/state`).remove();
    await R(`lobbies/${state.lobbyCode}/results`).remove();
    state.started=false; state.results=[]; state.lastState=null; sim.reset(); drawRace(true); updateStartVisibility();
  }`).update({ started:false, seed:0 });
    await R(`lobbies/${state.lobbyCode}/state`).remove();
    await R(`lobbies/${state.lobbyCode}/results`).remove();
    state.started=false; state.results=[]; state.lastState=null; sim.reset(); drawRace(true);
  }

  // å‚åŠ è€…ï¼ãƒ›ã‚¹ãƒˆUIåˆ¶å¾¡
  $.create.addEventListener('click', createLobby);
  $.joinBtn.addEventListener('click', ()=>{
    const code = $.joinCode.value.toUpperCase().replace(/\s|-/g,''); if(code.length<4){ alert('ãƒ­ãƒ“ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™'); return; }
    joinLobby(code);
  });
  $.copy.addEventListener('click', ()=>{
    if(!state.lobbyCode) return; navigator.clipboard.writeText(state.lobbyCode); $.copy.textContent='âœ…'; setTimeout(()=>$.copy.textContent='ğŸ“‹', 1200);
  });
  $.save.addEventListener('click', upsertMe);
  $.ready.addEventListener('click', ()=> setReady(!state.me.ready));
  $.start.addEventListener('click', async ()=>{
    if(!state.isHost){ return; }
    if(!everyoneReady()){ alert('å…¨å“¡ã®æº–å‚™ãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“'); return; }
    if(!state.players[uid]?.ready){ alert('ãƒ›ã‚¹ãƒˆã‚‚ã€Œæº–å‚™OKã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
    await upsertMe();
    sim.start();
  });
  $.leave.addEventListener('click', leaveLobby);
  $.reset.addEventListener('click', resetRace);

  // URLã‹ã‚‰å‚åŠ 
  (function autoJoin(){
    const q = new URLSearchParams(location.search); const room = (q.get('room')||'').toUpperCase();
    if(room){ joinLobby(room); }
  })();

  // ãƒ­ãƒ¼ã‚«ãƒ«ã§ç·¨é›†ä¸­ã®åå‰/é¦¬ã‚’å¾©å¸°
  (function restoreLocal(){
    const pn = localStorage.getItem('playerName'); if(pn) $.pName.value = pn;
    const hn = localStorage.getItem('horseName'); if(hn) $.hName.value = hn;
  })();
  $.pName.addEventListener('input', ()=>localStorage.setItem('playerName', $.pName.value));
  $.hName.addEventListener('input', ()=>localStorage.setItem('horseName', $.hName.value));

  // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
  setupCanvas(); drawRace(true);

  // éãƒ›ã‚¹ãƒˆã®æç”»ãƒ«ãƒ¼ãƒ—ï¼ˆå—ä¿¡â†’æç”»ï¼‰
  (function loopClient(){
    const step=()=>{ drawRace(); requestAnimationFrame(step); };
    requestAnimationFrame(step);
  })();

  // å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ©è¦‹è¨­å®šè¡¨ç¤º
  document.addEventListener('contextmenu', (e)=>{
    e.preventDefault(); alert('ãƒ’ãƒ³ãƒˆ: Firebaseè¨­å®šã‚’åŸ‹ã‚ã‚‹ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚\nã“ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯å³ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
  });

  // äº’æ›: Canvasã®roundRectãŒç„¡ã„ç’°å¢ƒ
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r){ this.beginPath(); this.moveTo(x+r, y); this.lineTo(x+w-r, y); this.quadraticCurveTo(x+w, y, x+w, y+r); this.lineTo(x+w, y+h-r); this.quadraticCurveTo(x+w, y+h, x+w-r, y+h); this.lineTo(x+r, y+h); this.quadraticCurveTo(x, y+h, x, y+h-r); this.lineTo(x, y+r); this.quadraticCurveTo(x, y, x+r, y); this.closePath(); return this; };
  }

  </script>
</body>
</html>
