<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>みんなで競馬 - ロビー&オンライン対戦</title>
  <style>
    :root{
      --bg:#0f1221; --panel:#171a2e; --text:#e6e7ff; --muted:#9aa0c7; --accent:#6cf; --accent2:#9f6cff; --ok:#6cff80; --warn:#ffd166; --bad:#ff6c9f;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1500px 800px at 20% -10%, rgba(159,108,255,.12), transparent 60%),
      radial-gradient(1200px 900px at 110% 20%, rgba(108,204,255,.10), transparent 60%), var(--bg);
      color:var(--text); font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      display:grid; grid-template-rows:auto 1fr; gap:14px;
    }
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); backdrop-filter: blur(6px);}    
    header h1{margin:0; font-size:18px; letter-spacing:.4px}
    header .tag{font-size:12px; color:var(--muted)}
    main{display:grid; grid-template-columns:minmax(320px,700px) 1fr; gap:14px; padding:0 14px 14px}
    
    /* レース中のフルスクリーン表示 */
    main.racing {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
      height: calc(100vh - 60px);
      padding: 0;
      gap: 0;
    }
    main.racing #left {
      display: none;
    }
    main.racing #right {
      height: 100%;
      border-radius: 0;
      margin: 0;
    }
    main.racing #canvasWrap {
      height: 100%;
      border-radius: 0;
    }
    
    /* レース中のコントロールパネル */
    #raceControls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 100;
    }
    #raceControls.show {
      display: flex;
    }
    #raceControls button {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 120px;
    }
    
    @media (max-width: 768px) {
      #raceControls {
        top: 5px;
        right: 5px;
        padding: 6px;
      }
      #raceControls button {
        padding: 5px 8px;
        font-size: 11px;
        min-width: 100px;
      }
    }
    @media (max-width:1024px){ 
      main{grid-template-columns:1fr; padding:0 8px 8px} 
    }
    @media (max-width:768px){
      header{padding:6px 8px; font-size:12px}
      header h1{font-size:14px}
      header .tag{font-size:10px}
      main{padding:0 2px 2px; gap:4px; max-height:100vh; overflow-y:auto}
      .pad{padding:6px}
      .grid2{grid-template-columns:1fr; gap:3px}
      .grid3{grid-template-columns:1fr; gap:3px}
      .slider{
        display:flex; 
        flex-direction:column;
        gap:2px; 
        text-align:center;
        min-height:auto;
        padding:4px;
        border:1px solid var(--border);
        border-radius:8px;
        margin-bottom:2px;
      }
      .slider > div:first-child{
        font-size:11px; 
        font-weight:500;
        margin-bottom:2px;
      }
      .slider > div:last-child{
        font-size:10px;
        margin-top:2px;
      }
      .slider input[type=range]{
        margin:2px 0;
      }
      .row{flex-wrap:wrap; gap:3px; font-size:11px}
      .pill{padding:2px 4px; font-size:9px}
      .badge{font-size:9px; padding:1px 3px}
      .help{font-size:9px; line-height:1.3}
      input[type="text"], input[type="number"], button{
        padding:6px 8px; 
        font-size:11px;
        border-radius:6px;
      }
      .card h2{font-size:12px; margin:0 0 4px 0}
      .muted{font-size:10px}
      button{padding:6px 8px; font-size:11px}
      .footerNote{font-size:9px; padding:0 4px 4px}
      .col{gap:4px}
      
      /* スマホでの高さ調整 */
      .card{margin-bottom:4px}
      #left{max-height:70vh; overflow-y:auto}
    }
    @media (min-width:1600px){ main{ grid-template-columns:minmax(700px,800px) 1fr } }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:15px; margin:0 0 10px 0; letter-spacing:.3px; color:#dfe2ff}
    .pad{padding:16px}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    input, select, button{font:inherit; color:inherit}
    input[type="text"], input[type="number"], .readonly{
      width:100%; background:#0e1121; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
      outline:none; transition:.2s border-color, .2s box-shadow;
    }
    input[type="text"]:focus, input[type="number"]:focus{border-color:#6cf; box-shadow:0 0 0 3px rgba(108,204,255,.15)}
    .readonly{opacity:.8}
    button{
      background:linear-gradient(180deg, rgba(108,204,255,.25), rgba(108,204,255,.12));
      border:1px solid rgba(108,204,255,.45); color:#e8f6ff; padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s transform ease, .2s filter;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent; border:1px solid var(--border)}
    button.danger{background:linear-gradient(180deg, rgba(255,108,159,.25), rgba(255,108,159,.12)); border:1px solid rgba(255,108,159,.45)}
    .success{background:linear-gradient(180deg, rgba(108,255,128,.2), rgba(108,255,128,.12)); border:1px solid rgba(108,255,128,.45)}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed var(--border); border-radius:999px; color:var(--muted)}
    .copy{cursor:pointer}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#0c1020; border:1px solid var(--border)}

    /* キャンバスをアスペクト比固定でレスポンシブ対応 */
    #canvasWrap{
      height:520px; 
      position:relative;
      overflow:hidden;
    }
    @media (max-width:768px){
      #canvasWrap{
        height:200px;
        aspect-ratio: 2/1;
        max-width:100%;
        width:100%;
      }
    }
    @media (max-width:480px){
      #canvasWrap{
        height:180px;
        aspect-ratio: 2/1;
      }
    }
    canvas{
      width:100%; 
      height:100%; 
      background:repeating-linear-gradient(90deg, #111430, #111430 14px, #121535 14px, #121535 28px);
      object-fit:contain;
      max-width:100%;
      max-height:100%;
    }    
    #overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    #overlay .big{font-size:72px; font-weight:700; text-shadow:0 10px 30px rgba(0,0,0,.4)}
    @media (max-width:768px){
      #overlay .big{font-size:48px}
    }
    #results{position:absolute; right:16px; top:16px; background:rgba(0,0,0,.4); border:1px solid var(--border); border-radius:12px; padding:10px; max-width:300px}

    .slider{display:grid; grid-template-columns:140px minmax(200px,1fr) 100px; gap:12px; align-items:center; min-height:44px}
    
    /* PC版での調整コンテナ */
    .adjustments-container{
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:12px;
    }
    @media (min-width:1200px){
      .adjustments-container{
        grid-template-columns:1fr 1fr 1fr;
      }
    }
    input[type=range]{width:100%; -webkit-appearance:none; appearance:none; height:10px; background:transparent; cursor:pointer}
    input[type=range]::-webkit-slider-runnable-track{height:9px; background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)); border:1px solid var(--border); border-radius:999px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:#e6e7ff; border:2px solid rgba(108,204,255,.8); margin-top:-6px; box-shadow:0 2px 8px rgba(0,0,0,.35)}
    input[type=range]:disabled::-webkit-slider-thumb{background:#9aa0c7; border-color:#9aa0c7}
    input[type=range]::-moz-range-track{height:10px; background:linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)); border:1px solid var(--border); border-radius:999px}
    input[type=range]::-moz-range-thumb{width:22px; height:22px; border-radius:50%; background:#e6e7ff; border:2px solid rgba(108,204,255,.8); box-shadow:0 2px 8px rgba(0,0,0,.35)}

    .help{font-size:12px; color:var(--muted)}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .error{color:var(--bad)}
    .footerNote{font-size:12px; color:var(--muted); padding:0 18px 18px}
  </style>
</head>
<body>
  <header>
    <h1>🏇 みんなで競馬 <span class="tag">ロビー & リアルタイム対戦</span></h1>
    <div id="onlineBadge" class="badge">オフライン（デモ）</div>
  </header>

  <main>
    <!-- 左：ロビー/設定 -->
    <section class="card pad" id="left">
      <h2>ロビー</h2>
      <div class="col" id="lobbySection">
        <!-- 最初は名前入力のみ表示 -->
        <div class="col" id="initialSetup">
          <div class="grid2">
            <div>
              <label>プレイヤー名</label>
              <input type="text" id="playerName" placeholder="例：ピカソ" />
            </div>
            <div>
              <label>馬の名前</label>
              <input type="text" id="horseName" placeholder="例：サンダー" />
            </div>
          </div>
          <div class="row">
            <button id="createLobbyBtn">＋ ロビー作成</button>
            <div class="row">
              <input type="text" id="joinCode" placeholder="4桁コード" style="max-width:120px" />
              <button id="joinLobbyBtn" class="secondary">参加</button>
            </div>
          </div>
        </div>

        <!-- ロビー参加後に表示される詳細設定 -->
        <div class="col" id="detailedSetup" style="display:none">
          <div class="row">
            <div class="pill">共有コード: <span id="lobbyCode" class="code">-</span> <span id="copyCode" class="copy">📋</span></div>
            <div class="pill">あなた: <span id="whoami">未接続</span></div>
            <div class="pill"><span id="hostBadge">参加者</span></div>
          </div>

          <div class="col" id="horseAdjustments">
            <h3 style="margin:8px 0 4px 0; font-size:14px">馬の能力調整</h3>
            <div class="adjustments-container">
              <div class="slider">
                <div>最高速度</div>
                <input type="range" id="sTop" min="1" max="50" step="0.1" value="14">
                <div><span id="vTop">14.0</span> m/s</div>
              </div>
              <div class="slider">
                <div>加速度</div>
                <input type="range" id="sAcc" min="0.1" max="10" step="0.01" value="2.2">
                <div><span id="vAcc">2.20</span> m/s²</div>
              </div>
              <div class="slider">
                <div>スタミナ</div>
                <input type="range" id="sSta" min="10" max="5000" step="1" value="200">
                <div><span id="vSta">200</span> SP</div>
              </div>
              <div class="slider">
                <div>運（ゆらぎ）</div>
                <input type="range" id="sLuck" min="0" max="3" step="0.01" value="0.5">
                <div><span id="vLuck">0.50</span></div>
              </div>
              <div class="slider">
                <div>馬の色</div>
                <input type="color" id="horseColor" value="#7dd3fc" />
                <div><span class="colorBox" id="colorBox" style="display:inline-block; width:20px; height:20px; border-radius:4px; border:1px solid var(--border)"></span></div>
              </div>
              <!-- 距離はホストのみ表示 -->
              <div class="slider" id="trackRow" style="display:none">
                <div>レース距離</div>
                <input type="range" id="trackLen" min="200" max="5000" step="10" value="1200">
                <div><span id="vLen">1200</span> m</div>
              </div>
            </div>

            <div class="row">
              <button id="saveHorseBtn">設定を保存 / 更新</button>
              <button id="readyBtn" class="success" style="display:none">準備OK</button>
              <button id="startBtn" class="danger" style="display:none">ゲーム開始（ホストのみ）</button>
            </div>
            <div class="help">
              <div>・ロビー作成者がホストです。参加者は4桁コード入力で参加できます。</div>
              <div>・<b>レース中はステータスや色の変更はできません</b>（自動でロック）。</div>
              <div>・<b>誰かが途中で抜けたら試合は放棄</b>（全員に通知）。</div>
            </div>
          </div>

          <div class="card pad" style="margin-top:8px">
            <h2>参加者一覧</h2>
            <div id="playersList" class="col"></div>
          </div>
        </div>

        <details>
          <summary>Firebase 設定を開く</summary>
          <pre class="code" id="cfgPreview"></pre>
        </details>
      </div>
    </section>

    <!-- 右：レース画面 -->
    <section class="card pad" id="right">
      <h2>レース</h2>
      <div id="canvasWrap" class="card">
        <canvas id="race"></canvas>
        <div id="overlay"><div class="big" id="countDown"></div></div>
        <div id="results" class="col" style="display:none"></div>
        
        <!-- レース中のコントロールパネル -->
        <div id="raceControls">
          <button id="leaveBtn2" class="secondary">ロビーから抜ける</button>
          <button id="resetBtn2" class="secondary">レースをリセット</button>
          <button id="abortBtn2" class="danger">試合を中断</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px" id="normalControls">
        <button id="leaveBtn" class="secondary">ロビーから抜ける</button>
        <button id="resetBtn" class="secondary">レースをリセット（ホスト）</button>
        <button id="abortBtn" class="danger" style="display:none">試合を中断（ホスト）</button>
      </div>
      <div class="help" style="margin-top:8px">レースはホスト端末で計算し、他端末へ配信します。</div>
    </section>
  </main>

  <div class="footerNote">※ Firebase の設定を埋めるとオンライン同期が有効になり、誰でもロビーコードで参加できます。</div>

  <!-- Firebase（任意・オンライン同期用） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOqe--KczRP2fFCykd4iH1iaAVpyQTlSE",
    authDomain: "keiba-66344.firebaseapp.com",
    databaseURL: "https://keiba-66344-default-rtdb.firebaseio.com",
    projectId: "keiba-66344",
    storageBucket: "keiba-66344.firebasestorage.app",
    messagingSenderId: "636995719079",
    appId: "1:636995719079:web:dbb09c8860101a4c82b082",
    measurementId: "G-QSPM8PBTTH"
  };

  const el = (id)=>document.getElementById(id);
  const uid = localStorage.getItem('uid') || (()=>{const v=crypto.getRandomValues(new Uint32Array(4)); const s=[...v].map(x=>x.toString(16).padStart(8,'0')).join(''); localStorage.setItem('uid', s); return s;})();

  const state = {
    net:false, app:null, db:null,
    me:{ id:uid, name:"", horse:null, ready:false },
    lobby:null, lobbyCode:null, isHost:false, players:{},
    started:false, seed:null, results:[],
    ctx:null, canvas:null, dpr:Math.min(2, window.devicePixelRatio||1),
    lanes:[], lastState:null, trackLen:1200,
    racePlayerIds:[],
    abandoned:null
  };

  const $ = {
    code: el('lobbyCode'), who: el('whoami'), hostBadge: el('hostBadge'), onlineBadge: el('onlineBadge'),
    create: el('createLobbyBtn'), joinBtn: el('joinLobbyBtn'), joinCode: el('joinCode'), copy: el('copyCode'),
    pName: el('playerName'), hName: el('horseName'),
    sTop: el('sTop'), sAcc: el('sAcc'), sSta: el('sSta'), sLuck: el('sLuck'), hColor: el('horseColor'),
    vTop: el('vTop'), vAcc: el('vAcc'), vSta: el('vSta'), vLuck: el('vLuck'), colorBox: el('colorBox'),
    save: el('saveHorseBtn'), ready: el('readyBtn'), start: el('startBtn'), playersList: el('playersList'),
    trackLen: el('trackLen'), trackRow: el('trackRow'), vLen: el('vLen'),
    canvas: el('race'), overlay: el('overlay'), count: el('countDown'), results: el('results'),
    leave: el('leaveBtn'), reset: el('resetBtn'), abort: el('abortBtn'), cfgPreview: el('cfgPreview'),
  };

  function syncLabels(){
    $.vTop.textContent=(+$.sTop.value).toFixed(1);
    $.vAcc.textContent=(+$.sAcc.value).toFixed(2);
    $.vSta.textContent=(+$.sSta.value).toFixed(0);
    $.vLuck.textContent=(+$.sLuck.value).toFixed(2);
    if($.trackLen) $.vLen.textContent=(+$.trackLen.value).toFixed(0);
    $.colorBox.style.background=$.hColor.value;
  }
  [$.sTop,$.sAcc,$.sSta,$.sLuck,$.hColor,$.trackLen].forEach(i=>{ if(i) i.addEventListener('input', ()=>{ syncLabels(); if(state.me.ready) setReady(false); }); });
  syncLabels();

  function initFirebase(){
    if(typeof window.firebase==='undefined'){ $.onlineBadge.textContent='オフライン（SDK未読込）'; return; }
    if(!firebaseConfig || !firebaseConfig.apiKey){ $.onlineBadge.textContent='オフライン（デモ）'; return; }
    try{
      state.app=firebase.initializeApp(firebaseConfig);
      state.db=firebase.database();
      state.net=true;
      firebase.auth().signInAnonymously().catch(console.error);
      $.onlineBadge.textContent='オンライン有効（Firebase）';
    }catch(e){ console.error(e); $.onlineBadge.textContent='オフライン（初期化エラー）'; }
  }
  initFirebase();

  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const randSeeded=(seed)=>{ let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return s/0x100000000; } };
  const R=(path)=> state.db?state.db.ref(path):null;

  function makeCode(){ return String(Math.floor(Math.random()*10000)).padStart(4,'0'); }

  const COLOR_PALETTE=['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6','#e67e22','#1abc9c','#e84393','#d35400','#27ae60','#2980b9','#8e44ad','#16a085','#2c3e50'];
  function uniqueColor(desired, excludeSelf=true){
    const used=new Set(Object.entries(state.players||{})
      .filter(([id])=>!excludeSelf||id!==uid)
      .map(([,p])=>p&&p.horse&&p.horse.color)
      .filter(Boolean));
    if(desired && !used.has(desired)) return desired;
    for(const c of COLOR_PALETTE){ if(!used.has(c)) return c; }
    for(let i=0;i<360;i+=27){ const c=`hsl(${(i+Math.floor(Math.random()*27))%360} 70% 60%)`; if(!used.has(c)) return c; }
    return '#7dd3fc';
  }

  function buildLanesFromPlayers(){
    const lanes=[]; Object.entries(state.players||{}).forEach(([id,p])=>{ lanes.push({id, color:(p&&p.horse&&p.horse.color)||'#7dd3fc'}); });
    state.lanes=lanes;
  }

  function updateHeader(){ el('hostBadge').textContent = state.isHost? 'ホスト' : '参加者'; }

  function updateRoleUI(){
    const host = state.isHost;
    const joined = !!state.lobbyCode && (!!(state.players && state.players[uid]) || state.isHost);
    
    // 初期画面と詳細設定画面の表示切り替え
    const initialSetup = document.getElementById('initialSetup');
    const detailedSetup = document.getElementById('detailedSetup');
    
    if(joined) {
      if(initialSetup) initialSetup.style.display = 'none';
      if(detailedSetup) detailedSetup.style.display = 'block';
    } else {
      if(initialSetup) initialSetup.style.display = 'block';
      if(detailedSetup) detailedSetup.style.display = 'none';
    }
    
    if($.trackRow) $.trackRow.style.display = host ? '' : 'none';
    if($.ready) $.ready.style.display = joined ? '' : 'none';
    applyLockState();
    updateButtonsState();
    updateStartVisibility();
  }

  function applyLockState(){
    const trackEditable = state.isHost && !state.started;
    [$.sTop,$.sAcc,$.sSta,$.sLuck,$.hColor,$.save].forEach(e=>{ if(e) e.disabled = !!state.started; });
    if($.trackLen){ $.trackLen.disabled = !trackEditable; }
  }

  function updateButtonsState(){
    const disableAll = state.started;
    const btns = [ $.create,$.joinBtn,$.save,$.ready,$.start,$.leave,$.reset ];
    btns.forEach(b=>{ if(!b) return; b.disabled = !!disableAll; });
    const showAbort = state.isHost && state.started && !state.abandoned;
    if($.abort){ $.abort.style.display = showAbort ? 'inline-block' : 'none'; $.abort.disabled = !showAbort; }
    
    // レース中のUIの切り替え
    const main = document.querySelector('main');
    const raceControls = document.getElementById('raceControls');
    const normalControls = document.getElementById('normalControls');
    
    if(state.started && !state.abandoned) {
      // レース中：フルスクリーン表示
      main.classList.add('racing');
      if(raceControls) raceControls.classList.add('show');
      if(normalControls) normalControls.style.display = 'none';
      
      // レース中コントロールボタンの設定
      const leave2 = document.getElementById('leaveBtn2');
      const reset2 = document.getElementById('resetBtn2');
      const abort2 = document.getElementById('abortBtn2');
      
      if(leave2) leave2.disabled = false;
      if(reset2) { reset2.style.display = state.isHost ? 'block' : 'none'; reset2.disabled = false; }
      if(abort2) { abort2.style.display = state.isHost ? 'block' : 'none'; abort2.disabled = false; }
    } else {
      // 通常時：通常レイアウト
      main.classList.remove('racing');
      if(raceControls) raceControls.classList.remove('show');
      if(normalControls) normalControls.style.display = 'flex';
    }
  }

  function renderPlayers(){
    $.playersList.innerHTML='';
    const keys=Object.keys(state.players||{});
    if(keys.length===0){ $.playersList.innerHTML='<div class="muted">（まだ参加者はいません）</div>'; return; }
    keys.forEach(id=>{
      const p=state.players[id]; if(!p) return;
      const div=document.createElement('div'); div.className='row'; div.style.justifyContent='space-between';
      const status=p.ready?'<span class="badge" style="border-color:#6cff80">READY</span>':'<span class="badge" style="border-color:#ffd166">待機</span>';
      div.innerHTML=`<div><b>${p.name||'名無し'}</b> <span class="muted">/ ${p.horse&&p.horse.name||'馬'}</span></div>
        <div class="row">${status} <span class="badge" style="border-color:${p.horse&&p.horse.color||'#888'}">${p.horse&&p.horse.color||'#888'}</span>
        <span class="muted">V${p.horse&&p.horse.topSpeed||'?'} A${p.horse&&p.horse.accel||'?'} S${p.horse&&p.horse.stamina||'?'} L${p.horse&&p.horse.luck||'?'} </span></div>`;
      $.playersList.appendChild(div);
    });
  }

  function renderResults(){
    const res=state.results||[];
    if(!res.length){ $.results.style.display='none'; $.results.innerHTML=''; return; }
    $.results.style.display='block';
    $.results.innerHTML='<b>結果</b>'+ res.map(r=>`<div class="row" style="justify-content:space-between"><span>${r.rank}. <b>${r.player}</b> <span class="muted">/ ${r.horse}</span></span> <span class="badge" style="border-color:${r.color}">${r.color}</span></div>`).join('');
  }

  function everyoneReady(){ const ps=state.players||{}; const ids=Object.keys(ps); if(!ids.length) return false; return ids.every(id=>ps[id]&&ps[id].ready); }
  function updateStartVisibility(){ const show=state.isHost && everyoneReady() && !state.started && !state.abandoned; $.start.style.display=show? 'inline-block':'none'; }
  function updateReadyButton(){ $.ready.textContent=state.me.ready? '準備解除':'準備OK'; $.ready.className=state.me.ready? 'secondary':'success'; }

  function collectHorse(){ return { name: $.hName.value.trim()||'ノーマル', color: $.hColor.value, topSpeed:+(+$.sTop.value).toFixed(2), accel:+(+$.sAcc.value).toFixed(2), stamina:+(+$.sSta.value).toFixed(0), luck:+(+$.sLuck.value).toFixed(2) }; }

  function ensurePresence(){
    if(!state.net || !state.lobbyCode) return;
    try{
      const pref=R('lobbies/'+state.lobbyCode+'/players/'+uid);
      pref && pref.onDisconnect().remove();
      if(state.isHost){
        const lref=R('lobbies/'+state.lobbyCode);
        lref && lref.child('started').onDisconnect().set(false);
        lref && lref.child('abandoned').onDisconnect().set({ at: Date.now(), reason:'host_disconnected' });
        R('lobbies/'+state.lobbyCode+'/state').onDisconnect().remove();
        R('lobbies/'+state.lobbyCode+'/results').onDisconnect().remove();
      }
    }catch(e){ console.warn('presence onDisconnect set failed', e); }
  }

  async function upsertMe(){
    if(state.started){ ensurePresence(); return; }
    const name=$.pName.value.trim()||`Player-${uid.slice(0,4).toUpperCase()}`;
    let horse=collectHorse();
    horse.color=uniqueColor(horse.color,true);
    $.hColor.value=horse.color; $.colorBox.style.background=horse.color;
    state.me.name=name; state.me.horse=horse; $.who.textContent=name;
    if(state.net && state.lobbyCode){
      await R('lobbies/'+state.lobbyCode+'/players/'+uid).set({ name, horse, updatedAt:Date.now(), ready:state.me.ready||false });
      ensurePresence();
    } else {
      state.players[uid]={ name, horse, ready:state.me.ready||false };
      renderPlayers(); buildLanesFromPlayers(); updateStartVisibility();
    }
  }

  async function setReady(val){ state.me.ready=!!val; updateReadyButton(); if(state.net && state.lobbyCode){ await R('lobbies/'+state.lobbyCode+'/players/'+uid).update({ ready:state.me.ready, updatedAt:Date.now() }); } renderPlayers(); updateStartVisibility(); }

  async function createLobby(){
    const code=makeCode(); state.lobbyCode=code; state.isHost=true; updateHeader();
    if(state.net){ await R('lobbies/'+code).set({ createdAt:Date.now(), hostId:uid, started:false, abandoned:null, trackLen:+($.trackLen?$.trackLen.value:1200), seed:0 }); subscribeLobby(code); }
    $.code.textContent=code; history.replaceState(null,'', location.pathname+`?room=${code}`);
    await upsertMe(); ensurePresence(); updateRoleUI();
  }

  async function joinLobby(code){ state.lobbyCode=code; state.isHost=false; updateHeader(); if(state.net){ subscribeLobby(code); ensurePresence(); await sleep(50); await upsertMe(); } $.code.textContent=code; history.replaceState(null,'', location.pathname+`?room=${code}`); updateRoleUI(); }

  async function abandonRace(reason){ if(!state.net || !state.lobbyCode) return; await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:{ at:Date.now(), reason } }); await R('lobbies/'+state.lobbyCode+'/state').remove(); await R('lobbies/'+state.lobbyCode+'/results').remove(); }

  async function abortToLobby(){
    if(!(state.isHost && state.started)) return;
    if(state.net && state.lobbyCode){
      await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:null });
      await R('lobbies/'+state.lobbyCode+'/state').remove();
    }
    state.started=false; 
    state.abandoned=null; 
    state.results=[]; 
    state.lastState=null;
    sim.reset(); 
    if(state.ctx) drawRace();
    applyLockState(); 
    updateButtonsState(); 
    updateStartVisibility();
  }

  function subscribeLobby(code){ if(!state.net) return;
    R('lobbies/'+code).on('value', snap=>{
      const v=snap.val()||{};
      state.lobby=v; state.started=!!v.started; state.seed=v.seed||0; state.trackLen=v.trackLen||1200; state.abandoned=v.abandoned||null;
      if($.trackLen) $.trackLen.value=state.trackLen; syncLabels(); applyLockState(); updateButtonsState();
      if(state.abandoned){ $.count.textContent='試合放棄'; } else if(!state.started){ $.count.textContent=''; }
      updateStartVisibility();
    });
    R('lobbies/'+code+'/players').on('value', snap=>{
      state.players=snap.val()||{}; renderPlayers(); buildLanesFromPlayers(); updateRoleUI(); updateStartVisibility();
      if(state.isHost && state.started && state.racePlayerIds.length){
        const nowIds=new Set(Object.keys(state.players));
        for(const pid of state.racePlayerIds){ if(!nowIds.has(pid)){ abandonRace('player_left'); break; } }
      }
    });
    R('lobbies/'+code+'/state').on('value', snap=>{ state.lastState=snap.val()||null; });
    R('lobbies/'+code+'/results').on('value', snap=>{ state.results=snap.val()||[]; renderResults(); });
  }

  async function leaveLobby(){ if(state.net && state.lobbyCode){ await R('lobbies/'+state.lobbyCode+'/players/'+uid).remove(); if(state.isHost && state.started){ await abandonRace('host_left'); } } state.lobbyCode=null; state.isHost=false; state.players={}; state.started=false; state.results=[]; state.abandoned=null; $.code.textContent='-'; $.who.textContent='未接続'; renderPlayers(); buildLanesFromPlayers(); renderResults(); updateStartVisibility(); updateRoleUI(); history.replaceState(null,'', location.pathname); }

  const sim = {
    running:false, horses:{}, order:[],
    reset(){ 
      this.horses={}; 
      this.order=[]; 
      this.running=false; 
      $.results.style.display='none'; 
      $.count.textContent=''; 
    },
    setupFromPlayers(){ const lanes=[]; Object.entries(state.players||{}).forEach(([id,p])=>{ const h=p.horse||{}; this.horses[id]={ id, name:p.name||id.slice(0,4), horse:h, x:0, v:0, s:h.stamina||200, done:false }; lanes.push({id, color:h.color||'#fff'}); }); state.lanes=lanes; },
    async start(){ this.reset(); this.setupFromPlayers(); state.started=true; state.abandoned=null; if(state.isHost){ state.seed=Math.floor(Math.random()*1e9); state.trackLen=+($.trackLen?$.trackLen.value:1200); state.racePlayerIds=Object.keys(state.players||{}); if(state.net){ await R('lobbies/'+state.lobbyCode).update({ started:true, abandoned:null, seed:state.seed, trackLen:state.trackLen }); } }
      updateButtonsState(); applyLockState();
      for(let i=3;i>0;i--){ $.count.textContent=String(i); await sleep(800);} $.count.textContent='GO!'; await sleep(400); $.count.textContent='';
      if(state.isHost){ this.loopHost(); }
    },
    physics(dt,noise){ const L=state.trackLen; for(const id in this.horses){ const H=this.horses[id]; if(H.done) continue; const spec=H.horse; const fatigue=clamp(1-(H.s/Math.max(1,spec.stamina)),0,0.75); const accel=spec.accel*(1-0.5*fatigue)+(noise()-0.5)*spec.luck*0.6; H.v=clamp(H.v+accel*dt,0,spec.topSpeed*(1-0.4*fatigue)); H.x+=H.v*dt; H.s-=(0.015*H.v*H.v+0.5*dt); if(H.x>=L){ H.x=L; H.done=true; this.order.push(id);} } },
    loopHost(){ 
      this.running=true; 
      const noise=randSeeded(state.seed); 
      const L=state.trackLen; 
      let last=performance.now(), sendAcc=0; 
      const step=(now)=>{ 
        if(!this.running||!state.started||state.abandoned){ 
          return; 
        } 
        const dt=Math.min(0.05,(now-last)/1000); 
        last=now; 
        this.physics(dt,noise); 
        sendAcc+=dt; 
        if(sendAcc>0.10 && state.net){ 
          const pos={}, vel={}; 
          Object.values(this.horses).forEach(H=>{
            pos[H.id]=Math.round(H.x); 
            vel[H.id]=Math.round(H.v*100)/100;
          }); 
          const colors={}; 
          Object.values(this.horses).forEach(H=>{ 
            const p=state.players[H.id]; 
            colors[H.id]=(p&&p.horse&&p.horse.color)||'#7dd3fc'; 
          }); 
          R('lobbies/'+state.lobbyCode+'/state').set({ t:Date.now(), L, pos, vel, colors }); 
          sendAcc=0; 
        } 
        if(state.ctx) drawRace(); 
        if(this.order.length===Object.keys(this.horses).length){ 
          this.finish(); 
          return; 
        } 
        requestAnimationFrame(step); 
      }; 
      requestAnimationFrame(step); 
    },
    async finish(){ this.running=false; const out=this.order.map((id,idx)=>{ const p=state.players[id]; return { rank:idx+1, id, player:p&&p.name||id, horse:p&&p.horse&&p.horse.name||'馬', color:p&&p.horse&&p.horse.color||'#fff' }; }); if(state.net){ await R('lobbies/'+state.lobbyCode+'/results').set(out); await R('lobbies/'+state.lobbyCode).update({ started:false }); } state.results=out; renderResults(); state.started=false; updateButtonsState(); applyLockState(); }
  };

  function setupCanvas(){ 
    const c=$.canvas; 
    const wrap=document.getElementById('canvasWrap'); 
    const dpr=state.dpr; 
    
    // 楕円トラック用に2:1のアスペクト比を維持
    const containerWidth = wrap.clientWidth;
    const containerHeight = wrap.clientHeight;
    
    const aspectRatio = 2/1; // 楕円に適した比率
    let canvasWidth, canvasHeight;
    
    if(containerWidth / containerHeight > aspectRatio) {
      canvasHeight = containerHeight;
      canvasWidth = canvasHeight * aspectRatio;
    } else {
      canvasWidth = containerWidth;
      canvasHeight = canvasWidth / aspectRatio;
    }
    
    c.width = Math.floor(canvasWidth * dpr); 
    c.height = Math.floor(canvasHeight * dpr); 
    c.style.width = canvasWidth + 'px';
    c.style.height = canvasHeight + 'px';
    
    state.ctx = c.getContext('2d'); 
    if(state.ctx) drawRace(); 
  }
  window.addEventListener('resize', setupCanvas);

  function getPos(id){ 
    if(state.isHost){ 
      return sim.horses[id] && sim.horses[id].x || 0; 
    } 
    const st = state.lastState; 
    if(!st || !st.pos) return 0; 
    return st.pos[id] || 0; 
  }

  // 楕円コースでのレース描画
  function drawRace(){ 
    const ctx=state.ctx; 
    if(!ctx) return; 
    const c=$.canvas; 
    const dpr=state.dpr; 
    ctx.clearRect(0,0,c.width,c.height); 
    const lanes=state.lanes; 
    const L=state.trackLen; 
    
    // 画面サイズ判定を最初に行う
    const isSmall = c.width < 400*dpr;
    
    if(!lanes.length){ 
      ctx.fillStyle='rgba(255,255,255,.08)'; 
      ctx.font=`${16*dpr}px system-ui`; 
      const text = 'ロビーに参加して馬を登録';
      const textWidth = ctx.measureText(text).width;
      ctx.fillText(text, (c.width - textWidth)/2, c.height/2); 
      return; 
    } 
    
    // 楕円コースの設定
    const centerX = c.width / 2;
    const centerY = c.height / 2;
    const trackWidth = c.width * 0.8;
    const trackHeight = c.height * 0.7;
    const radiusX = trackWidth / 2;
    const radiusY = trackHeight / 2;
    
    const laneCount = lanes.length;
    const laneSpacing = Math.min(15*dpr, radiusY * 0.15);
    
    // コースの外枠と内枠を描画
    for(let i = 0; i <= laneCount; i++) {
      const currentRadiusX = radiusX - i * laneSpacing;
      const currentRadiusY = radiusY - i * laneSpacing;
      
      if(currentRadiusX > 0 && currentRadiusY > 0) {
        ctx.strokeStyle = i === 0 ? 'rgba(108,255,128,.4)' : 'rgba(255,255,255,.15)';
        ctx.lineWidth = i === 0 ? 3*dpr : 1*dpr;
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, currentRadiusX, currentRadiusY, 0, 0, 2 * Math.PI);
        ctx.stroke();
      }
    }
    
    // スタート/ゴールライン
    ctx.strokeStyle = 'rgba(255,255,255,.6)';
    ctx.lineWidth = 2*dpr;
    ctx.setLineDash([6*dpr, 6*dpr]);
    ctx.beginPath();
    ctx.moveTo(centerX + radiusX, centerY - radiusY);
    ctx.lineTo(centerX + radiusX - laneCount * laneSpacing, centerY - radiusY + laneCount * laneSpacing);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // 距離表示
    ctx.fillStyle = 'rgba(255,255,255,.8)';
    ctx.font = `${12*dpr}px ui-monospace, monospace`;
    ctx.fillText(`${L}m`, centerX + radiusX - 30*dpr, centerY - radiusY - 8*dpr);
    
    // 各馬の描画
    lanes.forEach((ln, i) => {
      const laneRadiusX = radiusX - (i + 0.5) * laneSpacing;
      const laneRadiusY = radiusY - (i + 0.5) * laneSpacing;
      
      if(laneRadiusX <= 0 || laneRadiusY <= 0) return;
      
      const pos = getPos(ln.id);
      const progress = Math.max(0, Math.min(1, pos / L));
      
      // 楕円上の位置計算（右上から時計回り）
      const angle = progress * 2 * Math.PI;
      const x = centerX + laneRadiusX * Math.cos(angle);
      const y = centerY + laneRadiusY * Math.sin(angle);
      
      const p = state.players[ln.id];
      const col = (state.lastState?.colors?.[ln.id]) || (p?.horse?.color) || ln.color || '#7dd3fc';
      
      // 馬を円形で描画
      const horseSize = Math.min(12*dpr, laneSpacing * 0.8);
      ctx.fillStyle = col;
      ctx.beginPath();
      ctx.arc(x, y, horseSize/2, 0, 2 * Math.PI);
      ctx.fill();
      
      // 馬の輪郭
      ctx.strokeStyle = 'rgba(255,255,255,.8)';
      ctx.lineWidth = 1*dpr;
      ctx.stroke();
      
      // プレイヤー名をコース内側に表示（スマホでも表示）
      if(p?.name) {
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        const fontSize = isSmall ? 8*dpr : 9*dpr;
        ctx.font = `${fontSize}px system-ui`;
        const nameWidth = ctx.measureText(p.name).width;
        
        // 内側に向かって名前を配置
        const innerRadius = Math.max(10*dpr, Math.min(laneRadiusX, laneRadiusY) - laneSpacing);
        const innerX = centerX + (innerRadius * 0.7) * Math.cos(angle);
        const innerY = centerY + (innerRadius * 0.7) * Math.sin(angle);
        
        // スマホでは背景を追加して見やすくする
        if(isSmall) {
          ctx.fillStyle = 'rgba(0,0,0,.6)';
          ctx.fillRect(innerX - nameWidth/2 - 2*dpr, innerY - fontSize/2 - 1*dpr, nameWidth + 4*dpr, fontSize + 2*dpr);
        }
        
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        ctx.fillText(p.name, innerX - nameWidth/2, innerY + 2*dpr);
      }
      
      // 距離表示（小さく）
      if(!isSmall) {
        ctx.fillStyle = 'rgba(255,255,255,.6)';
        ctx.font = `${7*dpr}px ui-monospace, monospace`;
        const distText = `${Math.round(pos)}m`;
        const distWidth = ctx.measureText(distText).width;
        ctx.fillText(distText, x - distWidth/2, y - horseSize/2 - 4*dpr);
      }
    });
    
    // レジェンド（スマホでは省略）
    if(!isSmall) {
      ctx.fillStyle = 'rgba(0,0,0,.3)';
      ctx.fillRect(10*dpr, 10*dpr, 120*dpr, lanes.length * 16*dpr + 20*dpr);
      
      lanes.forEach((ln, i) => {
        const p = state.players[ln.id];
        const col = (state.lastState?.colors?.[ln.id]) || (p?.horse?.color) || ln.color || '#7dd3fc';
        
        ctx.fillStyle = col;
        ctx.fillRect(15*dpr, 20*dpr + i * 16*dpr, 12*dpr, 12*dpr);
        
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        ctx.font = `${10*dpr}px system-ui`;
        ctx.fillText((p?.name || '??'), 32*dpr, 30*dpr + i * 16*dpr);
      });
    }
  }

  // --- Buttons ---
  $.create.addEventListener('click', async ()=>{ 
    const name=$.pName.value.trim(); 
    const hname=$.hName.value.trim(); 
    if(!name||!hname){ 
      alert('ロビー作成前に「プレイヤー名」と「馬の名前」を入力してください'); 
      return; 
    } 
    await createLobby(); 
  });
  $.joinBtn.addEventListener('click', ()=>{ 
    const name=$.pName.value.trim(); 
    const hname=$.hName.value.trim(); 
    if(!name||!hname){ 
      alert('参加前に「プレイヤー名」と「馬の名前」を入力してください'); 
      return; 
    } 
    const code=($.joinCode.value||'').split('').filter(ch=>ch>='0'&&ch<='9').join(''); 
    if(code.length!==4){ 
      alert('ロビーコードは4桁の数字です'); 
      return; 
    } 
    joinLobby(code); 
  });
  $.copy.addEventListener('click', ()=>{ if(!state.lobbyCode) return; navigator.clipboard.writeText(state.lobbyCode); $.copy.textContent='✅'; setTimeout(()=>$.copy.textContent='📋', 1200); });
  $.save.addEventListener('click', upsertMe);
  $.ready.addEventListener('click', ()=> setReady(!state.me.ready));
  $.start.addEventListener('click', async ()=>{ if(!state.isHost) return; if(!everyoneReady()){ alert('全員の準備がまだ完了していません'); return; } if(!(state.players[uid]&&state.players[uid].ready)){ alert('ホストも「準備OK」を押してください'); return; } await upsertMe(); sim.start(); });
  
  // 通常のコントロールボタン
  $.leave.addEventListener('click', leaveLobby);
  $.reset.addEventListener('click', async ()=>{ 
    if(!state.isHost||!state.net||!state.lobbyCode) return; 
    await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:null, seed:0 }); 
    await R('lobbies/'+state.lobbyCode+'/state').remove(); 
    await R('lobbies/'+state.lobbyCode+'/results').remove(); 
    state.started=false; 
    state.results=[]; 
    state.lastState=null; 
    state.abandoned=null; 
    sim.reset(); 
    if(state.ctx) drawRace(); 
    updateButtonsState(); 
    applyLockState(); 
    updateStartVisibility(); 
  });
  $.abort.addEventListener('click', async ()=>{ await abortToLobby(); });

  // レース中のコントロールボタン
  const leave2 = document.getElementById('leaveBtn2');
  const reset2 = document.getElementById('resetBtn2');
  const abort2 = document.getElementById('abortBtn2');
  
  if(leave2) leave2.addEventListener('click', leaveLobby);
  if(reset2) reset2.addEventListener('click', async ()=>{ 
    if(!state.isHost||!state.net||!state.lobbyCode) return; 
    await R('lobbies/'+state.lobbyCode).update({ started:false, abandoned:null, seed:0 }); 
    await R('lobbies/'+state.lobbyCode+'/state').remove(); 
    await R('lobbies/'+state.lobbyCode+'/results').remove(); 
    state.started=false; 
    state.results=[]; 
    state.lastState=null; 
    state.abandoned=null; 
    sim.reset(); 
    if(state.ctx) drawRace(); 
    updateButtonsState(); 
    applyLockState(); 
    updateStartVisibility(); 
  });
  if(abort2) abort2.addEventListener('click', async ()=>{ await abortToLobby(); });

  // URLから自動参加
  (function autoJoin(){ const q=new URLSearchParams(location.search); const room=(q.get('room')||'').split('').filter(ch=>ch>='0'&&ch<='9').join(''); if(room){ joinLobby(room.padStart(4,'0')); } else { updateRoleUI(); } })();

  // 名前/馬名ローカル保存
  (function restoreLocal(){ const pn=localStorage.getItem('playerName'); if(pn) $.pName.value=pn; const hn=localStorage.getItem('horseName'); if(hn) $.hName.value=hn; })();
  $.pName.addEventListener('input', ()=>localStorage.setItem('playerName',$.pName.value));
  $.hName.addEventListener('input', ()=>localStorage.setItem('horseName',$.hName.value));

  // キャンバス初期化とクライアントループ
  setupCanvas(); 
  
  function clientLoop(){ 
    if(state.ctx) {
      drawRace(); 
    }
    requestAnimationFrame(clientLoop); 
  }
  clientLoop();

  document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); alert('ヒント: Firebase設定を埋めるとオンライン対戦が有効になります。'); });

  if(!CanvasRenderingContext2D.prototype.roundRect){ CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){ this.beginPath(); this.moveTo(x+r,y); this.lineTo(x+w-r,y); this.quadraticCurveTo(x+w,y,x+w,y+r); this.lineTo(x+w,y+h-r); this.quadraticCurveTo(x+w,y+h,x+w-r,y+h); this.lineTo(x+r,y+h); this.quadraticCurveTo(x,y+h,x,y+h-r); this.lineTo(x,y+r); this.quadraticCurveTo(x,y,x+r,y); this.closePath(); return this; }; }
  </script>
</body>
</html>
